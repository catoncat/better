# MES 产品化架构设计决策

> 更新时间：2026-01-20
> 用户疑问：为什么客户特定需求（锡膏管理、烘烤记录等）会做到核心 MES 里？如果卖给其他客户怎么办？

## Context

当前 schema 包含两类表：
1. **核心层**：WorkOrder, Run, Unit, Track, Route, Inspection... (通用)
2. **SMT 特定层**：BakeRecord, StencilStatusRecord, SolderPasteStatusRecord... (行业特定)

用户担忧是合理的：硬编码行业特定表会导致产品化困难。

## Decisions

### 产品定位

**用户选择：先做定制，后续产品化**

这意味着：
- 现阶段优先满足当前客户需求
- 但要预留扩展点，避免后续重构成本过高

### 核心决策

**用户选择：继续当前方式，以后产品化时再重构**

这意味着：
- ✅ 后续 WP-3 ~ WP-10 任务继续按需硬编码（如有必要）
- ✅ 不做提前的架构抽象
- ✅ 保持 `meta Json?` 字段作为扩展预留
- ⏳ 产品化时再考虑：
  - 将 schema 拆分为模块
  - 抽象 ToolLifecycleEvent / ConsumableLifecycleEvent 等通用模型
  - 在文档中标注模块边界

### 决策框架：何时硬编码 vs 配置化

```
Q1: 所有 MES 客户都需要？
    ├─ 是 → 硬编码到 Core
    └─ 否 → Q2

Q2: 有复杂关联/查询需求？
    ├─ 是 → 硬编码到 Industry Module
    └─ 否 → 用 DataCollectionSpec 配置化
```

## Plan

### 现有通用化机制（已实现）✓
- `DataCollectionSpec` + `DataValue`：通用数据采集
- `ReadinessCheck` + `ReadinessCheckItem`：通用检查项
- 所有表的 `meta Json?` 字段：扩展预留

### 当前 SMT 特定表评估

| 表名 | 类型 | 建议 |
|------|------|------|
| LoadingRecord | ✅ 核心 | 保留 (上料防错是 MES 核心能力) |
| BakeRecord | ⚠️ SMT/PCBA 特定 | 保留，文档标记为行业模块 |
| LineStencil | ⚠️ SMT 特定 | 保留，后续可抽象为 `LineToolBinding` |
| LineSolderPaste | ⚠️ SMT 特定 | 保留，后续可抽象为 `LineConsumableBinding` |
| StencilStatusRecord | ⚠️ SMT 特定 | 保留，后续可抽象为 `ToolLifecycleEvent` |
| SolderPasteStatusRecord | ⚠️ SMT 特定 | 保留，后续可抽象为 `ConsumableLifecycleEvent` |

### 推荐策略：渐进式产品化

**Phase 1 (现在) - 最小改动**
- 保持现有表结构不变
- 在文档中明确标记「SMT 行业模块」
- 优先用 DataCollectionSpec 处理纯表单类需求

**Phase 2 (产品化时) - 抽象通用模型**
- 将 StencilStatusRecord → ToolLifecycleEvent
- 将 SolderPasteStatusRecord → ConsumableLifecycleEvent
- 提供行业模板（SMT Template / DIP Template）

**Phase 3 (可选) - 模块化隔离**
- 将 schema 拆分为 core.prisma + smt.prisma + dip.prisma
- 按客户需求组合加载

## Findings

### Track F 任务实施指导

| 任务 | 做法 | 理由 |
|------|------|------|
| WP-3 锡膏生命周期 | 继续用 SolderPasteStatusRecord | 已有模型，只需扩展 |
| WP-4 刮刀寿命 | 新建表（如 SqueegeRecord）或扩展 StencilStatusRecord | 有使用次数/寿命追踪需求 |
| WP-5 转拉前检查 | 扩展 ReadinessCheckItem 模板化 | 已有框架 |
| WP-6 FAI 多签 | 扩展 Inspection.meta 或新建 Approval 模型 | 需要多方确认记录 |
| WP-7 设备点检 | 可用 DataCollectionSpec 或新建表 | 按实际复杂度决定 |
| WP-8 炉温程式 | 新建表（设备集成场景）或 DataValue | 取决于数据来源 |
| WP-10 日常 QC | 可用 DataCollectionSpec 或扩展现有报表 | 按实际复杂度决定 |

**核心原则**：
- 有复杂关联/查询需求 → 硬编码新表
- 纯表单采集 → 优先考虑 DataCollectionSpec
- 保留 `meta` 字段以备扩展

## Progress

- [x] 架构讨论完成
- [x] 用户确认：继续当前方式，产品化时再重构
- [x] 决策文档保存

## Errors

- N/A

## Open Questions

- 产品化时机：何时启动 Phase 2 抽象？（待后续评估）
- 模块边界文档：是否需要在 schema 注释中标记模块归属？

## References

- 当前 schema: `packages/db/prisma/schema/schema.prisma`
- Phase4 任务: `domain_docs/mes/plan/phase4_tasks.md`
- SMT 流程分析: `domain_docs/mes/spec/process/compair/codex_smt_flow_deep_analysis.md`
