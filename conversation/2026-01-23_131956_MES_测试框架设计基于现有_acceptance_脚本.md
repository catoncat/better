# MES 测试框架设计（基于现有 acceptance 脚本）

## Context
- 仓库现状：没有传统 `test` 脚本/测试目录，但已有可运行的“验收脚本体系”：
  - Flow runner：`apps/server/scripts/test-mes-flow.ts`（API 驱动的关键流程 + 步骤级断言）
  - Harness：`scripts/mes-acceptance.ts`（独立 DB：`acceptance.db` + deploy/seed + 起 server + 跑 flow）
  - Playbooks：`domain_docs/mes/smt_playbook/`、`domain_docs/mes/dip_playbook/`（手工流程 + validation checklist，作为规格来源）
- 用户目标：先做一个“全面、匹配现有系统与文档 SSoT”的测试框架设计；暂不落地实现测试代码。

## Decisions
- 分层策略：**Integration（API+DB，小粒度）作为 PR 必跑门槛**；**Acceptance Flow（整条业务闭环）作为夜间/回归门槛**；Unit 仅保留“规则核”少量用例（可选，但高性价比）。
- “文档=唯一真实来源”的落地方式：建立 **Specs ↔ Tests 映射**，让 playbook 的 validation 小节能追溯到自动化用例（scenario id 或测试文件），并把此映射作为 DoD 的一部分。
- 工具偏好：优先使用 **Bun 原生测试（bun:test）**，减少依赖面；后续若需要 UI E2E 再引入 Playwright。

## Plan
- Phase 0（设计确认）：确定测试分层/命名/入口命令/CI job 结构与“映射表”的形式。
- Phase 1（框架骨架）：补测试目录与 helpers（测试 DB 管理、server 启动、API client、seed 策略），不急于写大量用例。
- Phase 2（首批用例）：从 playbook 抽 3-5 条关键验证点，分配到 Integration 与 Acceptance；用 JSON 输出/失败定位能力做门槛。
- Phase 3（覆盖扩展）：按风险主题补边界（非法状态、越权、并发/幂等、追溯不变量），并建立 nightly matrix。

## Findings
### 1) 测试分层（适配 MES 的“现实最优”）
#### A. Integration（API + DB，小粒度，PR 必跑）
- 定位：验证“一个能力点/一个不变量”在真实 DB 约束下成立。
- 覆盖主题（高优先级）：
  1) 状态机非法流转（例如 PREP 未通过 readiness/FAI 就 authorize → 必须稳定失败且错误码正确）
  2) 权限隔离（角色/站点/工厂；列表与详情都要拒绝越权）
  3) 幂等（重复请求不会重复落库/不会改变最终状态）
  4) 事务一致性（失败时无脏写；审计/traceId 仍可定位）
  5) 契约稳定性（`error.code`、关键字段结构）
- 特点：快、定位准、flake 少；适合 PR gate。

#### B. Acceptance Flow（整条闭环，夜间/回归门槛）
- 定位：验证“跨模块串联”的业务闭环能跑通，并符合 playbook 的关键验证项。
- 来源：你们现有 `test-mes-flow.ts` 就是这个层。
- 建议范围：仅保留 3–8 条“最关键闭环”场景（SMT/DIP 各 1–3 + 异常 1–2）。
- 特点：慢、依赖 seed/环境、维护成本高；适合 nightly 与发布前回归。

#### C. Unit（纯逻辑，少而精，可选）
- 定位：锁住“规则核”的边界条件；让规则改动能在秒级定位。
- 只测纯函数/不碰 DB：状态转移判定、路由选择、追溯摘要计算、readiness gate 规则等。

### 2) 目录结构与脚本入口（建议）
（最终实现可微调，但建议在 repo 内形成稳定的入口约定）
- `apps/server/tests/unit/**`：bun:test
- `apps/server/tests/integration/**`：bun:test（API+DB，小粒度）
- `apps/server/tests/helpers/**`：test DB、server、api client、seed helpers
- `apps/server/tests/fixtures/**`：最小 seed/数据集（可选）
- `apps/server/scripts/test-mes-flow.ts`：保留为 Acceptance Flow runner（继续支持 `--track/--scenario/--dataset/--id-strategy`）
- `scripts/mes-acceptance.ts`：保留为 Acceptance harness（CI/夜间入口）

推荐命令（根 `package.json`）：
- `bun run test:unit`
- `bun run test:integration`
- `bun run test:acceptance`（= `bun run mes:acceptance`）
- `bun run test`（PR 默认跑 unit+integration；acceptance 由 CI job 决定）

### 3) 测试 DB 与 seed 策略（决定稳定性与速度）
#### 核心原则：每次测试必须可重复且互不污染
- Integration：
  - 每个 test 文件/用例使用独立 sqlite 文件（临时路径），或基于“模板 DB”复制一份（更快）。
  - 每次 suite 自动 `db:deploy`（或复用模板 DB 的 deploy 结果）。
  - seed 分两种：`minimal seed`（仅用户/角色/基础线体/基础路由）与 `full seed`（演示数据），Integration 优先 minimal。
- Acceptance：
  - 继续使用独立 `acceptance.db`（已具备），但建议支持 `--db file:...`（现有已支持）并在 nightly 用 runId 生成不同 db，避免并发冲突。

### 4) Server 可测试化（Integration 的关键）
当前 `apps/server/src/index.ts` 在模块加载时就 `listen()`，这对 in-process integration test 不友好。
- 建议重构为：
  - `createApi()`：返回 Elysia api（prefix `/api`，包含 plugins/modules）
  - `createApp()`：返回包含 web catch-all 的 app
  - `startServer()`：仅在 CLI 入口调用 listen
- Integration tests 可直接用 `api.handle(new Request(...))` 发请求（无需起真实端口），同时保留通过 cookie 的真实 auth 流程。

### 5) Acceptance Flow 的“框架化改造点”
你们已有的 `FlowSummary/StepResult` 非常适合做稳定输出，建议补齐：
- **矩阵运行器**：`track × scenario` 批量跑，失败聚合输出（夜间 job）。
- **输出规范**：JSON（已支持 `--json`）+ 可选 junit（CI 可视化）；失败时保存 JSON artifact。
- **更稳的 server 启动**：`scripts/mes-acceptance.ts` 里现在用 `bun run --filter server dev`（`--hot`），CI 建议提供一个不热更新的启动命令（例如 `bun run --filter server start:test`）。

### 6) 文档（SSoT）对齐：Specs ↔ Tests 映射
建议新增一个映射文件（或在 playbook 里加固定段落），例如：
- `domain_docs/mes/tests/02_playbook_to_tests_map.md`
内容结构：
- Playbook 小节（例如 SMT `05_validation/01_loading_validation.md` 的某条验证点）
  - 自动化：Acceptance scenario id（例如 `test-mes-flow.ts --track smt --scenario readiness-waive`）
  - 自动化：Integration test 文件（例如 `apps/server/tests/integration/readiness.test.ts`）
  - 断言点：关键错误码/状态/trace 字段
这样可以保证“文档变更→必须更新对应测试/映射”。

### 7) CI 运行策略（建议默认）
- PR（必跑）：`lint` + `check-types` + `test:unit` + `test:integration`
- PR（可选或只跑 1 条 smoke）：`test:acceptance --track smt --scenario happy`
- Nightly（必跑）：Acceptance matrix（SMT/DIP × 关键 scenarios）
- Release 前：跑 nightly 子集 + DB migrate 回归（若有 schema 变更）

## Progress
- 已完成测试框架设计草案（本文件）。

## Errors
- 无

## Open Questions
- PR 上的 Acceptance：你们希望 “0 条（只夜间）/ 1 条 smoke / 全量” 哪种？（推荐：1 条 smoke）
- Integration 的 server 启动偏好：接受对 server 做一次 “createApi/createApp/startServer” 拆分吗？（推荐：接受，这是稳定与速度的关键）
- seed 分层：现有 `db:seed` 是否要扩展为 `--mode minimal|full`？还是新增 `db:seed:minimal` 脚本？（推荐：新增 minimal 入口，避免破坏现有 demo seed）

## References
- `apps/server/scripts/test-mes-flow.ts`
- `scripts/mes-acceptance.ts`
- `domain_docs/mes/tests/01_acceptance_scenarios.md`
- `domain_docs/mes/smt_playbook/`
- `domain_docs/mes/dip_playbook/`
