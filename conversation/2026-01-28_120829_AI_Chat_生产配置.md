# AI Chat 生产配置

## Context
- 用户要求让 AI Chat 在 Fly 生产可用，Fly 部署为单文件二进制 + /db SQLite 挂载。
- 生产镜像默认不包含源码/文档，现有工具需要可检索的仓库快照。

## Decisions
- 生产镜像内新增 /app/repo 快照，运行时通过 CHAT_REPO_ROOT 指向该目录。
- 仅在 CHAT_TOOLS_ENABLED=true 且配置了 CHAT_REPO_ROOT 时启用 tools；避免生产无快照时误导体验。

## Plan
- 确认 .dockerignore 不排除 agent_docs/domain_docs，并排除 .scratch。
- Dockerfile 构建阶段复制 docs/src/packages 到 /app/repo。
- fly.toml 设置 CHAT_REPO_ROOT=/app/repo。
- tools.ts 优先用 CHAT_REPO_ROOT 作为根目录，兼容单文件二进制。
- 更新 .env.example 与运维文档说明。

## Findings
- fly.toml 已设置 NODE_ENV=production 与 CHAT_REPO_ROOT=/app/repo。
- Dockerfile 已在生产镜像复制 agent_docs/domain_docs/user_docs/apps/*/src/packages 到 /app/repo。
- tools.ts 已使用 CHAT_REPO_ROOT 作为根目录；service.ts 生产需 CHAT_REPO_ROOT 才启用 tools。
- .dockerignore 排除了 .scratch 与 conversation/worktree_notes，未排除 agent_docs/domain_docs。

## Progress
- 已收集当前变更与配置现状，待确认继续在当前分支/工作区提交。

## Errors
- 无。

## Open Questions
- 当前工作区已有未提交变更；是否直接在当前分支继续并提交，或切换到新 worktree？

## References
- fly.toml
- Dockerfile
- apps/server/src/modules/chat/tools.ts
- apps/server/src/modules/chat/service.ts
- apps/server/.env.example
- agent_docs/05_ops/single_binary_deployment.md
