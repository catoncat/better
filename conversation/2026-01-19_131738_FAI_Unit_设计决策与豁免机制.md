# FAI、Unit 生成与豁免机制设计决策

> 日期：2026-01-19
> 背景：SMT 端到端验收过程中，讨论 FAI（首件检验）与 Unit 生成的关系

---

## Context

在验收阶段 4（FAI 首件检验）时，用户发现：
1. 创建 FAI 需要填写 sampleQty（如 2）
2. FAI 开始后需要做试产 TrackIn/TrackOut
3. TrackIn 需要 Unit 存在，但 FAI 创建时没有自动生成 Unit
4. 用户质疑：FAI 的 Unit 应该独立生成还是复用生产 Unit？

由此引发关于 FAI 与 Unit 关系、FAI 触发条件、FAI 豁免机制的讨论。

---

## Decisions

### 1. FAI 与 Unit 的关系

**决策：采用共享 Unit 池（FAI 复用生产 Unit）**

```
创建批次 (planQty=4)
    ↓
生成 Unit (4个)
    ↓
创建 FAI (sampleQty=2)
    ↓
FAI 试产：使用前 2 个 Unit 在第一工序 TrackIn/TrackOut
    ↓
FAI 判定通过
    ↓
Run 授权
    ↓
正式生产：
  - 前 2 个 Unit 从 step 2 继续
  - 后 2 个 Unit 从 step 1 开始
    ↓
全部 4 个 Unit 完工（产量 = planQty）
```

**关键约束（已实现）**：
- FAI 试产只允许在**第一工序**（`FAI_TRIAL_STEP_NOT_ALLOWED`）
- FAI 试产有 **sampleQty 限制**（`FAI_TRIAL_LIMIT_REACHED`）
- 试产 Unit 停留在第一工序，等待 Run 授权后继续

**代码位置**：`apps/server/src/modules/mes/execution/service.ts:334-356`

**决策依据**：
- 首件 = 第一工序检验，不是全程试产
- 试产合格的 Unit 继续参与生产，是正式产品
- PCB 成本高，合格品不应浪费
- 追溯需要 SN 连续

### 2. FAI 样品是否计入产量

**决策：计入产量**

| 场景 | 处理方式 |
|------|----------|
| planQty=4, sampleQty=2 | 最终产出 4 个（含首件 2 个） |

**决策依据**：
- 首件检验通过 = 产品合格，正常交付
- 无留样、破坏性测试需求

**替代方案（未采用）**：
- 如需留样/送检/破坏性测试，需改为：planQty=4 + sampleQty=2 额外

### 3. FAI 触发条件

**决策：路由级配置，每批次都需要 FAI**

- 触发条件：路由步骤配置 `requiresFAI = true`
- 检查时机：Run 授权时调用 `checkFaiGate()`
- 当前模式：最严格（每批都做）

**代码位置**：`apps/server/src/modules/mes/fai/service.ts:470-532`

**替代方案（可扩展）**：

| 方案 | 描述 | 适用场景 |
|------|------|----------|
| 每批次（当前） | 所有批次都做 | 高可靠性产品、新产品导入 |
| 条件触发 | 换线/换班/换料/停机后触发 | 成熟产品批量生产 |
| 按需手动 | 用户自行决定 | 灵活场景 |

### 4. FAI 豁免机制

**决策：仅 MRB 返修流程可豁免**

| 场景 | 可豁免？ | 条件 |
|------|---------|------|
| 正常首批生产 | ❌ | 必须做 FAI |
| OQC 不合格 → MRB 返修 → 复用就绪 | ✅ | `authorizationType=MRB_OVERRIDE` + `mrbFaiWaiver=true` |
| OQC 不合格 → MRB 返修 → 完整准备 | ❌ | 需要重新验证 |

**豁免入口**：MRB 决策对话框（批次详情页，Run 状态为 ON_HOLD 时显示）

**代码位置**：
- 豁免检查：`apps/server/src/modules/mes/fai/service.ts:508-513`
- MRB 决策：`apps/web/src/routes/_authenticated/mes/-components/mrb-decision-dialog.tsx`

---

## Plan

继续推进 SMT 端到端验收：

- [x] 阶段 1：工单发布、批次创建
- [x] 阶段 2：就绪检查通过 (6项全通过)
- [x] 阶段 3：站位表加载、扫码验证
- [ ] 阶段 4：首件检验 (FAI) ← 当前
- [ ] 阶段 5-7：批次授权、批量执行、质量闭环

**下一步操作**：
1. 去批次详情页生成 Unit（按 planQty 或至少 sampleQty）
2. 回到 FAI 页面进行试产 TrackIn/TrackOut
3. 记录 FAI 检验项
4. 完成 FAI 判定
5. 继续阶段 5：Run 授权

---

## Findings

### 已识别的 UX 问题（待修复）

| # | 问题 | 修复建议 | 优先级 |
|---|------|----------|--------|
| 5.2.2 | **BUG**: FAI 可跳过试产直接完成判定 | `completeFai` 应检查是否已有试产记录 | **P0** |
| 5.2.3 | FAI 开始时无提示生成 Unit | `startFai` 应检查 Unit 是否存在，若无则提示 | P1 |
| 5.2.4 | FAI sampleQty 与 Unit 生成脱节 | `createFai` 应检查 Unit ≥ sampleQty | P1 |

**已记录位置**：`domain_docs/mes/plan/tasks.md` 第 5.2 节

---

## Progress

- 2026-01-19：完成 FAI/Unit/豁免设计讨论，确定采用方案

---

## Errors

无

---

## Open Questions

1. **后续是否需要条件触发 FAI？**（如换线/换班时触发，而非每批次）
   - 当前采用最严格模式
   - 可根据业务需求扩展

2. **是否需要支持 FAI 留样/破坏性测试场景？**
   - 当前假设 FAI 样品计入产量
   - 如有需求，需调整 Unit 生成逻辑

---

## References

- 流程规范：`domain_docs/mes/spec/process/03_smt_flows.md`
- FAI 服务：`apps/server/src/modules/mes/fai/service.ts`
- 执行服务：`apps/server/src/modules/mes/execution/service.ts`
- MRB 服务：`apps/server/src/modules/mes/oqc/mrb-service.ts`
- 问题追踪：`domain_docs/mes/plan/tasks.md`
