# track-b-review

## Context
- Reviewing Track B (FAI signature enforcement) implementation status and gaps.

## Decisions
- Track B should remain single-signature; update docs and code to align.

## Plan
- None (review only).

## Findings
- Single-signature fields and gate are implemented, but Track B theme mentions multi-signature; no multi-sign support in schema/service.
- T1.5 requirement to update Readiness on FAI sign is not implemented; sign flow only updates Inspection.
- Test script still expects authorize to pass after FAI PASS without signature, which will fail under new gate.
- signFai accepts empty signedBy if user is missing (route passes user?.id ?? ""), risking "signed" records without signer.
- Track B plan checkboxes remain unchecked despite implementation, violating doc alignment.
- Existing worktree note `worktree_notes/feat_fai-signature.md` documents single-sign implementation slices and commits; no readiness update.
- Plan file `domain_docs/mes/plan/smt_gap_task_breakdown.md` already marks T1.4/T1.5 as done and claims readiness update via `checkFaiGate`, which is misleading.
- FAI multi-sign references still exist in `domain_docs/mes/plan/phase4_tasks.md`, `domain_docs/mes/spec/architecture/01_product_abstraction.md`, and `domain_docs/mes/spec/process/compair/codex_smt_flow_deep_analysis.md`.
- `apps/server/scripts/test-mes-flow.ts` authorizes after FAI PASS without signing in two scenarios; needs sign step.
- `apps/server/scripts/smt-demo-dataset.ts` authorizes immediately after FAI complete without signing.
- `apps/server/scripts/mes-flow-test/index.ts` also authorizes after FAI complete without signing.
- `domain_docs/mes/spec/architecture/01_product_abstraction.md` frames WP-6 as FAI multi-sign.
- Docs/scripts to update for single-sign alignment: `domain_docs/mes/plan/smt_gap_task_breakdown.md`, `domain_docs/mes/plan/phase4_tasks.md`, `domain_docs/mes/spec/architecture/01_product_abstraction.md`, `domain_docs/mes/spec/process/compair/codex_smt_flow_deep_analysis.md`, `apps/server/scripts/test-mes-flow.ts`, `apps/server/scripts/smt-demo-dataset.ts`, `apps/server/scripts/mes-flow-test/index.ts`, plus FAI sign route guard.
- Historical note `conversation/2026-01-20_094100_MES产品化架构决策.md` still references FAI multi-sign; keep as record, but new decision supersedes it.

## Progress
- Updated Track B docs to single-sign language; removed multi-sign references.
- Added FAI sign guard in routes and added sign steps to MES scripts.

## Errors
- `rg -nP "\\p{Extended_Pictographic}" domain_docs/mes` reports existing ☐ checkboxes under `domain_docs/mes/dip_playbook/05_validation/*` (pre-existing, not modified in this change).

## Open Questions
- Is the requirement still multi-signature (e.g., QA + ENG)? If yes, we need to extend schema/API/UI beyond the single signedBy/signedAt fields.

## References
- packages/db/prisma/schema/schema.prisma
- apps/server/src/modules/mes/fai/service.ts
- apps/server/src/modules/mes/run/service.ts
- apps/server/scripts/test-mes-flow.ts
- domain_docs/mes/plan/smt_gap_task_breakdown.md
