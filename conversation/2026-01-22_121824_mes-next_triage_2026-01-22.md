# MES Next Triage - 2026-01-22

## Context

- **Current branch**: main (ahead of origin, unpushed)
- **Git status**: Dirty - doc changes + lockfile
- **Milestone status**: M1-M3 DONE, M4 (Ingest & Automation) in draft/planning

## Worktree Scan

| Path | Branch | Status | Touch Points |
|------|--------|--------|--------------|
| /Users/envvar/lzb/better (current) | main | ahead, dirty | docs, bun.lock |
| /Users/envvar/lzb/better-wt-smt-basic | smt-basic-wp4-10 | ahead 14, behind 94 | db.prisma, db.schema, domain_docs, server, web, worktree_notes |

**In-flight**: `smt-basic-wp4-10` is touching db.prisma, server MES modules, and web routes - avoid parallel schema/execution changes.

## Current Priority (from CONTEXT.md)

> Acceptance is currently paused; SMT Gap execution is the primary track.

**Acceptance plans (paused)**:
- SMT: `user_docs/demo/acceptance_plan.md`
- DIP: `user_docs/demo/acceptance_plan_dip.md`
- Issues: `user_docs/demo/acceptance_issues.md` (empty)

## Task Sources

- **Phase 4 Tasks** (`domain_docs/mes/plan/phase4_tasks.md`) as reference only:
  - Track A: M4 Planning & Contract (4.1.1-4.1.3) - [ ] pending
  - Track B: Ingest Event Foundation (4.2.1-4.2.4) - [ ] pending
  - Track C: AUTO/TEST Execution via ingestMapping (4.3.1-4.3.4) - [ ] pending
  - Track D: Readiness Config UX/API (4.4.1-4.4.2) - [ ] pending
  - Track E: Outbound Feedback (TBD) - [ ] pending
  - Track F: SMT Traceability & Compliance Hardening - mixed (4.6.3 bake [x], 4.6.4 solder [x], 4.6.10 replace [x], rest [ ])
  - Track G: Line Management - [x] done

- **SMT Gap Tasks** (`domain_docs/mes/plan/smt_gap_task_breakdown.md`) as the primary execution plan:
  - Config system for prep/time-window rules
  - Soft-gate engine with alert/waiver
  - Form-level data capture enhancements

## Tracks (Parallelizable)

### Track A: UI Acceptance Validation (Paused)
- **Theme**: Full-flow UI acceptance is paused; keep the plan for later resumption.

### Track B: SMT Compliance Hardening (Phase 4 Track F)
- **Theme**: Close SMT traceability and compliance gaps per gap analysis (align with SMT Gap plan to avoid duplication)
- **Candidates**:
  - **4.6.1 Front Confirmation**: Confirm form fields, time-window events, data sources; depends on none; touch points: domain_docs only (no code)
  - **4.6.2 Time-Window Rules (WP-1)**: Configurable time limits with alert + waiver; depends on 4.6.1 confirmation; touch points: db.prisma, server services, readiness, execution
  - **4.6.3.1 Bake Record Linkage**: Wire bake record to readiness/rules; depends on 4.6.3 (done); touch points: readiness service, bake module

### Track C: M4 Contract & Ingest Foundation (Phase 4 Track A/B)
- **Theme**: Define ingest event contract and build persistence layer
- **Candidates**:
  - **4.1.1 IngestEvent Contract**: Define fields, idempotency key, payload constraints; depends on none; touch points: domain_docs/spec only
  - **4.2.1 IngestEvent Schema**: Add Prisma model + indexes; depends on 4.1.1; touch points: db.prisma (CONFLICT with smt-basic worktree)

### Track D: Config System (SMT Gap Phase 1)
- **Theme**: Build config template system for prep/time-window rules
- **Candidates**:
  - **Config Spec Finalization**: Completed (templates + samples + override schema)
  - **Config API/Storage**: Implement config storage and API; depends on spec finalization; touch points: db.prisma, server modules

## Conflicts

- **Track B (4.6.2/4.6.3.1)** blocks **Track C (4.2.1)** only
- **Track C (4.2.1)** blocks **smt-basic-wp4-10 worktree**: Both modify db.prisma
- **Track D (Config API)** blocks **Track C (4.2.1)**: Both touch db.prisma

## Recommendation

Given the current state:
1. Acceptance is paused; prioritize SMT Gap execution
2. `smt-basic-wp4-10` provides record-layer CRUD/UI; merge it first, then run Gap Phase 1 (Readiness + waive)
3. Avoid schema-touching work in parallel with `smt-basic-wp4-10`

**Suggested priority order**:
1. Merge `smt-basic-wp4-10`
2. Start SMT Gap Phase 1 Track A (Readiness expansion + waive + prep board)
3. Defer schema-heavy M4 tasks until conflicts clear

---

## Selection

(To be filled after user picks)
