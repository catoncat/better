## Context

- Demo feedback: `user_docs/demo/guide.md` did not walk through the full flows in:
  - `domain_docs/mes/spec/process/01_end_to_end_flows.md`
  - `domain_docs/mes/spec/process/03_smt_flows.md` (SMT)
  - `domain_docs/mes/spec/process/04_dip_flows.md` (DIP)
- Gap found: SMT spec requires “FAI trial production before Run authorization”, but the server previously blocked execution unless `Run=AUTHORIZED|IN_PROGRESS`.

## Decisions

- **Add FAI trial execution mode**:
  - Allow `TrackIn/TrackOut` while `Run=PREP` only when there is an active FAI in `INSPECTING` status.
  - Require readiness to pass (via `readiness.canAuthorize`), otherwise block trial.
  - Limit trial to **first routing step only** to avoid “full production before authorization”.
  - Enforce trial unit count by `FAI.sampleQty` (distinct units since `FAI.startedAt`).
- **Improve demo UX**:
  - Add Run authorization action to Run detail page (`/mes/runs/{runNo}`) so the demo can be executed linearly.
- **Update demo guide**:
  - Rewrite the guide as an end-to-end SMT walkthrough (Readiness → Loading → FAI trial → Authorize → Execute → Closeout → OQC/MRB → Trace).

## Plan

1. Add plan items to M3 (`domain_docs/mes/plan/phase3_tasks.md`).
2. Implement server-side FAI trial gating in execution service.
3. Add Run detail authorize UI.
4. Rewrite `user_docs/demo/guide.md` to match the process specs.
5. Verify with `bun run check-types` and `bun run lint`.

## Open Questions

- DIP “full guide” is still pending in the M3 plan (SMT guide + failure branches are done).

## References

- Server: `apps/server/src/modules/mes/execution/service.ts`
- Web: `apps/web/src/routes/_authenticated/mes/runs/$runNo.tsx`
- Demo guide: `user_docs/demo/guide.md`
- M3 plan: `domain_docs/mes/plan/phase3_tasks.md`
- Acceptance script (updated to exercise FAI trial): `apps/server/scripts/test-mes-flow.ts`
