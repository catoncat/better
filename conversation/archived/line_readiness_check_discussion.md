# Line Readiness Check 需求讨论

> 状态：**已完成** - 所有决策已确认，可进入设计阶段
> 创建时间：2024-12-29
> 更新时间：2024-12-29
> 相关功能：M2 - Quality Control and Authorization

---

## 1. 功能定位

**Line Readiness Check（生产线准备检查）** 是生产授权流程的第一道门禁。

在端到端流程中的位置：
```
Run 创建 (PREP) → [Line Readiness Check] → FAI 首件检验 → 批量授权 (AUTHORIZED) → 正式生产
```

**核心目的**：确保在开始生产前，所有必要的生产条件都已就绪，防止因条件不满足导致的质量问题、设备损坏或安全事故。

---

## 2. 行业背景知识

### 2.1 5M1E 框架

这是制造业广泛使用的生产要素管理框架，源自质量管理和根因分析（鱼骨图）：

| 要素 | 英文 | 含义 | 检查示例 |
|------|------|------|----------|
| **人** | Man | 操作人员 | 操作员是否持有该工序的上岗证？是否在有效期内？ |
| **机** | Machine | 设备/工装 | 设备是否正常运行？是否已做点检？校准是否有效？ |
| **料** | Material | 物料/原材料 | BOM 物料是否已领料到产线？批次是否正确？ |
| **法** | Method | 工艺/方法 | SOP/作业指导书是否就位？版本是否最新？ |
| **测** | Measurement | 测量/检测 | 检测设备是否校准？量具是否可用？ |
| **环** | Environment | 环境 | 温湿度是否达标？洁净度是否符合要求？ |

### 2.2 Line Clearance 行业实践

**Line Clearance（生产线清场）** 是制造业和 GMP 行业的常见实践，包括：
1. 确认上一批次产品已完全清除（防止混料）
2. 验证设备已清洁/归位
3. 核对新批次的物料和标签

> 注：ISA-95 (IEC 62264) 标准主要定义企业-控制系统集成的数据模型，Line Clearance 更多是 GMP/行业最佳实践而非 ISA-95 的核心概念。

### 2.3 制药行业的实践（最严格的参考）

制药行业（GMP）对 Line Clearance 有强制性要求：
- 电子化检查清单（21 CFR Part 11 合规）
- 每个检查项需要电子签名
- 完整的审计追踪
- 检查不通过必须有偏差处理流程

### 2.4 我们系统的现有数据基础

根据 `domain_docs/mes/spec/integration/01_system_integrations.md`，我们已经有：

| 检查项 | 数据来源 | 现有表/模型 |
|--------|----------|-------------|
| 设备状态 | TPM 系统同步 | `TpmEquipment`, `TpmStatusLog` |
| 设备维护状态 | TPM 系统同步 | `TpmMaintenanceTask` |
| 物料/BOM | ERP 系统同步 | `Material`, `Bom` |
| 工艺路线 | ERP 系统同步 | `Routing`, `RoutingStep`, `ExecutableRouteVersion` |

**当前限制 - 尚未建立的数据**：
- 人员资质/上岗证
- 物料领料/在线状态（需要 WMS 集成）
- 环境监控数据

---

## 3. 决策记录

### 3.1 已确认决策

| 问题 | 决策 | 日期 | 备注 |
|------|------|------|------|
| 检查项范围 | **核心集** | 2024-12-29 | 见下方详细定义 |
| 触发时机 | **两阶段**（预检 + 正式检查） | 2024-12-29 | 见待澄清问题 1 |
| 不通过处理 | **软阻断 + 豁免** | 2024-12-29 | 见待澄清问题 2 |
| 信息模型 | **基础 + 豁免** | 2024-12-29 | 见下方详细定义 |
| UI 范围 | **全部 4 个页面** | 2024-12-29 | Run详情增强 + 检查执行页 + 异常看板 + 配置页 |

### 3.2 核心集检查项定义

由于缺少领料数据（需要 WMS 集成），当前"核心集"定义如下：

| 检查项 | 检查内容 | 数据来源 | 检查逻辑 |
|--------|----------|----------|----------|
| **设备状态** | 设备是否可用 | `TpmEquipment`, `TpmStatusLog`, `TpmMaintenanceTask` | Run 关联工位的设备状态为"正常"，无未完成的阻断性维保任务 |
| **物料主数据** | BOM 物料是否有效 | `Material`, `Bom` | 工单产品的 BOM 存在，且所有 BOM 物料在 Material 表中有有效记录 |
| **工艺路线** | 可执行路由是否就绪 | `ExecutableRouteVersion` | Run 已绑定状态为 `READY` 的可执行路由版本 |

**注意**：当前不检查物料是否已领料到产线（需要 WMS 集成后扩展）。

---

## 4. 补充决策

### 问题 A：两阶段检查的状态模型（已确认）

| 子问题 | 决策 | 说明 |
|--------|------|------|
| Run 中如何表示检查状态 | **关联记录** | 状态完全由 ReadinessCheck 记录表示，Run 不冗余存储 |
| 重新检查触发条件 | **混合模式** | 预检可自动触发（TPM/路由变更），正式检查仅手动 |
| 预检 vs 正式检查差异 | 预检仅提示，正式检查阻断 | 预检异步提醒，正式检查同步阻断 |

---

### 问题 B：豁免的权限与审计（已确认）

| 子问题 | 决策 | 说明 |
|--------|------|------|
| 谁可以豁免 | **统一权限** | `mes:readiness:override` 权限，通过角色分配 |
| 豁免记录内容 | **最小** | 豁免人 + 豁免原因 + 时间 |
| 是否需要审批流 | **不需要** | 有权限的人直接豁免，无需上级审批 |

---

## 5. 下一步

1. ~~核心需求讨论~~ ✓
2. ~~澄清问题 A 和 B~~ ✓
3. 更新 `domain_docs/mes/spec/process/` 添加 Line Readiness 规范
4. 设计数据模型和 API
5. 创建实现任务清单

---

## 参考资料

- [MESA International - MES Best Practices](https://mesa.org)
- 5M1E 质量管理框架
- GMP / 21 CFR Part 11 电子记录要求
- 现有集成规范：`domain_docs/mes/spec/integration/01_system_integrations.md`
