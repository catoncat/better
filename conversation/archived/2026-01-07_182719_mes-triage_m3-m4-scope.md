# mes-triage_m3-m4-scope

## Context
- Question: current as-built already covers SMT/DIP core flow; should M3/M4 be re-scoped to “go-live readiness” vs advanced ingest/features?
- Read: `domain_docs/mes/spec/impl_align/*`, `domain_docs/mes/plan/*`, `apps/server/src/modules/mes/trace/*`, `domain_docs/mes/tests/01_acceptance_scenarios.md`.
- Observation: impl_align maps the core nodes; trace API includes route+frozen version, tracks, dataValues, defects, materials.
- Observation: docs drift exists (plan milestone/status and acceptance doc mention some APIs not present in code).

## Decisions
- Pending: confirm whether M3 should be narrowed to go-live readiness (E2E demo/UX/real-data validation) and defer M4 ingest/batch.

## Plan
- Worktree Scan
  - Current: `/Users/envvar/lzb/better-m3-trace` (branch `m3-trace`)
  - In-flight worktrees: none

- Track A: 上线准备（门禁/体验/验收）
  - Candidates:
    - Readiness 配置最小化: unblock production rollout for different lines; depends on current readiness gate design; touch points `domain_docs/mes/plan/tasks.md.md`, `apps/server/src/modules/mes/readiness/*`, `apps/web/src/routes/_authenticated/mes/runs/$runNo.tsx`
    - E2E 验收清单化: ensure “can really run” beyond impl_align mapping; depends on seed + demo flow; touch points `domain_docs/mes/tests/01_acceptance_scenarios.md`, `apps/server/scripts/seed.ts`

- Track B: 计划/文档对齐（避免误判）
  - Candidates:
    - 修正 docs drift: align milestones/phase2 snapshot/acceptance APIs to as-built; depends on none; touch points `domain_docs/mes/plan/01_milestones.md`, `domain_docs/mes/plan/tasks.md.md`, `domain_docs/mes/tests/01_acceptance_scenarios.md`

- Track C: M3/M4 功能扩展（按需）
  - Candidates:
    - DataCollectionSpec 管理 + 采集配置 UX: replace “手输 dataSpecIds”; depends on routing config model; touch points `packages/db/prisma/schema/schema.prisma`, `apps/server/src/modules/mes/routing/*`, `apps/web/src/routes/_authenticated/mes/routes/$routingCode.tsx`
    - M4 Ingest baseline: auto/batch/test events ingestion; depends on external producers; touch points `apps/server/src/modules/mes/integration/*`, `apps/server/src/modules/mes/execution/service.ts`

- Conflicts:
  - Track C likely blocks other DB/schema work: touches `packages/db/prisma/schema/schema.prisma` + migrations.

- Pick one track/candidate; I will confirm scope and start plan-first implementation.

## Open Questions
- 上线 MVP 的边界：只支持人工 TrackIn/Out 是否 OK？SPI/AOI 是否必须自动接入？
- 是否必须提供 DataCollectionSpec 的 CRUD+UI，还是先用 seed/手填 ID？
- M3/M4 是否需要在 `domain_docs/mes/plan/01_milestones.md` 里重写定义（以“上线准备”为目标）？

## References
- `domain_docs/mes/spec/impl_align/03_smt_align.md`
- `domain_docs/mes/spec/impl_align/04_dip_align.md`
- `domain_docs/mes/plan/01_milestones.md`
- `domain_docs/mes/plan/tasks.md.md`
- `domain_docs/mes/tests/01_acceptance_scenarios.md`
- `apps/server/src/modules/mes/trace/routes.ts`
- `apps/server/src/modules/mes/trace/service.ts`
