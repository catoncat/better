# 3.5.2 DataCollectionSpec 管理页面 — 实施计划

> **日期**：2026-01-12
> **状态**：待用户确认
> **上下文**：M3 Track E 数据采集配置

---

## 1. 背景与目标

### 1.1 业务背景

DataCollectionSpec（采集项规格）定义了在生产执行过程中需要采集哪些数据：

- **绑定维度**：按 Operation（工序）定义采集项
- **使用时机**：通过 RouteExecutionConfig.dataSpecIds 绑定到路由/工序步骤
- **运行时快照**：编译进 ExecutableRouteVersion.snapshotJson，Run 创建时冻结

### 1.2 任务目标

工艺工程师可以自助管理采集项规格，不再依赖手工 seed 或手输 ID。

---

## 2. 访谈决策摘要

| 决策项 | 选择 | 备注 |
|--------|------|------|
| 数据建模 | 软删除 + 警告 | 编辑已有 DataValue 的 spec 时显示警告 |
| spec/alarm UI | 动态表单 | 根据 dataType 切换输入项 |
| 列表分组 | 按 Operation 分组 | 支持展开/折叠 |
| 表单预览 | 实时预览 | 对话框内嵌预览区 |
| 权限模型 | 三级（READ/CONFIG/TOGGLE） | 已在 3.5.1 完成 |
| 标签风格 | 专业术语 + 提示气泡 | tooltip 解释 |
| spec 结构 | 统一模式 | `{ min?, max?, unit?, target?, lsl?, usl? }` |
| Operation 选择器 | 显示全部 + 允许新增 | **需新增 Operation CRUD API** |
| 父子工序 | 延后 | 不在本次实现 |
| 批量操作 | 启用/停用、复制、导入/导出 | JSON 格式 |
| 错误处理 | 表单内联错误 | 后端错误码映射 |
| 移动端 | 双视图（Table + Card） | 遵循 data_list_pattern.md |

---

## 3. 前置依赖

### 3.5.1.5 Operation CRUD API（新增子任务）

由于访谈确认允许用户在选择 Operation 时创建新的 MES-Native Operation，需要先补充 Operation 管理能力：

| 子任务 | 内容 | DoD |
|--------|------|-----|
| 3.5.1.5.1 | Server: Operation list API（分页/筛选） | 可按 code/name/source 筛选 |
| 3.5.1.5.2 | Server: Operation create/update API | 仅允许 MES-Native，source='MES' |
| 3.5.1.5.3 | RBAC/Audit | 权限 + 审计事件 |

**估计**：约 1-2 小时（参考 data-collection-spec 模块结构）

---

## 4. 实施切片（Slices）

> 按 small-step-commits 原则拆分，每个切片完成后立即 commit。

### Slice 1: Operation 基础 API（前置）

**目标**：补齐 Operation 列表 + 创建能力

| # | 文件 | 变更 |
|---|------|------|
| 1.1 | `apps/server/src/modules/mes/operation/schema.ts` | 新增 list/create/update schemas |
| 1.2 | `apps/server/src/modules/mes/operation/service.ts` | list/create/update services |
| 1.3 | `apps/server/src/modules/mes/operation/routes.ts` | API routes |
| 1.4 | `apps/server/src/modules/mes/routes.ts` | mount module |
| 1.5 | `packages/db/src/permissions/permissions.ts` | 新增 OPERATION_READ/CONFIG |
| 1.6 | `packages/db/src/permissions/preset-roles.ts` | engineer 角色包含权限 |

**Commit**：`feat(mes): add Operation list/create API`

---

### Slice 2: 列表页骨架

**目标**：列表页基本结构（空状态 + 加载 + 分页）

| # | 文件 | 变更 |
|---|------|------|
| 2.1 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/index.tsx` | 新增路由 + DataListLayout 骨架 |
| 2.2 | `apps/web/src/hooks/use-data-collection-specs.ts` | Eden query hook |
| 2.3 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/columns.tsx` | 表格列定义 + 字段元数据 |
| 2.4 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/card.tsx` | 卡片视图 |

**Commit**：`feat(web): add DataCollectionSpec list page skeleton`

---

### Slice 3: 筛选与分组

**目标**：FilterToolbar + 按 Operation 分组视图

| # | 文件 | 变更 |
|---|------|------|
| 3.1 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/index.tsx` | FilterToolbar + QueryPresetBar |
| 3.2 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/grouped-view.tsx` | 分组展开/折叠 UI |
| 3.3 | `apps/web/src/hooks/use-data-collection-specs.ts` | 支持 operationCode 筛选 |

**Commit**：`feat(web): add filtering and grouped view for DataCollectionSpec`

---

### Slice 4: 创建/编辑对话框

**目标**：TanStack Form + Zod 验证 + 动态表单

| # | 文件 | 变更 |
|---|------|------|
| 4.1 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/spec-dialog.tsx` | 对话框主体 |
| 4.2 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/spec-form-schema.ts` | Zod schema |
| 4.3 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/dynamic-spec-fields.tsx` | 根据 dataType 切换字段 |
| 4.4 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/operation-selector.tsx` | Operation 选择器 + 新增能力 |
| 4.5 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/spec-preview.tsx` | 实时预览区 |

**Commit**：`feat(web): add DataCollectionSpec create/edit dialog`

---

### Slice 5: 表单校验与错误处理

**目标**：后端错误码映射 + 内联提示 + 专业标签

| # | 文件 | 变更 |
|---|------|------|
| 5.1 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/spec-dialog.tsx` | 错误码映射 + 内联提示 |
| 5.2 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/field-labels.ts` | 专业术语 + tooltip 文案 |
| 5.3 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/index.tsx` | 编辑已有 DataValue 时警告 |

**Commit**：`feat(web): add form validation and error handling for DataCollectionSpec`

---

### Slice 6: 批量操作

**目标**：批量启用/停用、复制、导入/导出

| # | 文件 | 变更 |
|---|------|------|
| 6.1 | `apps/server/src/modules/mes/data-collection-spec/routes.ts` | 新增 batch enable/disable, export endpoints |
| 6.2 | `apps/server/src/modules/mes/data-collection-spec/service.ts` | 批量操作 service |
| 6.3 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/batch-actions.tsx` | 批量操作 UI |
| 6.4 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/import-dialog.tsx` | JSON 导入对话框 |
| 6.5 | `apps/web/src/routes/_authenticated/mes/data-collection-specs/-components/copy-dialog.tsx` | 复制对话框 |

**Commit**：`feat(mes): add batch operations for DataCollectionSpec`

---

### Slice 7: 收尾与测试

**目标**：验证 + 文档更新

| # | 内容 |
|---|------|
| 7.1 | 运行 `bun run lint` + `bun run check-types` |
| 7.2 | 更新 phase3_tasks.md 标记完成 |
| 7.3 | 更新 impl_align 文档 |

**Commit**：`docs(mes): mark 3.5.2 complete`

---

## 5. 文件清单（预期新增/修改）

### 新增文件

```
apps/server/src/modules/mes/operation/
├── schema.ts
├── service.ts
└── routes.ts

apps/web/src/routes/_authenticated/mes/data-collection-specs/
├── index.tsx
└── -components/
    ├── columns.tsx
    ├── card.tsx
    ├── grouped-view.tsx
    ├── spec-dialog.tsx
    ├── spec-form-schema.ts
    ├── dynamic-spec-fields.tsx
    ├── operation-selector.tsx
    ├── spec-preview.tsx
    ├── field-labels.ts
    ├── batch-actions.tsx
    ├── import-dialog.tsx
    └── copy-dialog.tsx

apps/web/src/hooks/use-data-collection-specs.ts
apps/web/src/hooks/use-operations.ts
```

### 修改文件

```
apps/server/src/modules/mes/routes.ts              # mount operation module
apps/server/src/modules/mes/data-collection-spec/routes.ts   # batch endpoints
apps/server/src/modules/mes/data-collection-spec/service.ts  # batch services
packages/db/src/permissions/permissions.ts         # OPERATION_READ/CONFIG
packages/db/src/permissions/preset-roles.ts        # engineer 角色
domain_docs/mes/plan/phase3_tasks.md               # 进度标记
```

---

## 6. 验收标准（DoD）

- [ ] 工程师可在 UI 列表页查看所有采集项规格（分页、筛选、按 Operation 分组）
- [ ] 工程师可创建新采集项（选择 Operation，配置 spec/alarm，实时预览）
- [ ] 工程师可编辑现有采集项（编辑已绑定数据时显示警告）
- [ ] 工程师可批量启用/停用、复制、导入/导出（JSON）
- [ ] 移动端可用（卡片视图自动切换）
- [ ] 表单校验与后端错误一致（内联提示）
- [ ] 权限控制正确（无权限不显示操作按钮）
- [ ] `bun run lint` + `bun run check-types` 通过

---

## 7. 工作流建议

由于主分支已清理，建议：

1. **创建 worktree**：`bun scripts/worktree-new.ts feat/3.5.2-dc-spec-web ../better-3.5.2`
2. **按切片开发**：每个 Slice 完成后立即 commit
3. **合并前检查**：在 worktree 中运行 lint + check-types
4. **清理**：合并后删除 worktree 和分支

---

## 8. 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| Operation CRUD API 耗时超预期 | 最小化实现（仅 list + create），update 可延后 |
| 动态表单复杂度高 | 参考现有 RouteExecutionConfig 表单模式 |
| 分组视图性能 | 前端分组，避免 N+1 查询 |

---

## 9. 开放问题（已在访谈中决定，记录备查）

1. **父子工序**：延后到后续迭代，不在本次实现
2. **spec 结构**：统一使用 `{ min?, max?, unit?, target?, lsl?, usl? }`，空字段不存储
3. **数据类型切换**：已有 DataValue 时禁止切换 dataType（显示警告 + 禁用）

---

## References

- 3.5.1 API 实现：`apps/server/src/modules/mes/data-collection-spec/`
- 规范参考：`apps/web/src/routes/_authenticated/mes/runs/index.tsx`
- 前端模式：`agent_docs/02_frontend/data_list_pattern.md`
- 表单模式：`agent_docs/02_frontend/create_edit_dialog.md`
