# MES 测试分层与优先级

## Context
- 用户询问：MES 系统最需要哪些测试？测试分几种？希望先做测试策略讨论（不涉及立刻落地代码）。

## Decisions
- 优先采用“金字塔 + 关键路径”的组合：以 server 侧的 **集成测试（API+DB）** 为主，补少量 **单元测试（纯领域逻辑）**，最后用极少量 **端到端/验收测试** 覆盖关键业务流。
- 首批测试优先覆盖“出错成本最高/最容易回归”的点：状态机与路由、追溯链、幂等与并发、权限隔离、事务一致性。

## Plan
- 先列出 3-5 条“关键业务流”（从需求/验收场景抽取）：每条流用 1-2 个 API 集成测试覆盖 happy path + 1-2 个错误/越权/非法状态转移。
- 抽出可纯函数化的核心规则：状态转移校验、路由选择、追溯链拼接/校验 → 用单元测试快速覆盖边界条件。
- 对外部集成（ERP/设备/通知）先做“契约/适配层测试”：mock 外部，保证我们发/收的 payload 与错误处理稳定。
- 当关键流稳定后，再补少量 UI 端到端（Playwright）或 API 验收脚本：只测“用户能跑通”，避免大规模 UI 细节测试。

## Proposed Framework (基于现有资源的更好测试框架)

### 目标
- **可重复**：每次跑出来结果一致（独立 DB、固定 seed、稳定错误码/断言点）。
- **分层清晰**：PR 默认只跑快的；慢的 flow 回归单独 job 或夜间跑。
- **以“关键流 + 不变量”驱动**：把 MES 的状态机/追溯/权限/幂等等高风险点固化成门槛。

### 现有资产怎么“升级成框架”
1) 把 `scripts/mes-acceptance.ts` + `apps/server/scripts/test-mes-flow.ts` 定位为 **Flow Acceptance Suite（API 级 E2E）**  
   - 现状已很好：独立 `acceptance.db`、自动 deploy+seed、起 server、跑 flow、失败即退出。
   - 下一步只需要：支持“矩阵运行”（`track × scenario`）、统一输出（JSON + 可选 junit）、更稳的 server 启动方式（避免 `--hot`）。

2) 把 `apps/server/scripts/mes-flow-test/` 定位为 **遗留/实验脚本**  
   - 建议两种处理：要么迁移成真正的 `bun test` 用例（放到 tests 目录，使用同一套 env/DB 管理），要么合并其有价值的“造数/断言”到 `test-mes-flow.ts` 并逐步下线，避免双轨维护。

3) 把 `domain_docs/mes/*_playbook/05_validation/*` 作为 **用例规格/验收 checklist**  
   - 建议增加一个“映射表”：每个 validation 小节 → 对应的自动化 scenario（`test-mes-flow.ts --scenario ...`）或对应的 integration test 文件，确保文档与自动化不脱节。

### 建议新增的“测试分层与目录/命令”
**A. Unit（最快）**  
- 位置：`apps/server/src/**/__tests__/*.test.ts` 或 `apps/server/tests/unit/*`（二选一，统一即可）  
- 内容：状态转移校验、路由选择、追溯摘要/不变量、Zod/输入校验的纯逻辑。  
- 命令：`bun test`（server 内）或根 `bun run test:unit` 聚合。

**B. Integration（API + DB，但不跑整条大 flow）**  
- 位置：`apps/server/tests/integration/*`  
- 内容：关键端点的读写一致性/权限/幂等等；每个测试只覆盖 1-2 个端点组合，避免巨型脚本。  
- 关键补充：一个统一的 `testDb()` / `startServer()` helper（随机端口 + 临时 sqlite 文件 + 自动 migrate/seed）。

**C. Acceptance Flow（你们已有的）**  
- 入口：`bun run mes:acceptance`  
- 内容：只保留 3-8 条“关键闭环”场景（SMT/DIP 各 1-3 条 + 异常 1-2 条），作为回归门槛/夜间回归。

**D. Web E2E（后置）**  
- 只做 1-2 条“UI 串联”冒烟：登录→创建 run→执行一个关键动作→看到状态变化；尽量不测 UI 细节。

### 需要补充/改造的关键点（优先级）
1) **统一测试入口与脚本**：补根 `package.json` 的 `test:*`（unit/integration/acceptance）与 CI 对应 job。  
2) **server 可测试化**：把 `apps/server/src/index.ts` 的“建 app / listen”拆开，导出 `createApi()`/`createApp()` 供 integration tests in-process 启动（减少端口/进程 flake）。  
3) **测试 DB 管理**：每次测试生成独立 sqlite 文件（或每文件一个），跑完清理；seed 要可选择“最小 seed”（只建角色/用户/基础线体）以缩短耗时。  
4) **断言点标准化**：错误码/状态字段/trace 结构作为契约；建议把 `FlowSummary`/`StepResult` 当成稳定输出结构，CI 失败时能定位到 step。  
5) **覆盖矩阵收敛**：避免“全量流程全量组合”导致维护爆炸；用 playbook/acceptance 场景挑最关键的 3-5 条，剩下用 integration tests 覆盖细点。

## Findings
### 测试常见分层（对本仓库的映射）
- **单元测试（Unit）**：不碰 DB/网络；适合纯逻辑（状态机、路由规则、追溯算法、Zod 校验规则）。
- **集成测试（Integration）**：server + Prisma + SQLite/测试库；验证事务、约束、幂等、并发、权限、审计日志等。
- **契约测试（Contract）**：API schema/返回结构稳定性（OpenAPI/类型契约）；对外部系统则验证适配层输入输出。
- **端到端/验收测试（E2E/Acceptance）**：从“用户动作→web→api→db”的关键路径；数量要少、只测核心。
- **非功能测试（NFR）**（后置）：性能/压测、可靠性、迁移回归、安全扫描等。

### MES 最需要优先覆盖的测试主题（按风险排序）
1) **状态机与非法转移**：任何“跳状态/重复提交/跨站点”都应被拒绝且有明确错误码。  
2) **路由/派工/工序规则**：同一输入应得到确定输出；规则变更要可回归验证。  
3) **追溯链完整性**：投料/产出/批次/序列号/工艺参数必须形成可查询的链，且不可被“补写”破坏历史。  
4) **幂等与并发一致性**：双击提交/重试/网络抖动；并发写入时库存、报工、质量记录不能出现负数/重复/丢失。  
5) **权限与隔离**：角色/站点/工厂隔离；越权读写必须失败（含列表查询与导出）。  
6) **审计与可观测性**：关键写操作必须产生审计记录/traceId，错误要可定位。  
7) **迁移与数据兼容**：schema 变更后历史数据仍可读/关键查询不崩。  

### 现有仓库资产的“测试类型”归类（你问到的文件夹/脚本）
- `apps/server/scripts/test-mes-flow.ts`：**自动化验收脚本 / API 级端到端（E2E）**。通过 HTTP 调用一串 MES 关键流程（多角色登录、WO→Run→Readiness→Loading→FAI→Authorize→Execution→OQC/MRB→Trace 断言），更像“黑盒集成测试/冒烟回归”而非单元测试。
- `scripts/mes-acceptance.ts`：**验收测试运行器（harness）**。用独立 `acceptance.db` 执行 `db:deploy` + `db:seed`，启动 server，再运行 `test-mes-flow.ts`，适合接入 CI 做“可重复、不会污染本地 DB”的回归门槛。
- `apps/server/scripts/mes-flow-test/`：更像**实验性/旧版的端到端脚本**（`index.ts` 直接用 Prisma upsert 造数据，再用 API 跑流程；夹杂 `bun:test` 的 `expect` 断言）。它同样属于集成/E2E，但因为“自造数据+固定 API_URL”等实现细节，可复用性与可移植性不如 `test-mes-flow.ts` + `mes-acceptance.ts` 这一套。
- `domain_docs/mes/smt_playbook/`、`domain_docs/mes/dip_playbook/`：**手工验收/运行手册（manual playbook）**，含配置、跑流程、验证 checklist。它们本身不是自动化测试，但可作为验收用例与自动化脚本的“测试说明书/规格来源”。

## Progress
- 已输出分层与优先级建议；待确认首批关键业务流清单后再落地测试用例。

## Errors
- 无

## Open Questions
- 你们 MES 当前“最关键的 3-5 条业务流”分别是什么？（例如：工单创建→下发→开工→报工→完工入库；投料追溯；首检/巡检/终检；返工/报废；工艺参数采集）
- 外部集成有哪些（ERP/设备/通知）？哪些需要做契约测试/哪些可以先 mock？
- 你们更想先保证：API/数据一致性（推荐）还是 UI 关键路径（Playwright）？

## References
- 无
