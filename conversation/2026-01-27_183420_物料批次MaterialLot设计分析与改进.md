# 物料批次（MaterialLot）设计分析与改进

> 日期：2026-01-27
> 状态：讨论完成，待确认实施优先级

## Context

在讨论上料防错功能时，发现了关于物料批次（MaterialLot）设计的若干问题和改进机会。本文档整理了所有讨论内容和改进建议。

### 物料条码格式

系统采用 `物料编码|批次号` 格式的条码：

| 字段 | 示例 | 来源 |
|------|------|------|
| 物料编码 | `5212090001` | 条码中提取 |
| 批次号 | `LOT-20250526-001` | 条码中提取 |

**支持的分隔符**：`|`、`:`、`@`、`#`

**代码位置**：`apps/server/src/modules/mes/loading/service.ts:11, 109-122`

### 物料数据模型

系统有两个相关但独立的表：

| 表 | 用途 | 来源 | 关系 |
|---|------|------|------|
| `Material` | 物料主数据 | ERP 同步 | 只读镜像 |
| `MaterialLot` | 物料批次记录 | 扫码时 upsert | 运行时产生 |

**关键点**：`MaterialLot.materialCode` 与 `Material.code` 之间**没有外键约束**。

### MaterialLot 的创建时机

MaterialLot 在 **3 个地方** 被创建（upsert）：

| 场景 | 触发 API | 代码位置 |
|------|----------|----------|
| 上料验证 | `POST /api/loading/verify` | `loading/service.ts:566` |
| 换料 | `POST /api/loading/replace` | `loading/service.ts:882` |
| 烘烤记录 | `POST /api/bake-records` | `bake/service.ts:230` |

### MaterialLot 的使用场景

| 场景 | 关联表 | 用途 |
|------|--------|------|
| 上料防错 | `LoadingRecord.materialLotId` | 记录站位上了哪批物料 |
| 烘烤记录 | `BakeRecord.materialLotId` | 记录烘了哪批物料 |
| 物料使用 | `MaterialUse.materialLotId` | 记录成品用了哪些批次 |
| 站位当前物料 | `FeederSlot.currentMaterialLotId` | 站位当前装的是哪批 |
| 产品追溯 | 通过 LoadingRecord/MaterialUse | 从成品反查物料批次 |

### LOT 编码管理

| 问题 | 答案 |
|------|------|
| LOT 编码谁控制？ | **线下控制**（供应商/仓库贴标） |
| MES 管理什么？ | 只记录和追溯，不制定编码规则 |
| 推荐格式 | `LOT-YYYYMMDD-SEQ`（如 `LOT-20250526-001`） |

---

## Findings

### 问题 1：物料编码不校验主数据

**问题**：扫码时只要条码格式正确，就会自动创建 MaterialLot，不检查物料编码是否在 Material 主数据中。

**后果**：
- 可能创建"野数据"（物料编码不存在于 ERP）
- 无法区分"ERP 已知物料"和"未知物料"

**风险等级**：⚠️ 中

### 问题 2：IQC 字段未使用

**问题**：MaterialLot 表有 `iqcResult`、`iqcDate`、`supplier` 字段，但从未写入数据。

```prisma
model MaterialLot {
  supplier     String?    // 永远是 null
  iqcResult    String?    // 永远是 null
  iqcDate      DateTime?  // 永远是 null
}
```

**风险等级**：🔵 低（预留字段，不影响功能）

### 问题 3：无物料批次管理页面

**问题**：MaterialLot 是在扫码时"隐式创建"的，但用户无法：
- 查看系统中有哪些物料批次
- 编辑 supplier/iqcResult 等信息
- 查询某批次用在了哪些产品
- 清理无效/测试数据

**现有页面**：
- `/mes/materials` - 物料主数据（Material，ERP，只读）
- ~~`/mes/material-lots`~~ - 物料批次（MaterialLot）**不存在**

**风险等级**：⚠️ 中

### 问题 4：上料失败仍创建 MaterialLot

**问题**：即使上料验证失败（物料不匹配期望），MaterialLot 仍然会被创建。

**影响**：
- 数据库中可能存在从未成功上料的"无效"批次记录
- 不影响业务逻辑，但数据不够干净

**风险等级**：🔵 低

---

## Plan

### Phase 1：增加物料校验提示（推荐立即做）

**目标**：扫码时提示物料编码是否在主数据中，但不阻断流程。

**后端改动**：

```typescript
// apps/server/src/modules/mes/loading/service.ts - verifyLoading 函数

// 在返回结果中增加字段
return {
  success: true,
  data: {
    ...mapLoadingRecord(record),
    materialKnown: !!material,      // 新增：物料是否在主数据中
    materialName: material?.name,   // 新增：物料名称（方便核对）
  },
};
```

**前端展示**：
- `materialKnown = true` → 正常显示
- `materialKnown = false` → 黄色警告 "⚠️ 此物料编码未在主数据中"

**工作量**：小

### Phase 2：LoadingRecord 增加校验标记

**目标**：在记录中标记物料校验状态，方便追溯和审计。

**Schema 改动**：

```prisma
model LoadingRecord {
  // ... 现有字段
  materialValidation  String?   // KNOWN | UNKNOWN | null
}
```

**业务价值**：追溯时可筛选"用了未知物料"的批次

**工作量**：小

### Phase 3：新增物料批次管理页面

**目标**：让用户能查看和管理 MaterialLot。

**页面设计**：

```
/mes/material-lots - 物料批次管理
├─ 列表展示
│   ├─ materialCode（物料编码）
│   ├─ lotNo（批次号）
│   ├─ supplier（供应商）  ← 可编辑
│   ├─ iqcResult（IQC结果）← 可编辑
│   ├─ iqcDate（IQC日期）  ← 可编辑
│   ├─ createdAt（创建时间）
│   └─ 物料名称（关联 Material 展示）
│
├─ 筛选
│   ├─ 物料编码
│   ├─ 批次号
│   ├─ 创建时间范围
│   ├─ IQC状态（全部/已检/未检）
│   └─ 物料是否在主数据中（已知/未知）
│
├─ 详情/编辑弹窗
│   ├─ 基本信息
│   ├─ 编辑 supplier/iqcResult/iqcDate
│   └─ 关联记录（在哪些 Run 中使用过）
│
└─ 关联查询
    ├─ 上料记录（LoadingRecord）
    ├─ 烘烤记录（BakeRecord）
    └─ 物料使用（MaterialUse）
```

**后端 API**：

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/material-lots` | 列表查询 |
| GET | `/api/material-lots/:id` | 详情 |
| PATCH | `/api/material-lots/:id` | 编辑（supplier/iqc 信息） |
| GET | `/api/material-lots/:id/usage` | 查询使用记录 |

**导航位置**：

```
工艺与主数据
├─ 物料主数据（/mes/materials）   ← 现有
├─ 物料批次（/mes/material-lots） ← 新增
└─ ...
```

**工作量**：中

### Phase 4：IQC 集成（未来可做）

**两种路径**：

| 路径 | 实现方式 | 复杂度 |
|------|----------|--------|
| A. 系统集成 | IQC 系统推送 iqcResult | 高 |
| B. 手动录入 | 在物料批次页面编辑 | 低（Phase 3 已包含） |

---

## Decisions

待确认：
1. Phase 1-3 的实施优先级
2. IQC 是否需要集成，如果需要，数据来源是什么
3. 物料批次页面的权限设计（谁可以编辑 iqcResult）
4. 是否需要定期清理无效 MaterialLot 数据

---

## Progress

- [x] 完成设计分析
- [x] 整理改进建议
- [ ] 确认实施优先级
- [ ] 实施 Phase 1
- [ ] 实施 Phase 2
- [ ] 实施 Phase 3

---

## Errors

无

---

## Open Questions

1. **IQC 业务需求**：是否需要 IQC 校验才能上料？如果需要，数据来源是什么（系统集成 or 手动录入）？

2. **权限设计**：物料批次页面的编辑权限给谁？建议新增 `MATERIAL_LOT_EDIT` 权限。

3. **数据清理**：是否需要定期清理从未成功上料的 MaterialLot 记录？

---

## References

### 核心代码

| 文件 | 内容 |
|------|------|
| `packages/db/prisma/schema/schema.prisma:1756-1773` | MaterialLot 模型定义 |
| `apps/server/src/modules/mes/loading/service.ts` | 上料验证逻辑（upsert MaterialLot） |
| `apps/server/src/modules/mes/bake/service.ts` | 烘烤记录逻辑（upsert MaterialLot） |
| `apps/server/src/modules/mes/trace/service.ts` | 产品追溯（使用 MaterialLot） |

### 文档

| 文件 | 内容 |
|------|------|
| `domain_docs/mes/smt_playbook/02_configuration/02_material_master_and_lots.md` | 物料与批次配置说明 |
| `domain_docs/mes/smt_playbook/03_run_flow/03_loading_flow.md` | 上料防错流程 |
| `domain_docs/mes/smt_playbook/01_data_sources_and_ownership.md` | 数据来源与管理边界 |

---

## 讨论记录摘要

1. **问**：物料条码为什么需要带上 LOT？
   **答**：批次级追溯，质量问题时可精确定位到供应商批次。

2. **问**：LOT 编码是谁控制的？
   **答**：线下控制（供应商/仓库贴标），MES 只记录不制定规则。

3. **问**：上料扫码会自动生成 MaterialLot 吗？
   **答**：是的，通过 upsert 自动创建/复用。

4. **问**：如何保证物料编码有效？
   **答**：当前不校验 Material 主数据，只校验是否匹配期望物料。

5. **问**：IQC 字段怎么来的？
   **答**：预留字段，目前未实现写入逻辑。

6. **问**：物料是 ERP 同步还是手动创建？
   **答**：Material 只能 ERP 同步；MaterialLot 是扫码时隐式创建。

7. **问**：MaterialLot 在哪里用到？
   **答**：上料记录、烘烤记录、物料使用、产品追溯。

8. **问**：有物料批次管理页面吗？
   **答**：没有，需要新建。
