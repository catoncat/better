# DIP 验收数据准备

## Context
- 目标：为 DIP 端到端手工验收准备一套可用数据（UI+API 联动）。
- 用户已有 `bun run db:seed`，希望在现有种子数据上完善。

## Decisions
-

## Plan
-

## Findings
- `db:seed` 入口：根 `package.json` → `bun run --filter server db:seed`，实际执行 `apps/server/scripts/seed.ts`。
- 当前工作区不干净：`Dockerfile`, `apps/server/scripts/seed-mes.ts`, `apps/server/scripts/seed-roles.ts`, `apps/server/scripts/seed.ts` 已修改。
- `apps/server/scripts/seed.ts` 当前包含 SMT+DIP 主数据与演示 WO/Run/Unit：DIP Run `RUN-DEMO-DIP-001`、WO `WO-DEMO-DIP-RUN-001`，Run 状态 `PREP`、Unit 初始 `QUEUED`、routeVersion 需编译为 `READY`。
- 当前脚本中 `LINE-A` 仅启用 `ROUTE/LOADING` 就绪检查；未看到设备/物料/钢网/锡膏等数据在 `seed.ts` 内生成（需确认是否由其他脚本补充）。
- OQC 抽检触发依赖 sampling rule；若无规则或 sampleSize=0，会直接将 Run 置为 COMPLETED（不触发 OQC）。
- OQC sampling rule 字段：`productCode?`/`lineId?`/`routingId?`、`samplingType`(PERCENTAGE/FIXED)、`sampleValue`、`priority`、`isActive`、`meta?`。
- Readiness EQUIPMENT 通过条件：`tpmEquipment.equipmentCode` 需与 `station.code` 对应，且无阻断维保任务。
- Readiness LOADING 若无 `RunSlotExpectation`，检查结果为空（不会阻断）。
- `OqcSamplingRule.sampleValue` 为 Float，规则允许按 `productCode/lineId/routingId` 过滤并按 `priority` 排序。
- TrackIn API 需要 `runNo/woNo/sn`；TrackOut 需要 `runNo/sn/result(PASS|FAIL)`。
- FAI API：`POST /api/fai/run/{runNo}` → `/start` → `/items` → `/complete`，授权会阻断直到 FAI PASS。

## Progress
- 已在 `apps/server/scripts/seed.ts` 更新 DIP readiness（ROUTE/EQUIPMENT/MATERIAL），并将设备种子改为 `equipmentCode=station.code`（覆盖 SMT + DIP）。
- 已添加 DIP OQC sampling rule（FIXED=1，限定 P-1001 + LINE-DIP-A + PCBA-DIP-V1）。
- 已在 `domain_docs/mes/tests/01_acceptance_scenarios.md` 固化 DIP 手工验收种子数据说明。

## Errors
-

## Open Questions
- 是否在现有工作区继续修改，还是新建 worktree 以避免脏状态干扰？
- 需生成的 DIP 验收数据范围（是否包含 OQC/MRB 分支与返修 Run）？

## References
-
