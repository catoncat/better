generator client {
  provider     = "prisma-client-js"
  output       = "../generated/client"
  moduleFormat = "esm"
  runtime      = "bun"
}

generator prismabox {
  provider                    = "prismabox"
  typeboxImportDependencyName = "elysia"
  typeboxImportVariableName   = "t"
  inputModel                  = true
  output                      = "../generated/prismabox"
}

datasource db {
  provider = "sqlite"
}

// ==========================================
// Existing Models (User, Auth)
// ==========================================

enum UserRole {
  admin
  supervisor
  workshop_supervisor
  technician
  operator
}


enum NotificationStatus {
  unread
  read
}

enum NotificationPriority {
  low
  normal
  high
}

model User {
  id                      String   @id @default(cuid())
  username                String?  @unique
  passwordHash            String?
  name                    String
  email                   String   @unique
  emailVerified           Boolean  @default(false)
  role                    UserRole @default(operator) // Legacy field, will be deprecated
  department              String?
  phone                   String?
  isActive                Boolean  @default(true)
  enableWecomNotification Boolean  @default(true)
  image                   String?
  preferredHomePage       String?  // User's preferred home page
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  sessions                   Session[]
  accounts                   Account[]
  notifications              Notification[]
  systemLogs                 SystemLog[]
  
  // New RBAC relations
  userRoles              UserRoleAssignment[]
  lineBindings           UserLineBinding[]
  stationBindings        UserStationBinding[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}


model Notification {
  id          String @id @default(cuid())
  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id])

  type     String
  title    String
  message  String
  status   NotificationStatus
  priority NotificationPriority?
  data     Json?

  wecomSent   Boolean?
  wecomSentAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, status])
  @@map("notifications")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  /// SystemConfig value 取决于 key，暂保留为 Record 类型
  value     Json
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model SystemLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action    String
  module    String?
  /// SystemLog details 是通用日志结构
  details   Json?
  ip        String?
  userAgent String?
  status    String?

  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@map("system_logs")
}

// ==========================================
// MES Domain Models
// ==========================================

enum WorkOrderStatus {
  RECEIVED
  RELEASED
  IN_PROGRESS
  COMPLETED
}

enum RunStatus {
  PREP
  AUTHORIZED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CLOSED_REWORK
  SCRAPPED
}

enum StationType {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum ProcessType {
  SMT
  DIP
}

enum UnitStatus {
  QUEUED
  IN_STATION
  OUT_FAILED
  DONE
  ON_HOLD
  SCRAPPED
}

enum TrackResult {
  PASS
  FAIL
}

enum TrackSource {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum InspectionType {
  FAI
  IPQC
  FQC
  OQC
}

enum InspectionStatus {
  PENDING
  INSPECTING
  PASS
  FAIL
  CANCELLED
}

enum InspectionItemResult {
  PASS
  FAIL
  NA
}

enum DispositionType {
  REWORK
  SCRAP
  HOLD
}

enum OqcSamplingType {
  PERCENTAGE // Sample X% of units
  FIXED      // Sample fixed N units
}

// ==========================================
// Line Readiness Check Enums (M2)
// ==========================================

enum ReadinessCheckType {
  PRECHECK  // 预检（异步，仅提示）
  FORMAL    // 正式检查（同步，阻断式）
}

enum ReadinessCheckStatus {
  PENDING   // 检查中
  PASSED    // 全部通过
  FAILED    // 有失败项
}

enum ReadinessItemType {
  EQUIPMENT // 设备状态
  MATERIAL  // 物料主数据
  ROUTE     // 工艺路线
  STENCIL   // 钢网状态
  SOLDER_PASTE // 锡膏状态
  LOADING   // 上料防错
  // PREP_* 准备项检查（SMT Gap Phase 1）
  PREP_BAKE          // 烘烤准备（需烘烤记录）
  PREP_PASTE         // 锡膏准备（开封/回温/暴露时间）
  PREP_STENCIL_USAGE // 钢网使用准备（使用记录+寿命检查）
  PREP_STENCIL_CLEAN // 钢网清洗准备（清洗记录）
  PREP_SCRAPER       // 刮刀准备（点检记录）
  PREP_FIXTURE       // 夹具准备（寿命检查）
  PREP_PROGRAM       // 炉温程式准备（程式一致性检查）
  // TIME_RULE 时间规则检查（SMT Gap Phase 2）
  TIME_RULE          // 时间规则检查（锡膏暴露/水洗时间等）
}

enum ReadinessItemStatus {
  PASSED    // 通过
  FAILED    // 失败
  WAIVED    // 已豁免
}

// ==========================================
// Time Rule Enums (SMT Gap Phase 2)
// ==========================================

enum TimeRuleType {
  SOLDER_PASTE_EXPOSURE    // 锡膏暴露规则
  WASH_TIME_LIMIT          // 水洗时间规则
}

enum TimeRuleInstanceStatus {
  ACTIVE      // 倒计时中
  COMPLETED   // 在时限内完成
  EXPIRED     // 已超时
  WAIVED      // 已豁免
}

enum TimeRuleScope {
  GLOBAL      // 全局
  LINE        // 产线级
  ROUTING     // 路由级
  PRODUCT     // 产品级
}

// ==========================================
// Loading Verification & Integration Enums (M2)
// ==========================================

enum LoadingRecordStatus {
  LOADED
  UNLOADED
  REPLACED
}

enum LoadingVerifyResult {
  PASS
  FAIL
  WARNING
}

enum StencilStatus {
  READY
  NOT_READY
  MAINTENANCE
}

enum SolderPasteStatus {
  COMPLIANT
  NON_COMPLIANT
  EXPIRED
}

enum IntegrationSource {
  AUTO
  MANUAL
}

enum InspectionResultType {
  SPI
  AOI
}

enum InspectionResultStatus {
  PASS
  FAIL
}

enum AuditEntityType {
  WORK_ORDER
  RUN
  UNIT
  TRACK
  INSPECTION
  DEFECT
  DISPOSITION
  DATA_VALUE
  MATERIAL_USE
  INTEGRATION
  USER
  SYSTEM_CONFIG
  NOTIFICATION
  SYSTEM
  READINESS_CHECK // M2: Line Readiness Check audit
  BAKE_RECORD // SMT bake record
  SOLDER_PASTE_USAGE // SMT solder paste usage
  COLD_STORAGE_TEMP // SMT cold storage temperature
  STENCIL_USAGE // SMT stencil usage
  STENCIL_CLEANING // SMT stencil cleaning
  SQUEEGEE_USAGE // SMT squeegee usage
  FIXTURE_USAGE // SMT fixture usage
  EQUIPMENT_INSPECTION // SMT equipment inspection
  OVEN_PROGRAM_RECORD // SMT oven program record
  DAILY_QC_RECORD // SMT daily QC record
  PRODUCTION_EXCEPTION // SMT production exception
  MAINTENANCE_RECORD   // Equipment/Fixture maintenance
}

model WorkOrder {
  id            String          @id @default(cuid())
  woNo          String          @unique
  productCode   String
  plannedQty    Float
  routingId     String?
  status        WorkOrderStatus @default(RECEIVED)
  erpStatus     String?         // ERP 业务状态 (FStatus)
  erpPickStatus String?         // ERP 领料状态 (FPickMtrlStatus)
  pickStatus    String?         // MES 领料状态 (手动工单用)
  dueDate       DateTime?
  meta          Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  routing Routing? @relation(fields: [routingId], references: [id])
  runs    Run[]
  units   Unit[]
}

model Run {
  id           String    @id @default(cuid())
  runNo        String    @unique
  woId         String
  lineId       String?
  routeVersionId String?
  planQty      Int       // 本批次计划生产数量
  status       RunStatus @default(PREP)
  shiftCode    String?
  changeoverNo String? // 换线/开班标识
  startedAt    DateTime?
  endedAt      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Rework tracking (M2: OQC/MRB)
  parentRunId       String?   // Points to original Run for rework runs
  reworkType        String?   // 'REUSE_PREP' | 'FULL_PREP' (for rework runs only)

  // MRB authorization (M2: OQC/MRB)
  authorizationType String?   // 'NORMAL' | 'MRB_OVERRIDE'
  mrbDecisionId     String?   // Reference to MRB decision inspection
  mrbAuthorizedBy   String?   // MRB authorizer user ID
  mrbAuthorizedAt   DateTime?
  mrbFaiWaiver      Boolean?  // True if FAI was waived by MRB
  mrbWaiverReason   String?   // Required when FAI waived

  workOrder        WorkOrder       @relation(fields: [woId], references: [id])
  line             Line?           @relation(fields: [lineId], references: [id])
  routeVersion     ExecutableRouteVersion? @relation(fields: [routeVersionId], references: [id])
  parentRun        Run?            @relation("ReworkRuns", fields: [parentRunId], references: [id])
  reworkRuns       Run[]           @relation("ReworkRuns")
  prepChecks       PrepCheck[]
  readinessChecks  ReadinessCheck[]  // M2: Line Readiness Check
  inspections      Inspection[] // 用 Inspection 统一承载 FAI/IPQC/FQC/OQC
  authorizations   Authorization[]
  units            Unit[]
  slotExpectations RunSlotExpectation[]
  loadingRecords   LoadingRecord[]
  bakeRecords      BakeRecord[]
  solderPasteUsageRecords SolderPasteUsageRecord[]
  stencilUsageRecords StencilUsageRecord[]
  stencilCleaningRecords StencilCleaningRecord[]
  squeegeeUsageRecords SqueegeeUsageRecord[]
  fixtureUsageRecords FixtureUsageRecord[]
  timeRuleInstances TimeRuleInstance[]  // SMT Gap Phase 2: Time Rule Instances

  @@index([parentRunId])
}

model Line {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  processType ProcessType @default(SMT)
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations         Station[]
  runs             Run[]
  userBindings     UserLineBinding[]
  oqcSamplingRules OqcSamplingRule[]
  feederSlots      FeederSlot[]
  lineStencils     LineStencil[]
  lineSolderPastes LineSolderPaste[]
  solderPasteUsageRecords SolderPasteUsageRecord[]
  stencilUsageRecords StencilUsageRecord[]
  stencilCleaningRecords StencilCleaningRecord[]
  squeegeeUsageRecords SqueegeeUsageRecord[]
  fixtureUsageRecords FixtureUsageRecord[]
  equipmentInspectionRecords EquipmentInspectionRecord[]
  ovenProgramRecords OvenProgramRecord[]
  dailyQcRecords DailyQcRecord[]
  productionExceptionRecords ProductionExceptionRecord[]
  maintenanceRecords MaintenanceRecord[]
}

// ==========================================
// Loading Verification Models (M2)
// ==========================================

model FeederSlot {
  id                   String   @id @default(cuid())
  lineId               String
  slotCode             String
  slotName             String?
  position             Int

  currentMaterialLotId String?
  isLocked             Boolean  @default(false)
  failedAttempts       Int      @default(0)
  lockedAt             DateTime?
  lockedReason         String?

  meta                 Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  line            Line                 @relation(fields: [lineId], references: [id])
  loadingRecords  LoadingRecord[]
  slotMappings    SlotMaterialMapping[]
  runExpectations RunSlotExpectation[]

  @@unique([lineId, slotCode])
  @@index([lineId])
}

model SlotMaterialMapping {
  id           String   @id @default(cuid())
  productCode  String?
  routingId    String?
  slotId       String
  materialCode String
  priority     Int      @default(1)
  isAlternate  Boolean  @default(false)
  unitConsumption Float?
  isCommonMaterial Boolean @default(false)

  meta         Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  slot    FeederSlot @relation(fields: [slotId], references: [id])
  routing Routing?   @relation(fields: [routingId], references: [id])

  @@unique([slotId, materialCode])
  @@index([productCode])
  @@index([routingId])
  @@index([slotId])
}

model RunSlotExpectation {
  id                   String   @id @default(cuid())
  runId                String
  slotId               String
  expectedMaterialCode String
  alternates           Json?
  status               String   @default("PENDING")
  loadedMaterialCode   String?
  loadedAt             DateTime?
  loadedBy             String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  run  Run        @relation(fields: [runId], references: [id])
  slot FeederSlot @relation(fields: [slotId], references: [id])
  loadingRecords LoadingRecord[]

  @@unique([runId, slotId])
  @@index([runId])
  @@index([slotId])
}

model LoadingRecord {
  id                   String              @id @default(cuid())
  runId                String
  slotId               String
  runSlotExpectationId String?
  materialLotId        String
  materialCode         String
  expectedCode         String?
  status               LoadingRecordStatus @default(LOADED)
  verifyResult         LoadingVerifyResult
  failReason           String?
  loadedAt             DateTime            @default(now())
  loadedBy             String
  packageQty           Int?
  reviewedBy           String?
  reviewedAt           DateTime?
  unloadedAt           DateTime?
  unloadedBy           String?

  meta                 Json?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  run          Run                 @relation(fields: [runId], references: [id])
  slot         FeederSlot          @relation(fields: [slotId], references: [id])
  materialLot  MaterialLot         @relation(fields: [materialLotId], references: [id])
  expectation  RunSlotExpectation? @relation(fields: [runSlotExpectationId], references: [id])

  @@index([runId])
  @@index([slotId])
  @@index([materialLotId])
  @@index([loadedAt])
}

model BakeRecord {
  id               String   @id @default(cuid())
  runId            String?
  routingStepId    String?
  materialLotId    String?
  itemCode         String
  bakeProcess      String
  bakeQty          String
  bakeTemperature  Float?
  durationHours    String?
  inAt             DateTime
  inBy             String
  outAt            DateTime
  outBy            String
  confirmedBy      String?
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  run         Run?         @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])
  materialLot MaterialLot? @relation(fields: [materialLotId], references: [id])

  @@index([runId])
  @@index([routingStepId])
  @@index([materialLotId])
  @@index([itemCode])
  @@index([inAt])
  @@index([outAt])
}

model LineStencil {
  id        String   @id @default(cuid())
  lineId    String
  stencilId String
  isCurrent Boolean  @default(true)
  boundAt   DateTime @default(now())
  boundBy   String?
  unboundAt DateTime?
  unboundBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  line Line @relation(fields: [lineId], references: [id])

  @@unique([lineId, stencilId, boundAt])
  @@index([lineId, isCurrent])
  @@index([stencilId])
}

model LineSolderPaste {
  id        String   @id @default(cuid())
  lineId    String
  lotId     String
  isCurrent Boolean  @default(true)
  boundAt   DateTime @default(now())
  boundBy   String?
  unboundAt DateTime?
  unboundBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  line Line @relation(fields: [lineId], references: [id])

  @@unique([lineId, lotId, boundAt])
  @@index([lineId, isCurrent])
  @@index([lotId])
}

model StencilStatusRecord {
  id            String            @id @default(cuid())
  eventId       String            @unique
  eventTime     DateTime
  stencilId     String
  version       String?
  status        StencilStatus
  tensionValue  Float?
  lastCleanedAt DateTime?
  source        IntegrationSource
  operatorId    String?
  receivedAt    DateTime          @default(now())
  meta          Json?

  @@index([stencilId])
  @@index([eventTime])
}

model SolderPasteStatusRecord {
  id         String             @id @default(cuid())
  eventId    String             @unique
  eventTime  DateTime
  lotId      String
  status     SolderPasteStatus
  expiresAt  DateTime?
  thawedAt   DateTime?
  stirredAt  DateTime?
  source     IntegrationSource
  operatorId String?
  receivedAt DateTime           @default(now())
  meta       Json?

  @@index([lotId])
  @@index([eventTime])
}

model SolderPasteUsageRecord {
  id          String   @id @default(cuid())
  lotId       String
  lineId      String?
  runId       String?
  routingStepId String?
  receivedAt  DateTime?
  expiresAt   DateTime?
  receivedQty Int?
  thawedAt    DateTime?
  issuedAt    DateTime?
  returnedAt  DateTime?
  isReturned  Boolean?
  usedBy      String?
  remark      String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])
  run  Run?  @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])

  @@index([lotId])
  @@index([lineId])
  @@index([runId])
  @@index([routingStepId])
  @@index([receivedAt])
  @@index([issuedAt])
}

model ColdStorageTemperatureRecord {
  id          String   @id @default(cuid())
  measuredAt  DateTime
  temperature Float
  measuredBy  String
  reviewedBy  String?
  remark      String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([measuredAt])
}

model StencilUsageRecord {
  id               String   @id @default(cuid())
  stencilId        String
  lineId           String?
  runId            String?
  routingStepId    String?
  recordDate       DateTime
  stencilThickness Float?
  productModel     String?
  printCount       Int?
  totalPrintCount  Int?
  replacedAt       DateTime?
  checkDeform      Boolean?
  checkHoleDamage  Boolean?
  checkSealIntact  Boolean?
  tensionValues    Json?
  usedBy           String?
  confirmedBy      String?
  remark           String?
  lifeLimit        Int?
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])
  run  Run?  @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])

  @@index([stencilId])
  @@index([lineId])
  @@index([runId])
  @@index([routingStepId])
  @@index([recordDate])
}

model StencilCleaningRecord {
  id          String   @id @default(cuid())
  stencilId   String
  lineId      String?
  runId       String?
  routingStepId String?
  cleanedAt   DateTime
  cleanedBy   String
  confirmedBy String?
  remark      String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])
  run  Run?  @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])

  @@index([stencilId])
  @@index([lineId])
  @@index([runId])
  @@index([routingStepId])
  @@index([cleanedAt])
}

model SqueegeeUsageRecord {
  id              String   @id @default(cuid())
  squeegeeId      String
  lineId          String?
  runId           String?
  routingStepId   String?
  recordDate      DateTime
  productModel    String?
  squeegeeSpec    String?
  printCount      Int?
  totalPrintCount Int?
  replacedAt      DateTime?
  checkSurface    Boolean?
  checkEdge       Boolean?
  checkFlatness   Boolean?
  usedBy          String?
  confirmedBy     String?
  remark          String?
  lifeLimit       Int?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])
  run  Run?  @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])

  @@index([squeegeeId])
  @@index([lineId])
  @@index([runId])
  @@index([routingStepId])
  @@index([recordDate])
}

model FixtureUsageRecord {
  id              String   @id @default(cuid())
  fixtureId       String
  lineId          String?
  runId           String?
  routingStepId   String?
  recordDate      DateTime
  usageCount      Int?
  totalUsageCount Int?
  usedBy          String?
  confirmedBy     String?
  remark          String?
  lifeLimit       Int?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])
  run  Run?  @relation(fields: [runId], references: [id])
  routingStep RoutingStep? @relation(fields: [routingStepId], references: [id])

  @@index([fixtureId])
  @@index([lineId])
  @@index([runId])
  @@index([routingStepId])
  @@index([recordDate])
}

model EquipmentInspectionRecord {
  id            String   @id @default(cuid())
  lineId        String?
  equipmentType InspectionResultType?
  inspectedAt   DateTime
  machineName   String
  sampleModel   String?
  version       String?
  programName   String?
  result        InspectionResultStatus?
  inspector     String
  remark        String?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])

  @@index([lineId])
  @@index([inspectedAt])
  @@index([machineName])
}

model OvenProgramRecord {
  id          String   @id @default(cuid())
  lineId      String?
  equipmentId String?
  recordDate  DateTime
  productName String
  programName String
  usedBy      String
  confirmedBy String?
  remark      String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])

  @@index([lineId])
  @@index([recordDate])
  @@index([equipmentId])
  @@index([programName])
}

// ==========================================
// Reflow Profile Models (Track D - T2.5/T2.6)
// ==========================================

/// Reflow oven temperature profile definition
/// Represents a standard program with zone temperatures and timing
model ReflowProfile {
  id          String              @id @default(cuid())
  code        String              @unique // Program code/name for matching
  name        String              // Display name
  version     String              @default("1.0") // Version for tracking changes
  description String?
  status      ReflowProfileStatus @default(ACTIVE)

  // Temperature zone configuration (stored as JSON for flexibility)
  // Example: { "zones": [{ "name": "Preheat", "temp": 150, "time": 60 }, ...] }
  zoneConfig Json?

  // Constraints
  peakTempMin   Float? // Minimum peak temperature (°C)
  peakTempMax   Float? // Maximum peak temperature (°C)
  totalTimeMin  Int?   // Minimum total time (seconds)
  totalTimeMax  Int?   // Maximum total time (seconds)

  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usageRecords ReflowProfileUsage[]
  routingSteps RoutingStep[] // Steps expecting this profile

  @@index([status])
}

enum ReflowProfileStatus {
  ACTIVE      // Available for use
  DEPRECATED  // No longer recommended, but allowed
  ARCHIVED    // Not available for new assignments
}

/// Records actual reflow profile usage during production
/// Links a Run to the profile used at the reflow station
model ReflowProfileUsage {
  id        String   @id @default(cuid())
  profileId String
  runId     String?  // Optional: link to Run for traceability
  lineId    String?  // Which line was used
  equipmentId String? // Specific oven equipment ID

  // Actual values recorded (may differ from profile definition)
  actualProgramName String   // Program name as read from equipment
  actualPeakTemp    Float?   // Measured peak temperature
  actualTotalTime   Int?     // Actual cycle time in seconds

  // Verification result
  isMatched Boolean @default(false) // true if actualProgramName matches profile.code
  mismatchReason String? // Reason if not matched

  usedAt    DateTime @default(now())
  usedBy    String?  // Operator ID
  verifiedBy String? // Verifier ID (if manual verification)
  verifiedAt DateTime?

  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile ReflowProfile @relation(fields: [profileId], references: [id])

  @@index([profileId])
  @@index([runId])
  @@index([lineId])
  @@index([usedAt])
}

model DailyQcRecord {
  id              String   @id @default(cuid())
  lineId          String?
  customer        String?
  station         String?
  assemblyNumber  String?
  jobNo           String?
  jobQty          Int?
  shiftCode       String?
  timeWindow      String?
  defectSummary   Json?
  yellowCardNo    String?
  totalParts      Int?
  inspectedQty    Int?
  defectBoardQty  Int?
  defectBoardRate Float?
  defectQty       Int?
  defectRate      Float?
  correctiveAction String?
  inspectedBy     String
  inspectedAt     DateTime
  reviewedBy      String?
  reviewedAt      DateTime?
  remark          String?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])

  @@index([lineId])
  @@index([inspectedAt])
  @@index([jobNo])
}

model ProductionExceptionRecord {
  id             String   @id @default(cuid())
  lineId         String?
  jobNo          String?
  assemblyNumber String?
  revision       String?
  shipDate       DateTime?
  customer       String?
  qty            Int?
  lineNo         String?
  downtimeMinutes Int?
  downtimeRange  String?
  impact         String?
  description    String
  issuedBy       String
  issuedAt       DateTime
  correctiveAction String?
  confirmedBy    String?
  confirmedAt    DateTime?
  remark         String?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  line Line? @relation(fields: [lineId], references: [id])

  @@index([lineId])
  @@index([issuedAt])
  @@index([jobNo])
}

// ==========================================
// Maintenance Records (Phase 3 - Track F)
// ==========================================

enum MaintenanceEntityType {
  FIXTURE       // 夹具
  STENCIL       // 钢网
  SQUEEGEE      // 刮刀
  EQUIPMENT     // 设备
}

enum MaintenanceType {
  REPAIR        // 维修
  CALIBRATION   // 校准
  CLEANING      // 清洁
  REPLACEMENT   // 更换部件
  INSPECTION    // 检查
}

enum MaintenanceStatus {
  PENDING       // 待处理
  IN_PROGRESS   // 进行中
  COMPLETED     // 已完成
  CANCELLED     // 已取消
}

model MaintenanceRecord {
  id              String              @id @default(cuid())
  lineId          String?
  entityType      MaintenanceEntityType
  entityId        String              // fixtureId / stencilId / equipmentId
  entityDisplay   String?             // 实体显示名称
  maintenanceType MaintenanceType
  status          MaintenanceStatus   @default(PENDING)

  // 维修详情
  description     String              // 问题描述
  resolution      String?             // 解决方案
  partsReplaced   String?             // 更换部件
  cost            Float?              // 维修成本

  // 时间记录
  reportedAt      DateTime            // 报修时间
  startedAt       DateTime?           // 开始维修时间
  completedAt     DateTime?           // 完成时间

  // 人员
  reportedBy      String              // 报修人
  assignedTo      String?             // 指派维修人员
  completedBy     String?             // 完成维修人员

  // 审核
  verifiedBy      String?             // 验证人
  verifiedAt      DateTime?           // 验证时间

  remark          String?
  meta            Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  line Line? @relation(fields: [lineId], references: [id])

  @@index([lineId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([reportedAt])
  @@index([completedAt])
}

model StationGroup {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations Station[]
  routingSteps RoutingStep[]
  workCenterMappings WorkCenterStationGroupMapping[]
  executionConfigs RouteExecutionConfig[]
}

model Station {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  lineId      String?
  groupId     String?
  stationType StationType // 站点实际类型
  meta        Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  line          Line?               @relation(fields: [lineId], references: [id])
  group         StationGroup?       @relation(fields: [groupId], references: [id])
  tracks        Track[]
  carrierTracks CarrierTrack[]
  userBindings  UserStationBinding[]
}

model Operation {
  id           String      @id @default(cuid())
  code         String      @unique
  name         String
  defaultType  StationType
  isKeyQuality Boolean     @default(false)
  meta         Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  steps            RoutingStep[]
  dcSpecs          DataCollectionSpec[]
  operationMappings OperationMapping[]
  executionConfigs RouteExecutionConfig[]
}

model OperationMapping {
  id               String   @id @default(cuid())
  sourceSystem     String
  sourceProcessKey String
  sourceProcessName String?
  operationId      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  operation Operation @relation(fields: [operationId], references: [id])

  @@unique([sourceSystem, sourceProcessKey])
  @@index([operationId])
}

model WorkCenterStationGroupMapping {
  id               String   @id @default(cuid())
  sourceSystem     String
  sourceWorkCenter String?
  sourceDepartment String?
  stationGroupId   String?
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])

  @@unique([sourceSystem, sourceWorkCenter, sourceDepartment])
  @@index([sourceSystem, sourceWorkCenter])
  @@index([sourceSystem, sourceDepartment])
}

model Routing {
  id          String   @id @default(cuid())
  code        String   @unique // routing code/version identifier
  name        String
  sourceSystem String  @default("MES")
  sourceKey   String?
  productCode String?
  processType ProcessType @default(SMT)
  effectiveFrom DateTime?
  effectiveTo DateTime?
  version     String?
  isActive    Boolean  @default(true)
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps            RoutingStep[]
  workOrders       WorkOrder[]
  executionConfigs RouteExecutionConfig[]
  routeVersions    ExecutableRouteVersion[]
  oqcSamplingRules OqcSamplingRule[]
  slotMappings     SlotMaterialMapping[]

  @@index([sourceSystem, sourceKey])
}

model RoutingStep {
  id                      String      @id @default(cuid())
  routingId               String
  stepNo                  Int
  sourceStepKey           String?
  operationId             String
  stationGroupId          String?
  stationType             StationType // 推荐执行方式
  isLast                  Boolean     @default(false)
  requiresFAI             Boolean     @default(false)
  expectedReflowProfileId String?     // T2.6: 期望的炉温程式
  meta                    Json?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  routing               Routing        @relation(fields: [routingId], references: [id])
  operation             Operation      @relation(fields: [operationId], references: [id])
  stationGroup          StationGroup?  @relation(fields: [stationGroupId], references: [id])
  expectedReflowProfile ReflowProfile? @relation(fields: [expectedReflowProfileId], references: [id])
  executionConfigs      RouteExecutionConfig[]
  bakeRecords           BakeRecord[]
  solderPasteUsageRecords SolderPasteUsageRecord[]
  stencilUsageRecords   StencilUsageRecord[]
  stencilCleaningRecords StencilCleaningRecord[]
  squeegeeUsageRecords  SqueegeeUsageRecord[]
  fixtureUsageRecords   FixtureUsageRecord[]

  @@unique([routingId, stepNo])
  @@index([routingId])
  @@index([sourceStepKey])
}

model RouteExecutionConfig {
  id                   String      @id @default(cuid())
  routingId            String?
  routingStepId        String?
  sourceStepKey        String?
  operationId          String?
  stationType          StationType?
  stationGroupId       String?
  allowedStationIds    Json?
  requiresFAI          Boolean?
  requiresAuthorization Boolean?
  dataSpecIds          Json?
  ingestMapping        Json?
  meta                 Json?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  routing      Routing?      @relation(fields: [routingId], references: [id])
  routingStep  RoutingStep?  @relation(fields: [routingStepId], references: [id])
  operation    Operation?    @relation(fields: [operationId], references: [id])
  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])

  @@index([routingId])
  @@index([routingStepId])
  @@index([sourceStepKey])
  @@index([operationId])
}

model ExecutableRouteVersion {
  id          String   @id @default(cuid())
  routingId   String
  versionNo   Int
  status      String // READY/INVALID
  snapshotJson Json
  errorsJson  Json?
  compiledAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  routing Routing @relation(fields: [routingId], references: [id])
  runs    Run[]

  @@unique([routingId, versionNo])
  @@index([routingId])
}

model ErpRouteHeaderRaw {
  id          String   @id @default(cuid())
  sourceSystem String
  sourceKey   String
  headId      String?
  payload     Json
  dedupeKey   String?
  pulledAt    DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpRouteLineRaw {
  id          String   @id @default(cuid())
  sourceSystem String
  sourceKey   String
  lineNo      Int?
  payload     Json
  dedupeKey   String?
  pulledAt    DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpWorkOrderRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // woNo
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpMaterialRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // materialCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpBomRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // parentCode_childCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpWorkCenterRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // workCenterCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model Unit {
  id            String     @id @default(cuid())
  sn            String     @unique
  woId          String
  runId         String?
  status        UnitStatus @default(QUEUED)
  currentStepNo Int        @default(1)
  meta          Json?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  workOrder     WorkOrder      @relation(fields: [woId], references: [id])
  run           Run?           @relation(fields: [runId], references: [id])
  tracks        Track[]
  defects       Defect[]
  materialUses  MaterialUse[]
  traceSnapshot TraceSnapshot?
  carrierLoads  CarrierLoad[]
  reworkTasks   ReworkTask[]
}

model Carrier {
  id        String   @id @default(cuid())
  carrierNo String   @unique
  type      String // e.g. "REFLOW_LOT" | "RACK" | "TRAY"
  status    String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  loads  CarrierLoad[]
  tracks CarrierTrack[]
}

model CarrierLoad {
  id         String    @id @default(cuid())
  carrierId  String
  unitId     String
  loadedAt   DateTime  @default(now())
  unloadedAt DateTime?
  meta       Json?

  carrier Carrier @relation(fields: [carrierId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])

  @@unique([carrierId, unitId, loadedAt])
  @@index([carrierId])
  @@index([unitId])
}

model Track {
  id         String       @id @default(cuid())
  unitId     String
  stepNo     Int
  stationId  String?
  source     TrackSource
  inAt       DateTime?
  outAt      DateTime?
  result     TrackResult?
  operatorId String?
  meta       Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  unit       Unit        @relation(fields: [unitId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]
  defects    Defect[]

  @@index([unitId, stepNo])
  @@index([stationId])
}

model CarrierTrack {
  id        String       @id @default(cuid())
  carrierId String
  stepNo    Int
  stationId String?
  source    TrackSource  @default(BATCH)
  inAt      DateTime?
  outAt     DateTime?
  result    TrackResult?
  meta      Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  carrier    Carrier     @relation(fields: [carrierId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]

  @@index([carrierId, stepNo])
}

model PrepCheck {
  id        String   @id @default(cuid())
  runId     String
  type      String // EQUIP/MATERIAL/DOC/QUALIFICATION/...
  status    String // PASS/FAIL
  remark    String?
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId, type])
}

// ==========================================
// Line Readiness Check Models (M2)
// ==========================================

model ReadinessCheck {
  id          String               @id @default(cuid())
  runId       String
  type        ReadinessCheckType   // PRECHECK | FORMAL
  status      ReadinessCheckStatus // PENDING | PASSED | FAILED
  checkedAt   DateTime             @default(now())
  checkedBy   String?              // 执行检查的用户 ID（正式检查时）
  meta        Json?                // 扩展字段
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  run   Run                  @relation(fields: [runId], references: [id])
  items ReadinessCheckItem[]

  @@index([runId])
  @@index([type, status])
}

model ReadinessCheckItem {
  id           String              @id @default(cuid())
  checkId      String
  itemType     ReadinessItemType   // EQUIPMENT | MATERIAL | ROUTE
  itemKey      String              // 具体标识，如设备代码、物料代码
  status       ReadinessItemStatus // PASSED | FAILED | WAIVED
  failReason   String?             // 失败原因
  evidenceJson Json?               // 检查时的证据快照（可选）

  // 豁免信息
  waivedAt     DateTime?
  waivedBy     String?             // 豁免人用户 ID
  waiveReason  String?             // 豁免原因（必填）

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  check ReadinessCheck @relation(fields: [checkId], references: [id])

  @@index([checkId])
  @@index([itemType, status])
}

model Inspection {
  id          String           @id @default(cuid())
  runId       String
  type        InspectionType
  status      InspectionStatus @default(PENDING)
  activeKey   String?          @unique

  // FAI specific fields
  sampleQty   Int?             // Number of samples to inspect (FAI only)
  passedQty   Int?             // Number of passed samples
  failedQty   Int?             // Number of failed samples
  inspectorId String?          // Inspector user ID
  startedAt   DateTime?        // When inspection started

  data        Json?            // Generic data storage for inspection results
  decidedBy   String?
  decidedAt   DateTime?
  remark      String?

  // FAI Signature fields (for run authorization gate)
  signedBy        String?   // User ID who signed off
  signedAt        DateTime? // When signed
  signatureRemark String?   // Optional remark

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  run   Run               @relation(fields: [runId], references: [id])
  items InspectionItem[]  // Detailed inspection items

  @@index([runId, type])
}

model InspectionItem {
  id           String   @id @default(cuid())
  inspectionId String
  unitSn       String?  // For FAI: the sample unit being inspected
  itemName     String   // Inspection item name
  itemSpec     String?  // Specification/standard
  actualValue  String?  // Actual measured value
  result       InspectionItemResult // PASS/FAIL/NA
  defectCode   String?  // Defect code if failed
  remark       String?
  inspectedBy  String?
  inspectedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  inspection Inspection @relation(fields: [inspectionId], references: [id])

  @@index([inspectionId])
  @@index([unitSn])
}

// ==========================================
// OQC Sampling Rules (M2: OQC/MRB)
// ==========================================

model OqcSamplingRule {
  id           String          @id @default(cuid())
  productCode  String?         // Optional: match by product code
  lineId       String?         // Optional: match by line
  routingId    String?         // Optional: match by routing
  samplingType OqcSamplingType
  sampleValue  Float           // Percentage (0-100) or fixed count
  isActive     Boolean         @default(true)
  priority     Int             @default(0) // Higher priority wins
  meta         Json?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  line    Line?    @relation(fields: [lineId], references: [id])
  routing Routing? @relation(fields: [routingId], references: [id])

  @@index([productCode])
  @@index([lineId])
  @@index([routingId])
  @@index([isActive, priority])
}

model Authorization {
  id           String    @id @default(cuid())
  runId        String
  status       String // AUTHORIZED/REVOKED
  authorizedBy String?
  authorizedAt DateTime?
  revokedAt    DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId])
}

model DataCollectionSpec {
  id          String  @id @default(cuid())
  operationId String
  name        String
  itemType    String // KEY/OBSERVATION
  dataType    String // NUMBER/TEXT/BOOLEAN/JSON
  method      String // AUTO/MANUAL
  triggerType String // EVENT/TIME/EACH_UNIT/EACH_CARRIER
  triggerRule Json?
  spec        Json?
  alarm       Json?
  isRequired  Boolean @default(false)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  operation  Operation   @relation(fields: [operationId], references: [id])
  dataValues DataValue[]

  @@unique([operationId, name])
  @@index([operationId, isActive])
}

model DataValue {
  id             String      @id @default(cuid())
  specId         String
  trackId        String?
  carrierTrackId String?
  collectedAt    DateTime    @default(now())
  valueNumber    Float?
  valueText      String?
  valueBoolean   Boolean?
  valueJson      Json?
  judge          String? // PASS/FAIL/NA
  alarmed        Boolean     @default(false)
  source         TrackSource
  meta           Json?

  spec         DataCollectionSpec @relation(fields: [specId], references: [id])
  track        Track?             @relation(fields: [trackId], references: [id])
  carrierTrack CarrierTrack?      @relation(fields: [carrierTrackId], references: [id])

  @@index([specId])
  @@index([trackId])
  @@index([carrierTrackId])
}

model Defect {
  id        String   @id @default(cuid())
  unitId    String
  trackId   String?
  code      String
  location  String?
  qty       Int      @default(1)
  status    String // RECORDED/DISPOSITIONED/CLOSED
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit        Unit         @relation(fields: [unitId], references: [id])
  track       Track?       @relation(fields: [trackId], references: [id])
  disposition Disposition?

  @@index([unitId])
  @@index([code])
}

model Disposition {
  id        String          @id @default(cuid())
  defectId  String          @unique
  type      DispositionType
  decidedBy String?
  decidedAt DateTime?
  reason    String?
  meta      Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  defect     Defect      @relation(fields: [defectId], references: [id])
  reworkTask ReworkTask?
}

model ReworkTask {
  id            String   @id @default(cuid())
  dispositionId String   @unique
  unitId        String
  fromStepNo    Int
  toStepNo      Int
  status        String // OPEN/DONE/CANCELLED
  doneBy        String?
  doneAt        DateTime?
  remark        String?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  disposition Disposition @relation(fields: [dispositionId], references: [id])
  unit        Unit        @relation(fields: [unitId], references: [id])

  @@index([unitId])
}

model MaterialLot {
  id           String    @id @default(cuid())
  materialCode String
  lotNo        String
  supplier     String?
  iqcResult    String?
  iqcDate      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  materialUses   MaterialUse[]
  loadingRecords LoadingRecord[]
  bakeRecords    BakeRecord[]

  @@unique([materialCode, lotNo])
  @@index([materialCode])
}

model MaterialUse {
  id            String   @id @default(cuid())
  unitId        String
  materialLotId String
  position      String?
  isKeyPart     Boolean  @default(false)
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  unit        Unit        @relation(fields: [unitId], references: [id])
  materialLot MaterialLot @relation(fields: [materialLotId], references: [id])

  @@index([unitId])
  @@index([materialLotId])
  @@index([position])
}

model Material {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  category        String?
  unit            String?
  model           String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
}

model BomItem {
  id              String   @id @default(cuid())
  parentCode      String
  childCode       String
  qty             Float
  unit            String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([parentCode, childCode])
  @@index([parentCode])
}

model WorkCenter {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  departmentCode  String?
  departmentName  String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([departmentCode])
}

model TpmEquipment {
  id             String   @id @default(cuid())
  equipmentCode  String   @unique
  name           String
  status         String
  workshopCode   String?
  location       String?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
}

model TpmStatusLog {
  id             String   @id @default(cuid())
  equipmentCode  String
  status         String
  reason         String?
  startedAt      DateTime
  endedAt        DateTime?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([equipmentCode, startedAt])
  @@index([equipmentCode])
}

model TpmMaintenanceTask {
  id             String   @id @default(cuid())
  taskNo         String   @unique
  equipmentCode  String
  type           String
  status         String
  scheduledDate  DateTime?
  startTime      DateTime?
  completedAt    DateTime?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([equipmentCode, status])
}

model TraceSnapshot {
  id          String   @id @default(cuid())
  unitId      String   @unique
  snapshot    Json
  generatedAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id])
}

model AuditEvent {
  id             String          @id @default(cuid())
  entityType     AuditEntityType
  entityId       String
  entityDisplay  String?
  action         String          @map("eventType")
  actorId        String?
  actorName      String?
  actorRole      String?
  actorType      String?
  stationId      String?
  status         String
  errorCode      String?
  errorMessage   String?
  diff           Json?
  requestId      String?
  ip             String?
  userAgent      String?
  traceId        String?
  createdAt      DateTime        @default(now()) @map("at")
  idempotencyKey String?
  payload        Json?

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model AuditArchive {
  id         String   @id @default(cuid())
  filePath   String
  rangeStart DateTime
  rangeEnd   DateTime
  rowCount   Int
  checksum   String
  createdAt  DateTime @default(now())

  @@index([rangeStart, rangeEnd])
  @@map("audit_archives")
}

model IntegrationMessage {
  id          String   @id @default(cuid())
  direction   String // IN/OUT
  system      String // ERP/APS/TEST/EQUIP/...
  entityType  String  @default("UNKNOWN") // ROUTING/WORK_ORDER/...
  businessKey String
  dedupeKey   String?
  status      String // NEW/SUCCESS/FAILED/RETRYING
  payload     Json
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([direction, system])
  @@index([system, entityType])
  @@index([businessKey])
  @@index([dedupeKey])
}

model IntegrationSyncCursor {
  id          String   @id @default(cuid())
  sourceSystem String
  entityType  String
  lastSyncAt  DateTime?
  lastSeq     String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sourceSystem, entityType])
}

// ==========================================
// RBAC (Role-Based Access Control) Models
// ==========================================

enum RoleDataScope {
  ALL               // Access all data
  ASSIGNED_LINES    // Access only assigned production lines
  ASSIGNED_STATIONS // Access only assigned stations
}

model Role {
  id          String        @id @default(cuid())
  code        String        @unique
  name        String
  description String?
  permissions String        // JSON array of permission strings
  dataScope   RoleDataScope @default(ALL)
  isSystem    Boolean       @default(false) // System preset roles cannot be deleted
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  userRoles UserRoleAssignment[]

  @@map("roles")
}

model UserRoleAssignment {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_role_assignments")
}

model UserLineBinding {
  id        String   @id @default(cuid())
  userId    String
  lineId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  line Line @relation(fields: [lineId], references: [id], onDelete: Cascade)

  @@unique([userId, lineId])
  @@index([userId])
  @@index([lineId])
  @@map("user_line_bindings")
}

model UserStationBinding {
  id        String   @id @default(cuid())
  userId    String
  stationId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([userId, stationId])
  @@index([userId])
  @@index([stationId])
  @@map("user_station_bindings")
}

// ==========================================
// Inspection Result Record (SPI/AOI Integration)
// ==========================================

model InspectionResultRecord {
  id             String                  @id @default(cuid())
  eventId        String                  @unique
  eventTime      DateTime
  runNo          String
  stationCode    String
  unitSn         String
  stepNo         Int
  inspectionType InspectionResultType
  result         InspectionResultStatus
  defects        Json?
  rawData        Json?
  source         IntegrationSource
  equipmentId    String?
  operatorId     String?
  trackId        String?
  defectIds      Json?
  receivedAt     DateTime                @default(now())
  meta           Json?

  @@index([runNo])
  @@index([unitSn])
  @@index([stationCode])
  @@index([eventTime])
  @@index([inspectionType, result])
}

// ==========================================
// Time Rule Models (SMT Gap Phase 2)
// ==========================================

enum MesEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model MesEvent {
  id              String         @id @default(cuid())
  eventType       String
  status          MesEventStatus @default(PENDING)
  attempts        Int            @default(0)
  maxAttempts     Int            @default(10)
  nextAttemptAt   DateTime?
  processedAt     DateTime?
  occurredAt      DateTime?
  idempotencyKey  String?        @unique

  entityType      String?
  entityId        String?
  runId           String?

  errorCode       String?
  errorMessage    String?
  payload         Json?
  retentionUntil  DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status, nextAttemptAt])
  @@index([eventType])
  @@index([runId])
  @@index([entityType, entityId])
  @@index([retentionUntil])
  @@map("mes_events")
}

model TimeRuleDefinition {
  id              String          @id @default(cuid())
  code            String          @unique  // "SOLDER_PASTE_24H"
  name            String                   // "锡膏暴露时间限制"
  description     String?
  ruleType        TimeRuleType

  durationMinutes Int                      // 时限（分钟）
  warningMinutes  Int?                     // 预警时间（提前多少分钟预警）

  startEvent      String                   // "PASTE_ISSUED"
  endEvent        String                   // "PASTE_CONSUMED"

  scope           TimeRuleScope  @default(GLOBAL)
  scopeValue      String?                  // 具体 ID（产线/路由/产品）

  requiresWashStep Boolean      @default(false)  // 是否需要水洗工序才生效
  isWaivable      Boolean       @default(true)   // 是否可豁免
  isActive        Boolean       @default(true)   // 是否启用
  priority        Int           @default(0)      // 优先级（用于冲突时选择）

  meta            Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  instances       TimeRuleInstance[]

  @@map("time_rule_definitions")
}

model TimeRuleInstance {
  id              String                   @id @default(cuid())
  definitionId    String

  runId           String?                  // 关联的 Run（可选）
  entityType      String                   // "SOLDER_PASTE_LOT" | "UNIT"
  entityId        String                   // 实体 ID
  entityDisplay   String?                  // 显示名称（如锡膏批号）
  activeKey       String?        @unique  // ACTIVE uniqueness guard (definitionId:entityType:entityId)

  startedAt       DateTime                 // 计时开始时间
  expiresAt       DateTime                 // 过期时间
  warningAt       DateTime?                // 预警时间

  status          TimeRuleInstanceStatus   @default(ACTIVE)
  completedAt     DateTime?                // 完成时间
  expiredAt       DateTime?                // 超时时间

  waivedAt        DateTime?                // 豁免时间
  waivedBy        String?                  // 豁免人
  waiveReason     String?                  // 豁免原因

  readinessItemId String?                  // 关联的 ReadinessCheckItem（超时时创建）
  warningNotified Boolean       @default(false)  // 是否已发送预警通知
  expiryNotified  Boolean       @default(false)  // 是否已发送超时通知

  meta            Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  definition      TimeRuleDefinition @relation(fields: [definitionId], references: [id])
  run             Run?          @relation(fields: [runId], references: [id])

  @@index([status])
  @@index([expiresAt])
  @@index([runId])
  @@index([entityType, entityId])
  @@map("time_rule_instances")
}
