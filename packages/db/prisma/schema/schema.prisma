generator client {
  provider     = "prisma-client-js"
  output       = "../generated/client"
  moduleFormat = "esm"
  runtime      = "bun"
}

generator prismabox {
  provider                    = "prismabox"
  typeboxImportDependencyName = "elysia"
  typeboxImportVariableName   = "t"
  inputModel                  = true
  output                      = "../generated/prismabox"
}

datasource db {
  provider = "sqlite"
}

// ==========================================
// Existing Models (User, Auth, Instrument)
// ==========================================

enum UserRole {
  admin
  supervisor
  workshop_supervisor
  technician
  operator
}

enum CalibrationType {
  internal
  external
}

enum NotificationStatus {
  unread
  read
}

enum NotificationPriority {
  low
  normal
  high
}

model User {
  id                      String   @id @default(cuid())
  username                String?  @unique
  passwordHash            String?
  name                    String
  email                   String   @unique
  emailVerified           Boolean  @default(false)
  role                    UserRole @default(operator) // Legacy field, will be deprecated
  department              String?
  phone                   String?
  isActive                Boolean  @default(true)
  enableWecomNotification Boolean  @default(true)
  image                   String?
  preferredHomePage       String?  // User's preferred home page
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  sessions                   Session[]
  accounts                   Account[]
  ownedInstruments           Instrument[]
  calibrationRecordsOperated CalibrationRecord[] @relation("CalibrationOperator")
  calibrationRecordsCreated  CalibrationRecord[] @relation("CalibrationCreatedBy")
  notifications              Notification[]
  systemLogs                 SystemLog[]
  
  // New RBAC relations
  userRoles              UserRoleAssignment[]
  lineBindings           UserLineBinding[]
  stationBindings        UserStationBinding[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Instrument {
  id           String  @id @default(cuid())
  instrumentNo String  @unique
  manufacturer String?
  model        String?
  description  String?
  serialNo     String?
  department   String?

  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  lastCalibrationDate DateTime?
  intervalDays        Int?
  reminderDays        Int?
  calibrationType     CalibrationType?
  nextCalibrationDate DateTime?

  remarks String?
  status  String?

  calibrationRecords CalibrationRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nextCalibrationDate])
  @@map("instruments")
}

model CalibrationRecord {
  id String @id @default(cuid())

  instrumentId String
  instrument   Instrument @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  calibrationType     CalibrationType
  performedAt         DateTime
  nextCalibrationDate DateTime?

  result         String?
  certificateNo  String?
  certificateUrl String?
  attachments    Json
  providerName   String?

  operatorId String?
  operator   User?   @relation("CalibrationOperator", fields: [operatorId], references: [id])

  createdById String?
  createdBy   User?   @relation("CalibrationCreatedBy", fields: [createdById], references: [id])

  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([instrumentId, certificateNo])
  @@index([instrumentId, performedAt(sort: Desc)])
  @@map("calibration_records")
}

model Notification {
  id          String @id @default(cuid())
  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id])

  type     String
  title    String
  message  String
  status   NotificationStatus
  priority NotificationPriority?
  data     Json?

  wecomSent   Boolean?
  wecomSentAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, status])
  @@map("notifications")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  /// SystemConfig value 取决于 key，暂保留为 Record 类型
  value     Json
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model SystemLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action    String
  module    String?
  /// SystemLog details 是通用日志结构
  details   Json?
  ip        String?
  userAgent String?
  status    String?

  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@map("system_logs")
}

// ==========================================
// MES Domain Models
// ==========================================

enum WorkOrderStatus {
  RECEIVED
  RELEASED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

enum RunStatus {
  PREP
  FAI_PENDING
  AUTHORIZED
  RUNNING
  FINISHING
  ARCHIVED
  CANCELLED
}

enum StationType {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum UnitStatus {
  QUEUED
  IN_STATION
  OUT_PASSED
  OUT_FAILED
  REWORK
  HOLD
  SCRAPPED
  DONE
}

enum TrackResult {
  PASS
  FAIL
}

enum TrackSource {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum InspectionType {
  FAI
  IPQC
  FQC
  OQC
}

enum InspectionStatus {
  PENDING
  INSPECTING
  PASS
  FAIL
  CANCELLED
}

enum DispositionType {
  REWORK
  SCRAP
  HOLD
}

// ==========================================
// Line Readiness Check Enums (M2)
// ==========================================

enum ReadinessCheckType {
  PRECHECK  // 预检（异步，仅提示）
  FORMAL    // 正式检查（同步，阻断式）
}

enum ReadinessCheckStatus {
  PENDING   // 检查中
  PASSED    // 全部通过
  FAILED    // 有失败项
}

enum ReadinessItemType {
  EQUIPMENT // 设备状态
  MATERIAL  // 物料主数据
  ROUTE     // 工艺路线
}

enum ReadinessItemStatus {
  PASSED    // 通过
  FAILED    // 失败
  WAIVED    // 已豁免
}

enum AuditEntityType {
  WORK_ORDER
  RUN
  UNIT
  TRACK
  INSPECTION
  DEFECT
  DISPOSITION
  DATA_VALUE
  MATERIAL_USE
  INTEGRATION
  INSTRUMENT
  CALIBRATION
  USER
  SYSTEM_CONFIG
  NOTIFICATION
  SYSTEM
  READINESS_CHECK // M2: Line Readiness Check audit
}

model WorkOrder {
  id            String          @id @default(cuid())
  woNo          String          @unique
  productCode   String
  plannedQty    Int
  routingId     String?
  status        WorkOrderStatus @default(RECEIVED)
  erpStatus     String?         // ERP 业务状态 (FStatus)
  erpPickStatus String?         // ERP 领料状态 (FPickMtrlStatus)
  pickStatus    String?         // MES 领料状态 (手动工单用)
  dueDate       DateTime?
  meta          Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  routing Routing? @relation(fields: [routingId], references: [id])
  runs    Run[]
  units   Unit[]
}

model Run {
  id           String    @id @default(cuid())
  runNo        String    @unique
  woId         String
  lineId       String?
  routeVersionId String?
  status       RunStatus @default(PREP)
  shiftCode    String?
  changeoverNo String? // 换线/开班标识
  startedAt    DateTime?
  endedAt      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workOrder        WorkOrder       @relation(fields: [woId], references: [id])
  line             Line?           @relation(fields: [lineId], references: [id])
  routeVersion     ExecutableRouteVersion? @relation(fields: [routeVersionId], references: [id])
  prepChecks       PrepCheck[]
  readinessChecks  ReadinessCheck[]  // M2: Line Readiness Check
  inspections      Inspection[] // 用 Inspection 统一承载 FAI/IPQC/FQC/OQC
  authorizations   Authorization[]
  units            Unit[]
}

model Line {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations     Station[]
  runs         Run[]
  userBindings UserLineBinding[]
}

model StationGroup {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations Station[]
  routingSteps RoutingStep[]
  workCenterMappings WorkCenterStationGroupMapping[]
  executionConfigs RouteExecutionConfig[]
}

model Station {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  lineId      String?
  groupId     String?
  stationType StationType // 站点实际类型
  meta        Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  line          Line?               @relation(fields: [lineId], references: [id])
  group         StationGroup?       @relation(fields: [groupId], references: [id])
  tracks        Track[]
  carrierTracks CarrierTrack[]
  userBindings  UserStationBinding[]
}

model Operation {
  id           String      @id @default(cuid())
  code         String      @unique
  name         String
  defaultType  StationType
  isKeyQuality Boolean     @default(false)
  meta         Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  steps            RoutingStep[]
  dcSpecs          DataCollectionSpec[]
  operationMappings OperationMapping[]
  executionConfigs RouteExecutionConfig[]
}

model OperationMapping {
  id               String   @id @default(cuid())
  sourceSystem     String
  sourceProcessKey String
  sourceProcessName String?
  operationId      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  operation Operation @relation(fields: [operationId], references: [id])

  @@unique([sourceSystem, sourceProcessKey])
  @@index([operationId])
}

model WorkCenterStationGroupMapping {
  id               String   @id @default(cuid())
  sourceSystem     String
  sourceWorkCenter String?
  sourceDepartment String?
  stationGroupId   String?
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])

  @@unique([sourceSystem, sourceWorkCenter, sourceDepartment])
  @@index([sourceSystem, sourceWorkCenter])
  @@index([sourceSystem, sourceDepartment])
}

model Routing {
  id          String   @id @default(cuid())
  code        String   @unique // routing code/version identifier
  name        String
  sourceSystem String  @default("MES")
  sourceKey   String?
  productCode String?
  effectiveFrom DateTime?
  effectiveTo DateTime?
  version     String?
  isActive    Boolean  @default(true)
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps            RoutingStep[]
  workOrders       WorkOrder[]
  executionConfigs RouteExecutionConfig[]
  routeVersions    ExecutableRouteVersion[]

  @@index([sourceSystem, sourceKey])
}

model RoutingStep {
  id             String      @id @default(cuid())
  routingId      String
  stepNo         Int
  sourceStepKey  String?
  operationId    String
  stationGroupId String?
  stationType    StationType // 推荐执行方式
  isLast         Boolean     @default(false)
  requiresFAI    Boolean     @default(false)
  meta           Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  routing      Routing       @relation(fields: [routingId], references: [id])
  operation    Operation     @relation(fields: [operationId], references: [id])
  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])
  executionConfigs RouteExecutionConfig[]

  @@unique([routingId, stepNo])
  @@index([routingId])
  @@index([sourceStepKey])
}

model RouteExecutionConfig {
  id                   String      @id @default(cuid())
  routingId            String?
  routingStepId        String?
  sourceStepKey        String?
  operationId          String?
  stationType          StationType?
  stationGroupId       String?
  allowedStationIds    Json?
  requiresFAI          Boolean?
  requiresAuthorization Boolean?
  dataSpecIds          Json?
  ingestMapping        Json?
  meta                 Json?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  routing      Routing?      @relation(fields: [routingId], references: [id])
  routingStep  RoutingStep?  @relation(fields: [routingStepId], references: [id])
  operation    Operation?    @relation(fields: [operationId], references: [id])
  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])

  @@index([routingId])
  @@index([routingStepId])
  @@index([sourceStepKey])
  @@index([operationId])
}

model ExecutableRouteVersion {
  id          String   @id @default(cuid())
  routingId   String
  versionNo   Int
  status      String // READY/INVALID
  snapshotJson Json
  errorsJson  Json?
  compiledAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  routing Routing @relation(fields: [routingId], references: [id])
  runs    Run[]

  @@unique([routingId, versionNo])
  @@index([routingId])
}

model ErpRouteHeaderRaw {
  id          String   @id @default(cuid())
  sourceSystem String
  sourceKey   String
  headId      String?
  payload     Json
  dedupeKey   String?
  pulledAt    DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpRouteLineRaw {
  id          String   @id @default(cuid())
  sourceSystem String
  sourceKey   String
  lineNo      Int?
  payload     Json
  dedupeKey   String?
  pulledAt    DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpWorkOrderRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // woNo
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpMaterialRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // materialCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpBomRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // parentCode_childCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model ErpWorkCenterRaw {
  id           String   @id @default(cuid())
  sourceSystem String
  sourceKey    String   // workCenterCode
  payload      Json
  dedupeKey    String?
  pulledAt     DateTime @default(now())

  @@index([sourceSystem, sourceKey])
  @@index([dedupeKey])
}

model Unit {
  id            String     @id @default(cuid())
  sn            String     @unique
  woId          String
  runId         String?
  status        UnitStatus @default(QUEUED)
  currentStepNo Int        @default(1)
  meta          Json?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  workOrder     WorkOrder      @relation(fields: [woId], references: [id])
  run           Run?           @relation(fields: [runId], references: [id])
  tracks        Track[]
  defects       Defect[]
  materialUses  MaterialUse[]
  traceSnapshot TraceSnapshot?
  carrierLoads  CarrierLoad[]
  reworkTasks   ReworkTask[]
}

model Carrier {
  id        String   @id @default(cuid())
  carrierNo String   @unique
  type      String // e.g. "REFLOW_LOT" | "RACK" | "TRAY"
  status    String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  loads  CarrierLoad[]
  tracks CarrierTrack[]
}

model CarrierLoad {
  id         String    @id @default(cuid())
  carrierId  String
  unitId     String
  loadedAt   DateTime  @default(now())
  unloadedAt DateTime?
  meta       Json?

  carrier Carrier @relation(fields: [carrierId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])

  @@unique([carrierId, unitId, loadedAt])
  @@index([carrierId])
  @@index([unitId])
}

model Track {
  id         String       @id @default(cuid())
  unitId     String
  stepNo     Int
  stationId  String?
  source     TrackSource
  inAt       DateTime?
  outAt      DateTime?
  result     TrackResult?
  operatorId String?
  meta       Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  unit       Unit        @relation(fields: [unitId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]
  defects    Defect[]

  @@index([unitId, stepNo])
  @@index([stationId])
}

model CarrierTrack {
  id        String       @id @default(cuid())
  carrierId String
  stepNo    Int
  stationId String?
  source    TrackSource  @default(BATCH)
  inAt      DateTime?
  outAt     DateTime?
  result    TrackResult?
  meta      Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  carrier    Carrier     @relation(fields: [carrierId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]

  @@index([carrierId, stepNo])
}

model PrepCheck {
  id        String   @id @default(cuid())
  runId     String
  type      String // EQUIP/MATERIAL/DOC/QUALIFICATION/...
  status    String // PASS/FAIL
  remark    String?
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId, type])
}

// ==========================================
// Line Readiness Check Models (M2)
// ==========================================

model ReadinessCheck {
  id          String               @id @default(cuid())
  runId       String
  type        ReadinessCheckType   // PRECHECK | FORMAL
  status      ReadinessCheckStatus // PENDING | PASSED | FAILED
  checkedAt   DateTime             @default(now())
  checkedBy   String?              // 执行检查的用户 ID（正式检查时）
  meta        Json?                // 扩展字段
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  run   Run                  @relation(fields: [runId], references: [id])
  items ReadinessCheckItem[]

  @@index([runId])
  @@index([type, status])
}

model ReadinessCheckItem {
  id           String              @id @default(cuid())
  checkId      String
  itemType     ReadinessItemType   // EQUIPMENT | MATERIAL | ROUTE
  itemKey      String              // 具体标识，如设备代码、物料代码
  status       ReadinessItemStatus // PASSED | FAILED | WAIVED
  failReason   String?             // 失败原因
  evidenceJson Json?               // 检查时的证据快照（可选）

  // 豁免信息
  waivedAt     DateTime?
  waivedBy     String?             // 豁免人用户 ID
  waiveReason  String?             // 豁免原因（必填）

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  check ReadinessCheck @relation(fields: [checkId], references: [id])

  @@index([checkId])
  @@index([itemType, status])
}

model Inspection {
  id          String           @id @default(cuid())
  runId       String
  type        InspectionType
  status      InspectionStatus @default(PENDING)

  // FAI specific fields
  sampleQty   Int?             // Number of samples to inspect (FAI only)
  passedQty   Int?             // Number of passed samples
  failedQty   Int?             // Number of failed samples
  inspectorId String?          // Inspector user ID
  startedAt   DateTime?        // When inspection started

  data        Json?            // Generic data storage for inspection results
  decidedBy   String?
  decidedAt   DateTime?
  remark      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  run   Run               @relation(fields: [runId], references: [id])
  items InspectionItem[]  // Detailed inspection items

  @@index([runId, type])
}

model InspectionItem {
  id           String   @id @default(cuid())
  inspectionId String
  unitSn       String?  // For FAI: the sample unit being inspected
  itemName     String   // Inspection item name
  itemSpec     String?  // Specification/standard
  actualValue  String?  // Actual measured value
  result       String?  // PASS/FAIL/NA
  defectCode   String?  // Defect code if failed
  remark       String?
  inspectedBy  String?
  inspectedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  inspection Inspection @relation(fields: [inspectionId], references: [id])

  @@index([inspectionId])
  @@index([unitSn])
}

model Authorization {
  id           String    @id @default(cuid())
  runId        String
  status       String // AUTHORIZED/REVOKED
  authorizedBy String?
  authorizedAt DateTime?
  revokedAt    DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId])
}

model DataCollectionSpec {
  id          String  @id @default(cuid())
  operationId String
  name        String
  itemType    String // KEY/OBSERVATION
  dataType    String // NUMBER/TEXT/BOOLEAN/JSON
  method      String // AUTO/MANUAL
  triggerType String // EVENT/TIME/EACH_UNIT/EACH_CARRIER
  triggerRule Json?
  spec        Json?
  alarm       Json?
  isRequired  Boolean @default(false)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  operation  Operation   @relation(fields: [operationId], references: [id])
  dataValues DataValue[]

  @@index([operationId])
}

model DataValue {
  id             String      @id @default(cuid())
  specId         String
  trackId        String?
  carrierTrackId String?
  collectedAt    DateTime    @default(now())
  valueNumber    Float?
  valueText      String?
  valueBoolean   Boolean?
  valueJson      Json?
  judge          String? // PASS/FAIL/NA
  alarmed        Boolean     @default(false)
  source         TrackSource
  meta           Json?

  spec         DataCollectionSpec @relation(fields: [specId], references: [id])
  track        Track?             @relation(fields: [trackId], references: [id])
  carrierTrack CarrierTrack?      @relation(fields: [carrierTrackId], references: [id])

  @@index([specId])
  @@index([trackId])
  @@index([carrierTrackId])
}

model Defect {
  id        String   @id @default(cuid())
  unitId    String
  trackId   String?
  code      String
  location  String?
  qty       Int      @default(1)
  status    String // RECORDED/DISPOSITIONED/CLOSED
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit        Unit         @relation(fields: [unitId], references: [id])
  track       Track?       @relation(fields: [trackId], references: [id])
  disposition Disposition?

  @@index([unitId])
  @@index([code])
}

model Disposition {
  id        String          @id @default(cuid())
  defectId  String          @unique
  type      DispositionType
  decidedBy String?
  decidedAt DateTime?
  reason    String?
  meta      Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  defect     Defect      @relation(fields: [defectId], references: [id])
  reworkTask ReworkTask?
}

model ReworkTask {
  id            String   @id @default(cuid())
  dispositionId String   @unique
  unitId        String
  fromStepNo    Int
  toStepNo      Int
  status        String // OPEN/DONE/CANCELLED
  doneBy        String?
  doneAt        DateTime?
  remark        String?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  disposition Disposition @relation(fields: [dispositionId], references: [id])
  unit        Unit        @relation(fields: [unitId], references: [id])

  @@index([unitId])
}

model MaterialLot {
  id           String    @id @default(cuid())
  materialCode String
  lotNo        String
  supplier     String?
  iqcResult    String?
  iqcDate      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  materialUses MaterialUse[]

  @@unique([materialCode, lotNo])
  @@index([materialCode])
}

model MaterialUse {
  id            String   @id @default(cuid())
  unitId        String
  materialLotId String
  position      String?
  isKeyPart     Boolean  @default(false)
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  unit        Unit        @relation(fields: [unitId], references: [id])
  materialLot MaterialLot @relation(fields: [materialLotId], references: [id])

  @@index([unitId])
  @@index([materialLotId])
  @@index([position])
}

model Material {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  category        String?
  unit            String?
  model           String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
}

model BomItem {
  id              String   @id @default(cuid())
  parentCode      String
  childCode       String
  qty             Float
  unit            String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([parentCode, childCode])
  @@index([parentCode])
}

model WorkCenter {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  departmentCode  String?
  departmentName  String?
  sourceUpdatedAt DateTime?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([departmentCode])
}

model TpmEquipment {
  id             String   @id @default(cuid())
  equipmentCode  String   @unique
  name           String
  status         String
  workshopCode   String?
  location       String?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
}

model TpmStatusLog {
  id             String   @id @default(cuid())
  equipmentCode  String
  status         String
  reason         String?
  startedAt      DateTime
  endedAt        DateTime?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([equipmentCode, startedAt])
  @@index([equipmentCode])
}

model TpmMaintenanceTask {
  id             String   @id @default(cuid())
  taskNo         String   @unique
  equipmentCode  String
  type           String
  status         String
  scheduledDate  DateTime?
  startTime      DateTime?
  completedAt    DateTime?
  sourceUpdatedAt DateTime?
  meta           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([equipmentCode, status])
}

model TraceSnapshot {
  id          String   @id @default(cuid())
  unitId      String   @unique
  snapshot    Json
  generatedAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id])
}

model AuditEvent {
  id             String          @id @default(cuid())
  entityType     AuditEntityType
  entityId       String
  entityDisplay  String?
  action         String          @map("eventType")
  actorId        String?
  actorName      String?
  actorRole      String?
  actorType      String?
  stationId      String?
  status         String
  errorCode      String?
  errorMessage   String?
  diff           Json?
  requestId      String?
  ip             String?
  userAgent      String?
  traceId        String?
  createdAt      DateTime        @default(now()) @map("at")
  idempotencyKey String?
  payload        Json?

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model AuditArchive {
  id         String   @id @default(cuid())
  filePath   String
  rangeStart DateTime
  rangeEnd   DateTime
  rowCount   Int
  checksum   String
  createdAt  DateTime @default(now())

  @@index([rangeStart, rangeEnd])
  @@map("audit_archives")
}

model IntegrationMessage {
  id          String   @id @default(cuid())
  direction   String // IN/OUT
  system      String // ERP/APS/TEST/EQUIP/...
  entityType  String  @default("UNKNOWN") // ROUTING/WORK_ORDER/...
  businessKey String
  dedupeKey   String?
  status      String // NEW/SUCCESS/FAILED/RETRYING
  payload     Json
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([direction, system])
  @@index([system, entityType])
  @@index([businessKey])
  @@index([dedupeKey])
}

model IntegrationSyncCursor {
  id          String   @id @default(cuid())
  sourceSystem String
  entityType  String
  lastSyncAt  DateTime?
  lastSeq     String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sourceSystem, entityType])
}

// ==========================================
// RBAC (Role-Based Access Control) Models
// ==========================================

enum RoleDataScope {
  ALL               // Access all data
  ASSIGNED_LINES    // Access only assigned production lines
  ASSIGNED_STATIONS // Access only assigned stations
}

model Role {
  id          String        @id @default(cuid())
  code        String        @unique
  name        String
  description String?
  permissions String        // JSON array of permission strings
  dataScope   RoleDataScope @default(ALL)
  isSystem    Boolean       @default(false) // System preset roles cannot be deleted
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  userRoles UserRoleAssignment[]

  @@map("roles")
}

model UserRoleAssignment {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_role_assignments")
}

model UserLineBinding {
  id        String   @id @default(cuid())
  userId    String
  lineId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  line Line @relation(fields: [lineId], references: [id], onDelete: Cascade)

  @@unique([userId, lineId])
  @@index([userId])
  @@index([lineId])
  @@map("user_line_bindings")
}

model UserStationBinding {
  id        String   @id @default(cuid())
  userId    String
  stationId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([userId, stationId])
  @@index([userId])
  @@index([stationId])
  @@map("user_station_bindings")
}
