generator client {
  provider     = "prisma-client-js"
  output       = "../generated/client"
  moduleFormat = "esm"
  runtime      = "bun"
}

generator prismabox {
  provider                    = "prismabox"
  typeboxImportDependencyName = "elysia"
  typeboxImportVariableName   = "t"
  inputModel                  = true
  output                      = "../generated/prismabox"
}

datasource db {
  provider = "sqlite"
}

// ==========================================
// Existing Models (User, Auth, Instrument)
// ==========================================

enum UserRole {
  admin
  supervisor
  workshop_supervisor
  technician
  operator
}

enum CalibrationType {
  internal
  external
}

enum NotificationStatus {
  unread
  read
}

enum NotificationPriority {
  low
  normal
  high
}

model User {
  id                      String   @id @default(cuid())
  username                String?  @unique
  passwordHash            String?
  name                    String
  email                   String   @unique
  emailVerified           Boolean  @default(false)
  role                    UserRole @default(operator)
  department              String?
  phone                   String?
  isActive                Boolean  @default(true)
  enableWecomNotification Boolean  @default(true)
  image                   String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  sessions                   Session[]
  accounts                   Account[]
  ownedInstruments           Instrument[]
  calibrationRecordsOperated CalibrationRecord[] @relation("CalibrationOperator")
  calibrationRecordsCreated  CalibrationRecord[] @relation("CalibrationCreatedBy")
  notifications              Notification[]
  systemLogs                 SystemLog[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Instrument {
  id           String  @id @default(cuid())
  instrumentNo String  @unique
  manufacturer String?
  model        String?
  description  String?
  serialNo     String?
  department   String?

  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  lastCalibrationDate DateTime?
  intervalDays        Int?
  reminderDays        Int?
  calibrationType     CalibrationType?
  nextCalibrationDate DateTime?

  remarks String?
  status  String?

  calibrationRecords CalibrationRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nextCalibrationDate])
  @@map("instruments")
}

model CalibrationRecord {
  id String @id @default(cuid())

  instrumentId String
  instrument   Instrument @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  calibrationType     CalibrationType
  performedAt         DateTime
  nextCalibrationDate DateTime?

  result         String?
  certificateNo  String?
  certificateUrl String?
  attachments    Json
  providerName   String?

  operatorId String?
  operator   User?   @relation("CalibrationOperator", fields: [operatorId], references: [id])

  createdById String?
  createdBy   User?   @relation("CalibrationCreatedBy", fields: [createdById], references: [id])

  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([instrumentId, certificateNo])
  @@index([instrumentId, performedAt(sort: Desc)])
  @@map("calibration_records")
}

model Notification {
  id          String @id @default(cuid())
  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id])

  type     String
  title    String
  message  String
  status   NotificationStatus
  priority NotificationPriority?
  data     Json?

  wecomSent   Boolean?
  wecomSentAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, status])
  @@map("notifications")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  /// SystemConfig value 取决于 key，暂保留为 Record 类型
  value     Json
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model SystemLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action    String
  module    String?
  /// SystemLog details 是通用日志结构
  details   Json?
  ip        String?
  userAgent String?
  status    String?

  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@map("system_logs")
}

// ==========================================
// MES Domain Models
// ==========================================

enum WorkOrderStatus {
  RECEIVED
  RELEASED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

enum RunStatus {
  PREP
  FAI_PENDING
  AUTHORIZED
  RUNNING
  FINISHING
  ARCHIVED
  CANCELLED
}

enum StationType {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum UnitStatus {
  QUEUED
  IN_STATION
  OUT_PASSED
  OUT_FAILED
  REWORK
  HOLD
  SCRAPPED
  DONE
}

enum TrackResult {
  PASS
  FAIL
}

enum TrackSource {
  MANUAL
  AUTO
  BATCH
  TEST
}

enum InspectionType {
  FAI
  IPQC
  FQC
  OQC
}

enum InspectionStatus {
  PENDING
  INSPECTING
  PASS
  FAIL
  CANCELLED
}

enum DispositionType {
  REWORK
  SCRAP
  HOLD
}

enum AuditEntityType {
  WORK_ORDER
  RUN
  UNIT
  TRACK
  INSPECTION
  DEFECT
  DISPOSITION
  DATA_VALUE
  MATERIAL_USE
  INTEGRATION
}

model WorkOrder {
  id           String          @id @default(cuid())
  woNo         String          @unique
  productCode  String
  plannedQty   Int
  routingId    String?
  status       WorkOrderStatus @default(RECEIVED)
  reviewStatus String? // e.g. "REVIEWED" | "UNREVIEWED"
  dueDate      DateTime?
  meta         Json?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  routing Routing? @relation(fields: [routingId], references: [id])
  runs    Run[]
  units   Unit[]
}

model Run {
  id           String    @id @default(cuid())
  runNo        String    @unique
  woId         String
  lineId       String?
  status       RunStatus @default(PREP)
  shiftCode    String?
  changeoverNo String? // 换线/开班标识
  startedAt    DateTime?
  endedAt      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workOrder      WorkOrder       @relation(fields: [woId], references: [id])
  line           Line?           @relation(fields: [lineId], references: [id])
  prepChecks     PrepCheck[]
  inspections    Inspection[] // 用 Inspection 统一承载 FAI/IPQC/FQC/OQC
  authorizations Authorization[]
  units          Unit[]
}

model Line {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations Station[]
  runs     Run[]
}

model StationGroup {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations Station[]
  routingSteps RoutingStep[]
}

model Station {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  lineId      String?
  groupId     String?
  stationType StationType // 站点实际类型
  meta        Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  line   Line?         @relation(fields: [lineId], references: [id])
  group  StationGroup? @relation(fields: [groupId], references: [id])
  tracks Track[]
  carrierTracks CarrierTrack[]
}

model Operation {
  id           String      @id @default(cuid())
  code         String      @unique
  name         String
  defaultType  StationType
  isKeyQuality Boolean     @default(false)
  meta         Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  steps   RoutingStep[]
  dcSpecs DataCollectionSpec[]
}

model Routing {
  id          String   @id @default(cuid())
  code        String   @unique // routing code/version identifier
  name        String
  productCode String?
  version     String?
  isActive    Boolean  @default(true)
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps      RoutingStep[]
  workOrders WorkOrder[]
}

model RoutingStep {
  id             String      @id @default(cuid())
  routingId      String
  stepNo         Int
  operationId    String
  stationGroupId String?
  stationType    StationType // 推荐执行方式
  isLast         Boolean     @default(false)
  requiresFAI    Boolean     @default(false)
  meta           Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  routing      Routing       @relation(fields: [routingId], references: [id])
  operation    Operation     @relation(fields: [operationId], references: [id])
  stationGroup StationGroup? @relation(fields: [stationGroupId], references: [id])

  @@unique([routingId, stepNo])
  @@index([routingId])
}

model Unit {
  id            String     @id @default(cuid())
  sn            String     @unique
  woId          String
  runId         String?
  status        UnitStatus @default(QUEUED)
  currentStepNo Int        @default(1)
  meta          Json?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  workOrder     WorkOrder      @relation(fields: [woId], references: [id])
  run           Run?           @relation(fields: [runId], references: [id])
  tracks        Track[]
  defects       Defect[]
  materialUses  MaterialUse[]
  traceSnapshot TraceSnapshot?
  carrierLoads  CarrierLoad[]
  reworkTasks   ReworkTask[]
}

model Carrier {
  id        String   @id @default(cuid())
  carrierNo String   @unique
  type      String // e.g. "REFLOW_LOT" | "RACK" | "TRAY"
  status    String
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  loads  CarrierLoad[]
  tracks CarrierTrack[]
}

model CarrierLoad {
  id         String    @id @default(cuid())
  carrierId  String
  unitId     String
  loadedAt   DateTime  @default(now())
  unloadedAt DateTime?
  meta       Json?

  carrier Carrier @relation(fields: [carrierId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])

  @@unique([carrierId, unitId, loadedAt])
  @@index([carrierId])
  @@index([unitId])
}

model Track {
  id         String       @id @default(cuid())
  unitId     String
  stepNo     Int
  stationId  String?
  source     TrackSource
  inAt       DateTime?
  outAt      DateTime?
  result     TrackResult?
  operatorId String?
  meta       Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  unit       Unit        @relation(fields: [unitId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]
  defects    Defect[]

  @@index([unitId, stepNo])
  @@index([stationId])
}

model CarrierTrack {
  id        String       @id @default(cuid())
  carrierId String
  stepNo    Int
  stationId String?
  source    TrackSource  @default(BATCH)
  inAt      DateTime?
  outAt     DateTime?
  result    TrackResult?
  meta      Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  carrier    Carrier     @relation(fields: [carrierId], references: [id])
  station    Station?    @relation(fields: [stationId], references: [id])
  dataValues DataValue[]

  @@index([carrierId, stepNo])
}

model PrepCheck {
  id        String   @id @default(cuid())
  runId     String
  type      String // EQUIP/MATERIAL/DOC/QUALIFICATION/...
  status    String // PASS/FAIL
  remark    String?
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId, type])
}

model Inspection {
  id        String           @id @default(cuid())
  runId     String
  type      InspectionType
  status    InspectionStatus @default(PENDING)
  data      Json?
  decidedBy String?
  decidedAt DateTime?
  remark    String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId, type])
}

model Authorization {
  id           String    @id @default(cuid())
  runId        String
  status       String // AUTHORIZED/REVOKED
  authorizedBy String?
  authorizedAt DateTime?
  revokedAt    DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  run Run @relation(fields: [runId], references: [id])

  @@index([runId])
}

model DataCollectionSpec {
  id          String  @id @default(cuid())
  operationId String
  name        String
  itemType    String // KEY/OBSERVATION
  dataType    String // NUMBER/TEXT/BOOLEAN/JSON
  method      String // AUTO/MANUAL
  triggerType String // EVENT/TIME/EACH_UNIT/EACH_CARRIER
  triggerRule Json?
  spec        Json?
  alarm       Json?
  isRequired  Boolean @default(false)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  operation  Operation   @relation(fields: [operationId], references: [id])
  dataValues DataValue[]

  @@index([operationId])
}

model DataValue {
  id             String      @id @default(cuid())
  specId         String
  trackId        String?
  carrierTrackId String?
  collectedAt    DateTime    @default(now())
  valueNumber    Float?
  valueText      String?
  valueBoolean   Boolean?
  valueJson      Json?
  judge          String? // PASS/FAIL/NA
  alarmed        Boolean     @default(false)
  source         TrackSource
  meta           Json?

  spec         DataCollectionSpec @relation(fields: [specId], references: [id])
  track        Track?             @relation(fields: [trackId], references: [id])
  carrierTrack CarrierTrack?      @relation(fields: [carrierTrackId], references: [id])

  @@index([specId])
  @@index([trackId])
  @@index([carrierTrackId])
}

model Defect {
  id        String   @id @default(cuid())
  unitId    String
  trackId   String?
  code      String
  location  String?
  qty       Int      @default(1)
  status    String // RECORDED/DISPOSITIONED/CLOSED
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit        Unit         @relation(fields: [unitId], references: [id])
  track       Track?       @relation(fields: [trackId], references: [id])
  disposition Disposition?

  @@index([unitId])
  @@index([code])
}

model Disposition {
  id        String          @id @default(cuid())
  defectId  String          @unique
  type      DispositionType
  decidedBy String?
  decidedAt DateTime?
  reason    String?
  meta      Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  defect     Defect      @relation(fields: [defectId], references: [id])
  reworkTask ReworkTask?
}

model ReworkTask {
  id            String   @id @default(cuid())
  dispositionId String   @unique
  unitId        String
  fromStepNo    Int
  toStepNo      Int
  status        String // OPEN/DONE/CANCELLED
  doneBy        String?
  doneAt        DateTime?
  remark        String?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  disposition Disposition @relation(fields: [dispositionId], references: [id])
  unit        Unit        @relation(fields: [unitId], references: [id])

  @@index([unitId])
}

model MaterialLot {
  id           String    @id @default(cuid())
  materialCode String
  lotNo        String
  supplier     String?
  iqcResult    String?
  iqcDate      DateTime?
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  materialUses MaterialUse[]

  @@unique([materialCode, lotNo])
  @@index([materialCode])
}

model MaterialUse {
  id            String   @id @default(cuid())
  unitId        String
  materialLotId String
  position      String?
  isKeyPart     Boolean  @default(false)
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  unit        Unit        @relation(fields: [unitId], references: [id])
  materialLot MaterialLot @relation(fields: [materialLotId], references: [id])

  @@index([unitId])
  @@index([materialLotId])
  @@index([position])
}

model TraceSnapshot {
  id          String   @id @default(cuid())
  unitId      String   @unique
  snapshot    Json
  generatedAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id])
}

model AuditEvent {
  id             String          @id @default(cuid())
  entityType     AuditEntityType
  entityId       String
  eventType      String
  actorId        String?
  stationId      String?
  at             DateTime        @default(now())
  idempotencyKey String?
  payload     Json?

  @@index([entityType, entityId])
  @@index([idempotencyKey])
}

model IntegrationMessage {
  id          String   @id @default(cuid())
  direction   String // IN/OUT
  system      String // ERP/APS/TEST/EQUIP/...
  businessKey String
  status      String // NEW/SUCCESS/FAILED/RETRYING
  payload     Json
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([direction, system])
  @@index([businessKey])
}
