# 质量工程师 (Quality) 操作指南

## 角色概述

质量工程师负责生产过程中的质量检验、缺陷处置、追溯分析，确保产品质量符合标准。

| 属性 | 值 |
|------|-----|
| 角色代码 | `quality` |
| 数据范围 | 全部 (ALL) |
| 默认首页 | `/mes/trace` |

## 权限清单

### 质量管理
- ✓ 首件检验 (`quality:fai`)
- ✓ FAI 签字（当前与首件检验同权限：`quality:fai`）
- ✓ 出货检验 (`quality:oqc`)
- ✓ 缺陷处置 (`quality:disposition`)
- ✓ 准备项豁免 (`readiness:override`)
- ✓ 时间规则豁免 (`readiness:override`)
- ✓ 维修验证 (`maintenance:verify`)

### 追溯查询
- ✓ 追溯查询 (`trace:read`)
- ✓ 导出报告 (`trace:export`)

### 其他
- ✓ 查看工单 (`wo:read`)
- ✓ 查看批次 (`run:read`)
- ✓ 查看执行 (`exec:read`)

## 可访问菜单

```
生产执行
├── 工单管理      /mes/work-orders        [只读]
├── 批次管理      /mes/runs               [只读]
├── 准备异常      /mes/readiness-exceptions [查看/豁免]
├── 首件检验      /mes/fai                [完整操作]
├── 末件检验      /mes/fqc                [完整操作]
├── 出货检验      /mes/oqc                [完整操作]
├── 出货抽检规则  /mes/oqc/rules          [配置]
├── 维修管理      /mes/maintenance-records [完整操作]
├── 缺陷处置      /mes/defects            [完整操作]
├── 返工任务      /mes/rework-tasks       [完整操作]
├── 工位执行      /mes/execution          [只读]
└── 追溯查询      /mes/trace              [完整操作]

通知中心          /notifications
```

---

## 核心功能操作

### 1. 首件检验 (FAI)

首件检验是批次开始生产前的质量确认环节。MES 系统汇总外部检测数据（SPI/AOI）进行首件判定。

#### 1.1 查看待检列表
1. 导航至 **生产执行 → 首件检验**
2. 查看待检任务：
   - 批次信息
   - 产品型号
   - 关联工位
   - 等待时间

#### 1.2 首件判定流程

```
首件生产 (2-3拼板)
    │
    ▼
SPI 检测结果
├── 自动: 接收数采系统数据
└── 手动: 录入检测结果
    │
    ▼
回流焊接
    │
    ▼
AOI 检测结果
├── 自动: 接收数采系统数据
└── 手动: 录入检测结果
    │
    ▼
MES 汇总判定
    │
    ├── 全部 PASS → 首件通过，批次可授权
    └── 任一 FAIL → 首件不通过，需处置
```

#### 1.3 执行首件检验
1. 在批次详情页（Run 详情）点击 **创建并开始试产**
2. 完成首件试产后，进入 **生产执行 → 首件检验** 选择任务
3. 点击 **开始检验**
4. 查看检测数据：
   - SPI 结果（自动/手动）
   - AOI 结果（自动/手动）
   - 数据来源标识（`AUTO`/`MANUAL`）
5. 根据汇总结果判定：
   - **通过**: 批次可继续生产
   - **不通过**: 需要处置

> 前置条件：Run 处于 PREP，且就绪检查（Formal）通过并已生成足够单件。

#### 1.4 首件不通过处理
1. 选择不通过原因
2. 触发缺陷处置流程
3. 通知产线组长暂停生产
4. 跟踪整改情况
5. 安排复检（连续失败≥3次需工程师介入）

#### 1.5 FAI 签字确认

FAI 判定 PASS 后，需由质量人员进行签字确认，Run 授权前必须完成签字。

**签字流程**：
1. FAI 判定 PASS 后，在 **批次详情页（Run 详情）** 点击 **FAI 签字**
2. 填写签字备注（可选）
3. 确认签字

**签字规则**：
- 签字与首件检验权限一致（`quality:fai`）
- 签字后记录签字人、签字时间、备注
- 未签字的 FAI 无法授权 Run 生产

> **说明**: FAI 签字是质量门禁的一部分，确保首件质量经过确认后才能批量生产。

---

### 2. 末件检验 (FQC)

末件检验用于批次完成后的抽样复核，入口为 **/mes/fqc**。

#### 2.1 创建末件检验
1. 导航至 **生产执行 → 末件检验**
2. 点击 **新建**，选择 Run 并填写抽样数量（默认 1）
3. 创建后任务状态为 `PENDING`

> 前置条件：Run 全部 Unit 已进入终态（DONE/SCRAPPED）。

#### 2.2 执行检验
1. 点击 **开始检验**
2. 录入检验项（PASS/FAIL/NA）
3. 完成判定（PASS/FAIL），填写通过/失败数量

> 当前实现：FQC 完成不改变 Run 状态，仅记录检验结果。

#### 2.3 签字确认
1. FQC 判定 PASS 后可进行签字确认
2. 记录签字人/时间与备注（可选）

---

### 3. 出货检验 (OQC)

出货检验用于批次收尾阶段的抽检，入口为 **/mes/oqc**。

#### 3.1 触发方式
- 在批次详情页点击 **收尾** 触发完工检查。
- 若命中抽检规则且样本数 > 0，将创建 OQC 任务；否则 Run 直接完成。
- UI 当前不提供手动创建 OQC 入口（可通过 API 调用）。

#### 3.2 抽检规则
1. 导航至 **生产执行 → 出货抽检规则**
2. 新建规则（PERCENTAGE/FIXED；sampleValue 可为 0）

#### 3.3 执行 OQC
1. 进入 **生产执行 → 出货检验**
2. 选择任务点击 **开始检验**
3. 录入检验项并完成判定
4. **PASS** → Run 完工（COMPLETED）
5. **FAIL** → Run 进入 ON_HOLD，进入 MRB 决策

---

### 4. 缺陷处置

#### 4.1 查看缺陷列表
1. 导航至 **生产执行 → 缺陷处置**
2. 查看待处置缺陷：
   - 缺陷来源（首件检验/过程检验/终检）
   - 缺陷描述
   - 影响范围
   - 创建时间

#### 4.2 缺陷判定
1. 选择待处置缺陷
2. 点击 **处置**
3. 分析缺陷：
   - 查看缺陷详情
   - 查看关联产品追溯信息
   - 评估影响范围
   - 查看数据来源（`AUTO`/`MANUAL`）
4. 做出判定：

| 判定结果 | 说明 | 后续操作 | 单件状态 |
|----------|------|----------|----------|
| **放行** | 缺陷在可接受范围内 | 产品继续流转 | `QUEUED` |
| **返修** | 可通过返工修复 | 创建返修任务 | `OUT_FAILED → QUEUED` |
| **报废** | 无法修复 | 产品报废处理 | `SCRAPPED` |
| **隔离** | 需 MRB 评审 | 产品隔离等待 | `ON_HOLD` |

5. 填写处置意见
6. 确认提交

#### 4.3 批量处置
对于同批次的多个缺陷：
1. 勾选相关缺陷记录
2. 点击 **批量处置**
3. 统一做出判定
4. 确认提交

---

### 5. 返工任务管理

#### 5.1 查看返工任务
1. 导航至 **生产执行 → 返工任务**
2. 查看任务状态：
   - 待执行
   - 进行中
   - 已完成
   - 已关闭

#### 5.2 创建返工任务
缺陷判定为返工后自动创建，或手动创建：
1. 点击 **新建返工任务**
2. 填写信息：
   - 关联缺陷
   - 返工内容描述
   - 返工工序
   - 预期完成时间
3. 保存

#### 5.3 跟踪返工进度
1. 查看返工任务执行状态
2. 返工完成后进行复检
3. 复检通过后关闭任务

---

### 6. 准备项豁免管理

当生产准备检查项失败但生产需要继续时，质量工程师可以进行豁免操作。

#### 6.1 可豁免的检查项

| 检查项 | 说明 | 典型豁免场景 |
|--------|------|-------------|
| STENCIL | 钢网状态 | 外部系统不可用，人工确认合格 |
| SOLDER_PASTE | 锡膏状态 | 锡膏批次状态无法自动获取 |
| EQUIPMENT | 设备状态 | TPM 系统离线，人工确认设备正常 |
| PREP_SCRAPER | 刮刀点检 | 紧急生产，点检记录待补录 |
| TIME_RULE | 时间规则 | 锡膏暴露时间略超，质量已确认 |

> **注意**: 当前系统未限制不可豁免项；对 ROUTE/LOADING 等关键项建议仅在审批后操作。

#### 6.2 执行豁免操作

1. 导航至 **生产执行 → 批次管理** → 选择批次
2. 在 Readiness 卡片找到失败的检查项
3. 点击检查项旁的 **豁免** 按钮
4. 填写豁免原因（必填）
5. 确认豁免

**期望结果**：
- 检查项状态变为 WAIVED（黄色标记）
- Readiness 整体状态变为 PASSED
- 审计日志记录豁免操作

#### 4.3 时间规则豁免

对于时间规则超时的情况，需要更高权限进行豁免：

1. 在 Run 详情页或时间规则监控页找到超时实例
2. 点击 **豁免**
3. 填写豁免原因（说明已确认物料/产品质量）
4. 确认豁免

> **警告**: 时间规则豁免需要 `readiness:override` 权限。

#### 6.3 豁免审计

所有豁免操作都会记录：
- 豁免时间
- 豁免人
- 豁免原因
- 被豁免的检查项

这些记录会在追溯报告中显示，确保可追溯性。

---

### 7. 维修管理

维修管理模块用于记录和跟踪设备、夹具、钢网等实体的维修过程。

#### 7.1 查看维修记录

1. 导航至 **生产执行 → 维修管理** (`/mes/maintenance-records`)
2. 使用筛选条件：
   - 维修状态（待处理/维修中/已完成/已验证）
   - 实体类型（夹具/钢网/刮刀/设备）
   - 产线

#### 7.2 维修状态说明

| 状态 | 说明 | 下一步操作 |
|------|------|-----------|
| PENDING | 待处理（已报修） | 指派维修人员 |
| IN_PROGRESS | 维修中 | 完成维修 |
| COMPLETED | 已完成 | 验证维修效果 |
| VERIFIED | 已验证 | 实体可恢复使用 |

#### 7.3 验证维修

维修完成后，质量人员需要验证维修效果：

1. 在维修记录列表找到状态为 COMPLETED 的记录
2. 点击 **验证**
3. 检查维修效果：
   - 钢网：检查张力、透锡率
   - 夹具：检查平整度、定位精度
   - 刮刀：检查刀口状态
4. 填写验证备注
5. 确认验证通过

**验证后**：
- 实体状态恢复正常
- 相关 Readiness 检查可通过
- 实体可重新投入使用

#### 7.4 维修与 Readiness 联动

当实体处于维修状态时：
- 相关 Readiness 检查项自动 FAIL
- 例如：钢网在维修 → PREP_STENCIL_USAGE 检查项 FAIL
- 维修验证通过后，重新执行 Readiness 检查可通过

---

### 8. 追溯查询

#### 8.1 按序列号查询
1. 导航至 **生产执行 → 追溯查询**
2. 输入产品序列号
3. 查看完整追溯信息：
   - 生产履历（各工序时间、操作人）
   - 采集数据（各工序参数值）
   - 质检记录
   - 缺陷/返工记录
   - 物料信息
   - **数据来源标识**（`AUTO`/`MANUAL`）

> **数据来源说明**：
> - `AUTO`: 数据由外部系统（SPI/AOI/TPM/WMS）自动采集
> - `MANUAL`: 数据由操作员手动录入（降级模式）
> 
> 可通过数据来源统计手动录入占比，衡量自动化程度。

#### 8.2 按批次查询
1. 选择批次查询方式
2. 输入批次号
3. 查看批次下所有产品的追溯汇总

#### 8.3 条件筛选查询
1. 使用高级筛选：
   - 时间范围
   - 产品型号
   - 生产线
   - 缺陷类型
2. 查看符合条件的产品列表

#### 8.4 导出报告
1. 选择需要导出的追溯数据
2. 点击 **导出**
3. 选择导出格式：
   - PDF 报告
   - Excel 数据
4. 下载报告

---

## 工作流程

### 日常质检工作流

```
早班开始
    │
    ▼
查看待检任务（首件检验）
    │
    ▼
执行首件检验
    ├── 通过 → 批次正常生产
    └── 不通过 → 触发缺陷处置
            │
            ▼
处置缺陷
    ├── 放行
    ├── 返工 → 创建返工任务 → 跟踪 → 复检
    └── 报废
            │
            ▼
追溯分析（如需要）
    │
    ▼
导出质量报告
```

### 质量问题处理流程

```
接收质量问题通知
        │
        ▼
追溯查询定位问题
        │
        ▼
分析影响范围
        │
        ▼
做出处置决定
        │
        ▼
跟踪处置执行
        │
        ▼
验证问题解决
        │
        ▼
总结改进措施
```

---

## 常见场景

### 场景1: 首件检验发现问题
1. 记录详细缺陷信息
2. 通知产线组长暂停该批次
3. 分析问题原因
4. 与工艺工程师沟通（如涉及工艺问题）
5. 确定处置方案
6. 整改后复检

### 场景2: 客户投诉追溯
1. 根据客户提供的序列号查询追溯
2. 导出完整生产履历
3. 分析可能的问题环节
4. 追溯同批次其他产品
5. 生成追溯报告

### 场景3: 批量缺陷处理
1. 统计缺陷分布
2. 分析共性原因
3. 批量判定处置
4. 建立预防措施
5. 通知相关人员

---

## 质量数据分析

### 关键指标
- **一次通过率 (FPY)**: 首次检验通过的比例
- **缺陷率**: 缺陷数量占总产量的比例
- **返工率**: 需要返工的产品比例
- **报废率**: 报废产品的比例

### 分析维度
- 按产品型号
- 按产线/工位
- 按时间段
- 按缺陷类型

---

## 与其他角色的协作

| 协作角色 | 协作内容 |
|----------|----------|
| 工艺工程师 | 工艺问题分析，检验规范制定 |
| 产线组长 | 现场质量问题沟通，首件协调 |
| 操作员 | 操作规范指导，质量培训 |
| 生产计划员 | 质量问题对交期的影响评估 |

---

## 注意事项

1. **及时处置**: 缺陷发现后应及时处置，避免影响扩大
2. **完整记录**: 所有质量判定都应有充分的记录和依据
3. **追溯完整性**: 确保追溯数据的完整性和准确性
4. **数据保密**: 追溯数据可能涉及客户信息，注意保密
5. **持续改进**: 从质量数据中发现规律，推动持续改进
