# MES 演示流程问题记录

> 记录日期: 2026-01-12
> 目的: 记录演示流程走查中发现的问题，用于后续修复

---

## 问题列表

### 问题 #17: Run 完成状态未自动更新

**发现位置**: Run 详情页

**问题描述**:
- 用户走完 10 个单件中的 1 个（状态变为 DONE）
- 删除剩余 9 个单件
- 此时 Run 应该自动变为 COMPLETED（因为所有现存单件都完成了）
- 但 Run 状态仍然是 IN_PROGRESS

**问题分析**:
1. 出站时可能只更新单件状态，未检查 Run 是否应该完成
2. 删除单件后未触发 Run 状态重新计算
3. Run 完成条件检查逻辑可能缺失或有 bug

**建议修复**:
1. 出站完成时检查：如果所有单件都完成，自动将 Run 设为 COMPLETED
2. 提供手动"完成 Run"按钮（用于异常情况）
3. 删除单件后也应触发状态检查

**优先级**: P1 (Run 生命周期不完整)

---

### 问题 #18: Readiness 检查权限配置与文档/角色不符

**发现位置**: Run 详情页 → 正式检查

**问题描述**:
- 使用 `planner` (生产计划员) 账号点击「正式检查」时，接口返回 500 错误
- 控制台显示 `Missing required permission: readiness:check`
- 前端仅提示「正式检查失败」，但列表为空，未显示具体权限错误
- 切换至 `leader` (产线组长) 账号后操作成功

**当前状态**:
- 文档 imply 计划员可以创建 Run 并推进流程，或者未明确角色切换点
- 前端对 500/403 错误的 UI 反馈不友好（Loading 态卡住或显示空列表）

**建议修复**:
1. 明确角色职责：如果计划员不应做检查，隐藏按钮
2. 优化错误处理：前端捕获权限错误并友好提示「无权操作」
3. 修正 Seed 数据：如果计划员应该能检查，需添加权限

**优先级**: P2 (演示流程阻碍)

---

### 问题 #19: 上料验证因缺少 Material Lot 种子数据而失败

**发现位置**: 上料防错页面 (/mes/loading)

**问题描述**:
- 使用 Seed 数据生成的 Run 和站位表
- 扫描物料 `MAT-001` 时提示 `Material lot not found for barcode`
- 检查数据库/Seed 脚本，发现创建了 `Material` 和 `SlotMaterialMapping`，但未创建 `MaterialLot` 记录
- 导致默认演示流程在扫码环节卡住

**复现步骤**:
1. 创建 Run 并加载站位表
2. 在上料页面扫描 `MAT-001`
3. 报错：找不到物料批次

**建议修复**:
1. 在 `seed-demo.ts` 中为演示物料 (`MAT-001`) 创建默认的 `MaterialLot` (如 `LOT-MAT-001-001`)
2. 或者在上料逻辑中支持自动注册/宽容模式（针对演示环境）

**优先级**: P1 (演示流程阻碍)

---

### 问题 #20: FAI 任务创建与查看权限限制过严

**发现位置**: Run 详情页

**问题描述**:
- `leader` (产线组长) 无法看到 "创建 FAI" 按钮，也无法看到 FAI 详情卡片
- 只有切换到 `quality` (质量工程师) 才能创建和查看 FAI
- 但 `leader` 负责 "授权生产"，而授权依赖 FAI 通过
- `leader` 无法直观确认 FAI 状态细节，且演示流程中频繁切换账号体验不佳

**当前行为**:
- `leader` 视角：Run 详情页无 FAI 卡片，点击授权报错 "FAI_NOT_PASSED"
- `quality` 视角：Run 详情页有 FAI 卡片和创建按钮

**建议修复**:
1. 允许 `leader` 查看 FAI 卡片（只读）
2. 考虑允许 `leader` 创建 FAI（如果不违反质量隔离原则），或者在授权失败时给出更明确引导 "请联系质量人员完成 FAI"

**优先级**: P2 (流程体验优化)

---

### 问题 #21: 执行页面未自动关联新创建的 Run

**发现位置**: 工位执行页面 (/mes/execution)

**问题描述**:
- 创建新 Run 并授权后，进入执行页面
- 页面默认并未选中相关工位，也未显示该 Run 的任务
- 需要手动扫描 SN (如 `SN-TEST-001`) 和 Run 号才能开始
- 系统未自动为新 Run 生成 Unit (对应问题 #15)

**建议修复**:
- 同问题 #14 和 #15，加强 Run 与执行页面的联动

**优先级**: P2

---

<!-- 后续问题将追加在此 -->
