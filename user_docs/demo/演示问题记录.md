# MES 演示流程问题记录

> 记录日期: 2026-01-09
> 目的: 记录演示流程走查中发现的问题，用于后续修复

---

## 问题列表

### 问题 #1: 物料/BOM/工作中心缺少列表页

**发现位置**: ERP 同步 → 数据展示

**问题描述**:
- 物料 (`Material`)、BOM (`BomItem`)、工作中心 (`WorkCenter`) 同步后没有专门的前端列表页
- 用户无法直观验证同步是否成功、数据是否正确

**当前状态**:
- 数据存在于数据库中
- 只能通过其他页面的下拉选项间接看到部分数据
- `/mes/integration/status` 只显示同步状态，不显示具体数据

**建议修复**:
1. 创建物料列表页 `/mes/materials` - 显示 code, name, category, unit, model, sourceUpdatedAt
2. 创建 BOM 列表页 `/mes/boms` - 按父物料展示层级关系
3. 创建工作中心列表页 `/mes/work-centers` - 显示工作中心及映射关系

**优先级**: P2 (演示可选，生产环境需要)

---

### 问题 #2: 路由编译成功提示与实际结果不符

**发现位置**: 路由详情页 → 编译按钮

**问题描述**:
- 点击"编译"按钮后，前端提示"成功"
- 但实际编译结果是 `INVALID`（验证失败）
- 用户误以为编译成功，实际上路由无法使用

**复现步骤**:
1. 进入 ERP 同步的路由详情页（如 `EOIS-03-P`）
2. 点击"编译路由"按钮
3. 前端显示成功提示
4. 去路由版本页查看，发现状态是 INVALID

**根本原因**:
- "编译"操作本身成功了（生成了版本记录）
- 但编译验证失败（工序缺少工位组配置）
- 前端只判断 API 调用是否成功，未判断编译结果状态

**错误信息示例**:
```
Step 10 STATION_CONSTRAINT_MISSING: Station group or allowed stations required
Step 20 STATION_CONSTRAINT_MISSING: Station group or allowed stations required
...
```

**建议修复**:
1. 编译 API 返回结果中包含 status 字段
2. 前端根据 status 显示不同提示：
   - `READY`: 显示"编译成功"（绿色）
   - `INVALID`: 显示"编译失败：xxx"（红色）+ 显示具体错误
3. 考虑在编译前预检，提前警告缺少配置

**优先级**: P1 (严重影响用户体验)

---

### 问题 #3: ERP 路由同步后缺少执行配置，无引导

**发现位置**: 路由详情页 → 执行配置

**问题描述**:
- ERP 同步的路由只有基础信息和工序列表
- 没有执行配置（工位组、工位类型等）
- 用户不知道需要为每个工序添加执行配置才能编译成功

**期望行为**:
1. 同步后的路由详情页应有明显提示："此路由尚未配置执行语义，请为每个工序配置工位组"
2. 或者提供"快速配置向导"，批量为所有工序配置默认工位组

**建议修复**:
1. 路由详情页增加"配置状态"指示器
2. 编译按钮旁增加 tooltip 或前置检查
3. 提供批量配置工位组的功能

**优先级**: P2 (用户引导体验)

---

### 问题 #4: 站点组/工位主数据与 ERP 数据断层

**发现位置**: 路由执行配置 → 选择站点组

**问题描述**:
- MES 站点组 (`SMT-LINE-A`, `DIP-LINE-A`) 来自 Seed 演示数据
- ERP 工作中心只有 1 个 "生产部"，太粗糙无法对应具体工位
- ERP 路由的工序无法自动映射到 MES 站点组
- 用户不知道应该为每个工序选择哪个站点组

**数据现状**:
```
MES 站点组 (Seed 演示数据):
- SMT-LINE-A: 钢网印刷、SPI、贴片、回流、AOI
- DIP-LINE-A: DIP 插件、波峰焊、后焊、功能测试

ERP 工作中心 (ERP 同步):
- WC000001: 生产部 (只有这一个)

EOIS-03-P 工序:
- Step 10: SMT, Step 20: 后加料, Step 30: 测试
- Step 40: QC检查, Step 50: QA检查, Step 60: 包装
```

**根本原因**:
1. ERP 工作中心粒度太粗，无法指导 MES 执行
2. 站点组是演示数据，不匹配真实产线
3. 缺少 ERP 工作中心 → MES 站点组的映射机制

**建议修复**:
1. 根据真实产线结构创建站点组（替代 Seed 数据）
2. 建立工作中心 → 站点组映射表
3. 或者在 ERP 路由同步时，自动创建对应的站点组占位

**优先级**: P1 (核心配置问题，影响所有 ERP 路由)

---

### 问题 #5: 执行配置作用域过度设计

**发现位置**: 路由详情页 → 新增执行配置 → 作用域选择

**问题描述**:
- 曾有 4 种作用域：ROUTE / OPERATION / STEP / SOURCE_STEP
- STEP 和 SOURCE_STEP 在实现中被合并处理，但 UI 分开展示
- OPERATION 层（跨路由共享配置）需求不常见，增加理解成本
- 用户难以理解什么时候用哪种作用域

**调整后实现**:
- UI 仅保留 2 种选项：`全局默认` + `按步骤覆盖`
- 编译/就绪检查不再使用 OPERATION 层覆盖（仅 STEP + ROUTE）
- 取舍原因：避免“UI 不可见但仍生效”的隐藏覆盖（尤其是 OPERATION 跨路由），降低排查成本；SOURCE_STEP 的稳定匹配诉求由 STEP 创建时自动写入 `sourceStepKey` 来满足

**代码实现分析**（示意）:
```typescript
// STEP（包含 sourceStepKey 匹配）合并
const stepConfig = pickLatest([...stepConfigs, ...sourceConfigs]);
const routeConfig = pickLatest(routeConfigs);

// 按优先级覆盖：STEP > ROUTE > 默认值
const stationGroupId =
    stepConfig?.stationGroupId ??
    routeConfig?.stationGroupId ??
    step.stationGroupId;
```

**问题**:
1. 多层优先级对用户来说太复杂
2. STEP 和 SOURCE_STEP 功能重叠
3. OPERATION 层跨路由共享，实际使用场景有限
4. scopeType 字段只在 UI 层使用，数据库不存储

**建议简化**:
1. UI 只暴露 2 种选项：`全局默认` + `按步骤覆盖`
2. 删除 OPERATION 层（或隐藏为高级选项）
3. 合并 STEP 和 SOURCE_STEP 为一个概念
4. 简化后的逻辑：`stepConfig ?? routeConfig ?? null`

**优先级**: P2 (用户体验优化)

---

<!-- 后续问题将追加在此 -->
