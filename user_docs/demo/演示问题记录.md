# MES 演示流程问题记录

> 记录日期: 2026-01-09
> 目的: 记录演示流程走查中发现的问题，用于后续修复

---

## 问题列表

### 问题 #1: 物料/BOM/工作中心缺少列表页

**发现位置**: ERP 同步 → 数据展示

**问题描述**:
- 物料 (`Material`)、BOM (`BomItem`)、工作中心 (`WorkCenter`) 同步后没有专门的前端列表页
- 用户无法直观验证同步是否成功、数据是否正确

**当前状态**:
- 数据存在于数据库中
- 只能通过其他页面的下拉选项间接看到部分数据
- `/mes/integration/status` 只显示同步状态，不显示具体数据

**建议修复**:
1. 创建物料列表页 `/mes/materials` - 显示 code, name, category, unit, model, sourceUpdatedAt
2. 创建 BOM 列表页 `/mes/boms` - 按父物料展示层级关系
3. 创建工作中心列表页 `/mes/work-centers` - 显示工作中心及映射关系

**优先级**: P2 (演示可选，生产环境需要)

---

### 问题 #2: 路由编译成功提示与实际结果不符

**发现位置**: 路由详情页 → 编译按钮

**问题描述**:
- 点击"编译"按钮后，前端提示"成功"
- 但实际编译结果是 `INVALID`（验证失败）
- 用户误以为编译成功，实际上路由无法使用

**复现步骤**:
1. 进入 ERP 同步的路由详情页（如 `EOIS-03-P`）
2. 点击"编译路由"按钮
3. 前端显示成功提示
4. 去路由版本页查看，发现状态是 INVALID

**根本原因**:
- "编译"操作本身成功了（生成了版本记录）
- 但编译验证失败（工序缺少工位组配置）
- 前端只判断 API 调用是否成功，未判断编译结果状态

**错误信息示例**:
```
Step 10 STATION_CONSTRAINT_MISSING: Station group or allowed stations required
Step 20 STATION_CONSTRAINT_MISSING: Station group or allowed stations required
...
```

**建议修复**:
1. 编译 API 返回结果中包含 status 字段
2. 前端根据 status 显示不同提示：
   - `READY`: 显示"编译成功"（绿色）
   - `INVALID`: 显示"编译失败：xxx"（红色）+ 显示具体错误
3. 考虑在编译前预检，提前警告缺少配置

**优先级**: P1 (严重影响用户体验)

---

### 问题 #3: ERP 路由同步后缺少执行配置，无引导

**发现位置**: 路由详情页 → 执行配置

**问题描述**:
- ERP 同步的路由只有基础信息和工序列表
- 没有执行配置（工位组、工位类型等）
- 用户不知道需要为每个工序添加执行配置才能编译成功

**期望行为**:
1. 同步后的路由详情页应有明显提示："此路由尚未配置执行语义，请为每个工序配置工位组"
2. 或者提供"快速配置向导"，批量为所有工序配置默认工位组

**建议修复**:
1. 路由详情页增加"配置状态"指示器
2. 编译按钮旁增加 tooltip 或前置检查
3. 提供批量配置工位组的功能

**优先级**: P2 (用户引导体验)

---

### 问题 #4: 站点组/工位主数据与 ERP 数据断层

**发现位置**: 路由执行配置 → 选择站点组

**问题描述**:
- MES 站点组 (`SMT-LINE-A`, `DIP-LINE-A`) 来自 Seed 演示数据
- ERP 工作中心只有 1 个 "生产部"，太粗糙无法对应具体工位
- ERP 路由的工序无法自动映射到 MES 站点组
- 用户不知道应该为每个工序选择哪个站点组

**数据现状**:
```
MES 站点组 (Seed 演示数据):
- SMT-LINE-A: 钢网印刷、SPI、贴片、回流、AOI
- DIP-LINE-A: DIP 插件、波峰焊、后焊、功能测试

ERP 工作中心 (ERP 同步):
- WC000001: 生产部 (只有这一个)

EOIS-03-P 工序:
- Step 10: SMT, Step 20: 后加料, Step 30: 测试
- Step 40: QC检查, Step 50: QA检查, Step 60: 包装
```

**根本原因**:
1. ERP 工作中心粒度太粗，无法指导 MES 执行
2. 站点组是演示数据，不匹配真实产线
3. 缺少 ERP 工作中心 → MES 站点组的映射机制

**建议修复**:
1. 根据真实产线结构创建站点组（替代 Seed 数据）
2. 建立工作中心 → 站点组映射表
3. 或者在 ERP 路由同步时，自动创建对应的站点组占位

**优先级**: P1 (核心配置问题，影响所有 ERP 路由)

---

### 问题 #5: 执行配置作用域过度设计

**发现位置**: 路由详情页 → 新增执行配置 → 作用域选择

**问题描述**:
- 曾有 4 种作用域：ROUTE / OPERATION / STEP / SOURCE_STEP
- STEP 和 SOURCE_STEP 在实现中被合并处理，但 UI 分开展示
- OPERATION 层（跨路由共享配置）需求不常见，增加理解成本
- 用户难以理解什么时候用哪种作用域

**调整后实现**:
- UI 仅保留 2 种选项：`全局默认` + `按步骤覆盖`
- 编译/就绪检查不再使用 OPERATION 层覆盖（仅 STEP + ROUTE）
- 取舍原因：避免“UI 不可见但仍生效”的隐藏覆盖（尤其是 OPERATION 跨路由），降低排查成本；SOURCE_STEP 的稳定匹配诉求由 STEP 创建时自动写入 `sourceStepKey` 来满足

**代码实现分析**（示意）:
```typescript
// STEP（包含 sourceStepKey 匹配）合并
const stepConfig = pickLatest([...stepConfigs, ...sourceConfigs]);
const routeConfig = pickLatest(routeConfigs);

// 按优先级覆盖：STEP > ROUTE > 默认值
const stationGroupId =
    stepConfig?.stationGroupId ??
    routeConfig?.stationGroupId ??
    step.stationGroupId;
```

**问题**:
1. 多层优先级对用户来说太复杂
2. STEP 和 SOURCE_STEP 功能重叠
3. OPERATION 层跨路由共享，实际使用场景有限
4. scopeType 字段只在 UI 层使用，数据库不存储

**建议简化**:
1. UI 只暴露 2 种选项：`全局默认` + `按步骤覆盖`
2. 删除 OPERATION 层（或隐藏为高级选项）
3. 合并 STEP 和 SOURCE_STEP 为一个概念
4. 简化后的逻辑：`stepConfig ?? routeConfig ?? null`

**优先级**: P2 (用户体验优化)

---

### 问题 #6: 批次产线选择未校验路由站点组兼容性

**发现位置**: 创建批次 → 选择产线

**问题描述**:
- 创建 Run 时可以选择任意产线
- 但路由的执行配置中指定了站点组，站点组归属于特定产线
- 如果选择的产线与路由配置的站点组不匹配，后续执行会出问题
- 系统未在创建时校验兼容性

**复现步骤**:
1. 路由配置了 SMT-LINE-A 的站点组
2. 创建 Run 时选择 DIP-LINE-A 产线
3. 系统允许创建成功
4. 执行时才发现产线下没有可用工位

**建议修复**:
1. 创建 Run 时校验：所选产线必须包含路由所需的站点组
2. 或者根据路由配置自动推荐/限制可选产线
3. 如果产线与站点组不兼容，提前阻止创建并给出提示

**优先级**: P1 (核心业务逻辑缺失)

---

### 问题 #7: 就绪检查(ROUTE)仅检查版本状态，缺少产线兼容性检查

**发现位置**: 批次详情页 → 就绪检查

**问题描述**:
- ROUTE 预检目前只检查路由版本是否 READY
- 不检查当前批次的产线与路由配置的站点组是否兼容
- 导致预检通过后，实际执行时仍可能因产线/工位不匹配而失败

**当前检查项**:
- 路由版本状态 = READY

**缺失检查项**:
- 批次产线是否包含路由所需的站点组
- 各站点组下是否有可用工位

**建议修复**:
1. ROUTE 预检增加产线-站点组兼容性检查
2. 检查失败时明确提示：「产线 XXX 下无站点组 YYY」

**优先级**: P1 (就绪检查不完整)

---

### 问题 #8: DIP 产线默认仅跑 ROUTE 预检

**发现位置**: DIP 产线批次 → 就绪检查

**问题描述**:
- DIP 产线的批次默认只运行 ROUTE 预检
- 未运行 MATERIAL/LOADING 等其他预检
- 可能是因为 DIP 产线暂未配置完整的预检门

**当前状态**:
- SMT 产线：配置了完整预检门（ROUTE + MATERIAL + ...）
- DIP 产线：仅 ROUTE 预检

**建议修复**:
1. 检查 DIP 产线的预检门配置是否完整
2. 根据实际需求为 DIP 产线添加对应预检门
3. 或者在 UI 上说明「当前产线未配置 XXX 检查」

**优先级**: P2 (产线配置不完整)

---

### 问题 #9: 下发工单 UI 接收 lineCode 但后端未使用

**发现位置**: 工单列表 → 下发工单

**问题描述**:
- 下发工单对话框中有「产线」选择框
- 用户选择 lineCode 后提交
- 但后端 releaseWorkOrder API 未使用这个参数
- 下发后的工单实际上没有关联到指定产线

**期望行为**:
- 下发时指定的产线应该记录在工单上
- 或者用于创建 Run 时的默认产线

**建议修复**:
1. 如果产线选择有意义：后端需要使用 lineCode 参数
2. 如果产线选择无意义：前端移除这个字段，避免用户困惑

**优先级**: P2 (前后端不一致)

---

### 问题 #10: 领料门定位待确定

**发现位置**: 批次流程 → 领料环节

**问题描述**:
- 领料门（MATERIAL gate）在流程中的位置需要确定
- 可选方案：
  1. 作为独立预检门（当前实现）
  2. 作为执行过程中的首站前置检查
  3. 其他方案

**当前状态**:
- 领料检查作为预检门之一
- 与 ROUTE/LOADING 等并列

**待决策**:
- 领料时机：批次创建后立即 or 上线前
- 是否需要与工位绑定

**优先级**: P3 (流程设计待确定)

---

### 问题 #11: FAI 任务需要从 Run 详情页手动创建

**发现位置**: /mes/fai 页面

**问题描述**:
- 在 `/mes/fai` 页面输入 Run 编号查询，显示"暂无 FAI 任务"
- 原因：FAI 任务不会自动创建，需要从 Run 详情页手动点击"创建 FAI"按钮
- 用户不知道要去 Run 详情页创建 FAI

**当前流程**:
1. 预检通过后，Run 状态变为 PREP
2. 用户需要进入 Run 详情页 `/mes/runs/{runNo}`
3. 手动点击"创建 FAI"按钮，输入抽样数量
4. FAI 创建后才能在 `/mes/fai` 页面看到

**建议优化**:
1. **方案A**: 预检通过后自动创建 FAI 任务（如果 `requiresFAI=true`）
2. **方案B**: `/mes/fai` 页面支持直接创建 FAI（输入 Run 编号 + 抽样数）
3. **方案C**: 在 `/mes/fai` 页面增加提示，引导用户去 Run 详情页创建

**优先级**: P2 (用户引导体验)

---

### 问题 #12: 路由执行配置无法删除

**发现位置**: 路由详情页 → 执行配置列表

**问题描述**:
- 为路由 EOIS-03-P 新增了两条执行配置
- 想要删除这些配置时，发现没有删除按钮/功能
- 后端 API 也没有删除执行配置的接口

**当前状态**:
- 只能新增/编辑执行配置
- 无法删除错误的或不需要的配置
- 需要直接操作数据库才能删除

**建议修复**:
1. 后端增加 `DELETE /api/mes/routings/:code/execution-configs/:id` API
2. 前端执行配置列表增加删除按钮
3. 删除时需确认对话框，防止误删

**优先级**: P1 (基础 CRUD 功能缺失)

---

### 问题 #13: "创建 FAI" 按钮仅在 PREP 状态显示

**发现位置**: Run 详情页 → FAI 区域

**问题描述**:
- "创建 FAI" 按钮只在 `run.status === 'PREP'` 时显示
- 如果 Run 状态变为 `AUTHORIZED` 或其他状态，按钮消失
- 用户无法在其他状态下补创建 FAI

**代码位置**: `apps/web/src/routes/_authenticated/mes/runs/$runNo.tsx:268`
```typescript
const canShowReadinessActions = data.run.status === "PREP";
```

**问题分析**:
1. 预检通过后，Run 可能已经变成 AUTHORIZED 状态
2. 此时用户想创建 FAI，发现按钮不见了
3. 按钮显示条件过于严格

**建议修复**:
1. 放宽条件：`status === 'PREP' || (status === 'AUTHORIZED' && !existingFai)`
2. 或者在非 PREP 状态时显示禁用按钮并提示原因
3. 确保 FAI 创建时机与业务流程匹配

**优先级**: P1 (功能不可用)

---

### 问题 #14: 执行页面与 Run 缺乏关联引导

**发现位置**: /mes/execution 页面

**问题描述**:
- 执行页面需要先选择工位，但用户不知道应该选哪个
- 页面没有显示当前有哪些 AUTHORIZED 状态的 Run 可以执行
- 从 Run 详情页到执行页面没有直接引导，用户不知道去哪个工位操作

**当前设计**:
1. 执行页面以「工位」为中心，需要先选择工位
2. 工位列表来自 `stations` API
3. 用户可能绑定了特定工位 (`userProfile.stationIds`)
4. 选择工位后显示该工位的队列

**问题分析**:
1. Run 的路由配置了站点组，但执行页面不知道这个 Run 应该在哪个工位
2. 缺少「Run → 可执行工位」的映射关系展示
3. 用户刚授权完 Run，不知道下一步去哪里

**建议修复**:
1. **方案A**: Run 详情页增加「开始执行」按钮，跳转到执行页面并自动填充 Run 信息
2. **方案B**: 执行页面增加「待执行批次」列表，显示 AUTHORIZED 状态的 Run
3. **方案C**: 根据 Run 的站点组配置，提示用户可选的工位范围

**优先级**: P1 (严重影响可用性)

---

### 问题 #15: Run 没有创建单件 (Unit)

**发现位置**: Run 详情页 → 单件列表

**问题描述**:
- 用户创建的 `RUN-DEMO-1767942874265` 批次没有单件
- 数据库查询显示该 Run 下没有 Unit 记录
- 现有的单件 (`SN-DEMO-SMT-0001` 等) 是 Seed 演示数据，不属于这个 Run

**执行流程依赖**:
- 执行页面需要扫描单件 SN 进行过站
- 没有单件就无法执行

**问题分析**:
1. 创建 Run 时没有自动生成单件
2. 没有"生成单件"的入口
3. 单件生成逻辑可能缺失或未被触发

**建议修复**:
1. Run 创建时根据 `plannedQty` 自动生成单件
2. 或者提供"生成单件"按钮，支持批量生成
3. 单件 SN 可以自动生成或支持导入

**优先级**: P1 (无法执行)

---

### 问题 #16: 站点组未关联产线

**发现位置**: 数据库查询

**问题描述**:
- 站点组 `SMT-LINE-A` 和 `DIP-LINE-A` 的产线显示为"无"
- 但 Run 选择了 `DIP Production Line A` 产线
- 站点组与产线未正确关联

**数据现状**:
```
站点组: SMT-LINE-A (产线: 无)
站点组: DIP-LINE-A (产线: 无)

Run 产线: DIP Production Line A
Run 路由工序站点组ID: cmk530qgm0009h3lcrhqoun0z (应该是 DIP-LINE-A)
```

**建议修复**:
1. Seed 数据中正确设置站点组的 lineId
2. 确保 DIP-LINE-A 关联到 DIP Production Line A

**优先级**: P2 (数据配置问题)

---

### 问题 #17: Run 完成状态未自动更新

**发现位置**: Run 详情页

**问题描述**:
- 用户走完 10 个单件中的 1 个（状态变为 DONE）
- 删除剩余 9 个单件
- 此时 Run 应该自动变为 COMPLETED（因为所有现存单件都完成了）
- 但 Run 状态仍然是 IN_PROGRESS

**问题分析**:
1. 出站时可能只更新单件状态，未检查 Run 是否应该完成
2. 删除单件后未触发 Run 状态重新计算
3. Run 完成条件检查逻辑可能缺失或有 bug

**建议修复**:
1. 出站完成时检查：如果所有单件都完成，自动将 Run 设为 COMPLETED
2. 提供手动"完成 Run"按钮（用于异常情况）
3. 删除单件后也应触发状态检查

**优先级**: P1 (Run 生命周期不完整)

---

<!-- 后续问题将追加在此 -->
