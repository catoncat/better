# 外部集成降级模式 SOP

> **适用场景**：当 MES 依赖的外部系统（TPM/WMS/SPI/AOI 等）不可用时，本文档提供标准化的降级操作流程。

---

## 1. 概述

### 1.1 MES 外部集成点

| 外部系统 | 集成内容 | 影响的 MES 功能 | 降级优先级 |
|----------|----------|-----------------|------------|
| **TPM** | 钢网状态、设备维护 | Readiness 检查（钢网就绪） | P1 |
| **WMS** | 锡膏状态、物料有效期 | Readiness 检查（锡膏合规） | P1 |
| **SPI** | 锡膏印刷检测结果 | FAI、过程检验 | P2 |
| **AOI** | 贴片检测结果 | FAI、过程检验 | P2 |

### 1.2 降级模式原则

1. **生产优先**：外部系统故障不应阻断生产
2. **数据可追溯**：手动录入数据标记 `source: MANUAL`
3. **权限管控**：降级操作需对应权限
4. **及时恢复**：系统恢复后尽快切回自动模式

### 1.3 新增检查项及其降级方式

以下是新增的准备检查项及其降级处理方式：

| 检查项 | 正常数据来源 | 降级方式 | 操作人 |
|--------|-------------|----------|--------|
| PREP_STENCIL_CLEAN | StencilCleaningRecord | 手动录入清洗记录 | 操作员 |
| PREP_SCRAPER | SqueegeeUsageRecord | 手动录入点检记录 | 操作员 |
| PREP_FIXTURE | FixtureUsageRecord | 手动录入使用记录 | 操作员 |
| PREP_PROGRAM | ReflowProfile 校验 | 人工确认程式一致 → 豁免 | 工艺工程师 |
| TIME_RULE | TimeRuleInstance | 质量确认后豁免 | 质量经理 |

---

## 2. TPM 集成降级（钢网/设备状态）

### 2.1 故障识别

**症状**：
- Readiness 检查的"钢网就绪"项显示"无法获取状态"
- 集成监控页 `/mes/integration/monitor` 显示 TPM 连接失败

### 2.2 降级操作

| 步骤 | 操作 | 操作人 | 页面路径 |
|------|------|--------|----------|
| 1 | 确认 TPM 系统不可用 | 产线组长 | `/mes/integration/monitor` |
| 2 | 进入手动录入页面 | 产线组长 | `/mes/integration/manual-entry` |
| 3 | 选择"钢网状态"录入类型 | 产线组长 | - |
| 4 | 填写：钢网编号 + 确认状态（READY/NOT_READY） | 产线组长 | - |
| 5 | 提交并确认录入成功 | 产线组长 | - |
| 6 | 返回 Run 详情页重新执行 Readiness 检查 | 产线组长 | `/mes/runs/{runNo}` |

**录入字段说明**：
- **钢网编号**：与实际使用的钢网编号一致
- **确认状态**：
  - `READY` - 钢网已完成张力检测和清洗，可用于生产
  - `NOT_READY` - 钢网不满足生产条件

### 2.3 恢复操作

| 步骤 | 操作 | 操作人 |
|------|------|--------|
| 1 | 确认 TPM 系统恢复 | 产线组长 |
| 2 | 在集成监控页验证连接状态 | 产线组长 |
| 3 | 后续 Run 自动使用 TPM 数据 | 系统自动 |

> **注意**：手动录入的数据不会被 TPM 恢复后的自动数据覆盖，已录入的 Run 保持手动数据。

### 2.4 权限要求

| 操作 | 所需权限 | 拥有角色 |
|------|----------|----------|
| 手动录入钢网状态 | `readiness:check` | 产线组长、工艺工程师 |
| 查看集成监控 | `system:integration` | 工艺工程师、管理员 |

### 2.5 审计记录

手动录入后系统自动记录：
- 操作时间
- 操作人
- 录入内容
- 数据来源标记：`source: MANUAL`

---

## 3. WMS 集成降级（锡膏状态）

### 3.1 故障识别

**症状**：
- Readiness 检查的"锡膏合规"项显示"无法获取状态"
- 集成监控页显示 WMS 连接失败

### 3.2 降级操作

| 步骤 | 操作 | 操作人 | 页面路径 |
|------|------|--------|----------|
| 1 | 确认 WMS 系统不可用 | 产线组长 | `/mes/integration/monitor` |
| 2 | 进入手动录入页面 | 产线组长 | `/mes/integration/manual-entry` |
| 3 | 选择"锡膏状态"录入类型 | 产线组长 | - |
| 4 | 填写：锡膏批次号 + 确认状态（COMPLIANT/NON_COMPLIANT） | 产线组长 | - |
| 5 | 提交并确认录入成功 | 产线组长 | - |
| 6 | 返回 Run 详情页重新执行 Readiness 检查 | 产线组长 | `/mes/runs/{runNo}` |

**录入字段说明**：
- **锡膏批次号**：与实际使用的锡膏批次一致
- **确认状态**：
  - `COMPLIANT` - 锡膏在有效期内，已完成回温搅拌
  - `NON_COMPLIANT` - 锡膏不满足使用条件

### 3.3 恢复操作

与 TPM 恢复操作相同。

### 3.4 权限要求

| 操作 | 所需权限 | 拥有角色 |
|------|----------|----------|
| 手动录入锡膏状态 | `readiness:check` | 产线组长、工艺工程师 |

---

## 4. SPI 集成降级（锡膏印刷检测）

### 4.1 故障识别

**症状**：
- SPI 工位出站时无法自动获取检测结果
- 集成监控页显示 SPI 数据采集失败

### 4.2 降级操作

| 步骤 | 操作 | 操作人 | 页面路径 |
|------|------|--------|----------|
| 1 | 确认 SPI 设备/采集系统不可用 | 操作员 | 工位执行页 |
| 2 | 在 SPI 工位完成作业后点击"检测结果录入" | 操作员 | `/mes/execution` |
| 3 | 选择检测类型：SPI | 操作员 | - |
| 4 | 选择检测结果：PASS / FAIL | 操作员 | - |
| 5 | 如 FAIL，记录：不良代码 + 不良位置 + 描述 | 操作员 | - |
| 6 | 提交并继续出站流程 | 操作员 | - |

**录入时机**：
- 操作员在 SPI 设备上完成实际检测
- 手动查看检测结果后录入 MES

### 4.3 恢复操作

| 步骤 | 操作 | 操作人 |
|------|------|--------|
| 1 | 确认 SPI 数据采集恢复 | 工艺工程师 |
| 2 | 在集成监控页验证数据同步 | 工艺工程师 |
| 3 | 后续 TrackOut 自动获取 SPI 结果 | 系统自动 |

### 4.4 权限要求

| 操作 | 所需权限 | 拥有角色 |
|------|----------|----------|
| 手动录入 SPI 结果 | `exec:track_out` | 操作员、产线组长 |

### 4.5 审计记录

- 检测结果标记：`source: MANUAL`
- 记录录入时间、操作人、检测类型

---

## 5. AOI 集成降级（贴片检测）

### 5.1 故障识别

**症状**：
- AOI 工位出站时无法自动获取检测结果
- 集成监控页显示 AOI 数据采集失败

### 5.2 降级操作

与 SPI 降级操作相同，选择检测类型为 AOI。

### 5.3 恢复操作

与 SPI 恢复操作相同。

### 5.4 权限要求

与 SPI 权限要求相同。

---

## 6. Readiness 豁免（最后手段）

当手动录入仍无法解决问题时，可考虑豁免检查项。

### 6.1 适用场景

- 外部系统长时间不可用
- 手动录入功能也无法正常工作
- 生产紧急需要继续

### 6.2 豁免操作

| 步骤 | 操作 | 操作人 | 页面路径 |
|------|------|--------|----------|
| 1 | 在 Run 详情页找到失败的检查项 | 产线组长 | `/mes/runs/{runNo}` |
| 2 | 点击检查项旁的"豁免"按钮 | 产线组长 | - |
| 3 | 填写豁免原因（必填） | 产线组长 | - |
| 4 | 确认豁免 | 产线组长 | - |
| 5 | 重新执行 Readiness 检查确认通过 | 产线组长 | - |

### 6.3 权限要求

| 操作 | 所需权限 | 拥有角色 |
|------|----------|----------|
| 豁免检查项 | `prep:waive` | 产线组长、质量工程师、工艺工程师 |

### 6.4 审计要求

豁免操作会记录：
- 豁免时间
- 豁免人
- 豁免原因
- 被豁免的检查项

> **警告**：豁免应作为最后手段使用，豁免记录将在追溯报告中显示。

---

## 7. 时间规则降级处理（新增）

当时间规则监控出现异常或规则超时时的处理方式。

### 7.1 时间规则类型

| 规则 | 时限 | 说明 |
|------|------|------|
| 锡膏暴露时间 | 24 小时 | 锡膏开封后必须在 24 小时内使用完毕 |
| 水洗时间 | 4 小时 | 回流焊后必须在 4 小时内完成水洗 |

### 7.2 时间规则超时处理

| 步骤 | 操作 | 操作人 | 页面路径 |
|------|------|--------|----------|
| 1 | 确认时间规则已超时 | 质量工程师 | Run 详情页/时间规则监控页 |
| 2 | 评估影响：锡膏质量/板子状态 | 质量工程师 | - |
| 3 | 若质量可接受，点击"豁免" | 质量经理 | `/api/time-rules/:id/waive` |
| 4 | 填写豁免原因（说明已确认质量） | 质量经理 | - |
| 5 | 确认豁免 | 质量经理 | - |

### 7.3 权限要求

| 操作 | 所需权限 | 拥有角色 |
|------|----------|----------|
| 豁免时间规则 | `time_rule:override` | 厂长、质量经理 |

### 7.4 豁免后处理

- 锡膏超时豁免后：记录豁免原因，锡膏可继续使用
- 水洗超时豁免后：记录豁免原因，板可继续流转

> **注意**：时间规则豁免需要更高权限（`time_rule:override`），通常由厂长或质量经理操作。

---

## 8. 维修相关的降级处理（新增）

当实体处于维修状态导致 Readiness 检查失败时的处理方式。

### 8.1 故障识别

**症状**：
- PREP_STENCIL_USAGE/PREP_FIXTURE 检查项失败
- 提示"实体正在维修中"

### 8.2 处理方式

| 场景 | 处理方式 | 操作人 |
|------|----------|--------|
| 维修即将完成 | 等待维修验证通过后重新检查 | 产线组长 |
| 有替代实体 | 更换为其他可用实体 | 操作员 |
| 紧急生产 | 取消维修记录（需确认实体可用） | 维修主管 |

### 8.3 更换实体后的操作

1. 使用可用的替代实体（如备用钢网）
2. 更新 Run 的实体绑定
3. 重新执行 Readiness 检查

---

## 7. 降级决策流程图

```
外部系统不可用
       │
       ▼
确认故障（集成监控页）
       │
       ▼
┌──────┴──────┐
│ TPM/WMS     │ SPI/AOI
│ (Readiness) │ (检测结果)
└──────┬──────┘     │
       │            │
       ▼            ▼
手动录入状态     手动录入检测结果
(产线组长)       (操作员)
       │            │
       ▼            ▼
重新执行检查     继续出站流程
       │            │
       ├────────────┤
       ▼
   检查通过？
       │
   ├─ 是 → 继续生产
   │
   └─ 否 → 考虑豁免
            (需填写原因)
```

---

## 8. 监控与告警

### 8.1 集成状态监控

- **监控页面**：`/mes/integration/monitor`
- **刷新频率**：实时
- **显示内容**：
  - 各外部系统连接状态（在线/离线）
  - 最近同步时间
  - 错误日志

### 8.2 告警通知

| 告警类型 | 触发条件 | 通知对象 |
|----------|----------|----------|
| 连接失败 | 外部系统连接中断 | 工艺工程师、管理员 |
| 同步失败 | 数据同步出错 | 工艺工程师 |
| 降级使用 | 启用手动录入 | 产线组长、质量工程师 |

---

## 9. 常见问题

### Q1: 手动录入的数据会被自动数据覆盖吗？
> 不会。已手动录入的数据保持不变，仅后续新数据使用自动采集。

### Q2: 如何识别哪些数据是手动录入的？
> 在追溯页面和报表中，手动录入的数据会标记 `MANUAL`，自动采集的标记 `AUTO`。

### Q3: 豁免后如何补录正确数据？
> 豁免是终态操作，无法撤销。如需补录，可在备注中说明实际情况。

### Q4: 降级模式下 FAI 怎么处理？
> FAI 可正常进行，检测结果（SPI/AOI）通过手动录入方式记录。

### Q5: 多久算"长时间不可用"？
> 建议：超过 4 小时可考虑豁免。具体根据生产紧迫程度判断。

---

## 10. 相关文档

- [物料员操作指南](./05_material.md) - 详细的上料操作说明
- [操作员操作指南](./06_operator.md) - 详细的操作员操作说明
- [工艺工程师操作指南](./03_engineer.md) - 集成配置说明
- [演示指南](./demo/guide.md) - 系统演示流程

---

## 修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|----------|
| 1.0 | 2026-01-13 | System | 初始版本，整合现有降级模式文档 |
