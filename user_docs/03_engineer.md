# 工艺工程师 (Engineer) 操作指南

## 角色概述

工艺工程师负责生产路由的设计和配置，定义产品的制造工序、检验规范、数据采集要求等。

| 属性 | 值 |
|------|-----|
| 角色代码 | `engineer` |
| 数据范围 | 全部 (ALL) |
| 默认首页 | `/mes/routes` |

## 权限清单

### 路由管理
- ✓ 查看路由 (`route:read`)
- ✓ 配置路由 (`route:configure`)
- ✓ 编译路由 (`route:compile`)
- ✓ 创建路由 (`route:create`)

### 集成管理
- ✓ 集成管理 (`system:integration`) — 用于同步 ERP 物料/工艺数据

### 其他
- ✓ 查看工单 (`wo:read`)
- ✓ 查看批次 (`run:read`)
- ✓ 追溯查询 (`trace:read`)

## 可访问菜单

```
生产执行
├── 工单管理      /mes/work-orders     [只读]
├── 批次管理      /mes/runs            [只读]
├── 路由管理      /mes/routes          [完整操作]
├── 路由版本      /mes/route-versions  [完整操作]
└── 追溯查询      /mes/trace           [只读]

系统管理
└── 集成管理      /system/integrations [完整操作]

通知中心          /notifications
```

---

## 核心功能操作

### 1. 路由管理

#### 1.1 查看路由列表
1. 导航至 **生产执行 → 路由管理**
2. 使用筛选条件：
   - 产品型号
   - 路由状态
   - 创建日期
3. 点击路由行查看详情

#### 1.2 创建新路由
1. 点击 **新建路由** 按钮
2. 填写基本信息：
   - 路由代码（唯一标识）
   - 路由名称
   - 关联产品
   - 描述
3. 保存后进入路由配置页面

#### 1.3 配置路由工序
进入路由详情后，配置工序流程：

##### 添加工序节点
1. 在流程图区域点击 **添加工序**
2. 配置工序信息：
   - 工序代码
   - 工序名称
   - 工序类型（加工/检验/返工）
   - 所属工位

##### 连接工序
1. 从源工序拖拽连线到目标工序
2. 设置流转条件（如需要）：
   - 默认流转
   - 条件分支（基于检验结果等）

##### 配置工序语义
每个工序可配置：

**数据采集点**
- 参数名称
- 数据类型（数值/文本/选项）
- 规格上下限（如适用）
- 是否必填

**准备检查项**
- 检查项名称
- 检查类型（人员资质/设备校准/物料确认等）
- 是否可豁免

**作业指导书**
- 上传 SOP 文档
- 关联图片/视频

#### 1.4 编译路由版本
路由配置完成后需要编译发布：

1. 确认路由配置完整
2. 点击 **编译** 按钮
3. 系统验证：
   - 工序连接完整性
   - 必填配置项
   - 逻辑一致性
4. 编译成功后生成新版本

> **说明**: 编译后的版本不可修改，如需变更需创建新版本。

---

### 2. 路由版本管理

#### 2.1 查看版本历史
1. 导航至 **生产执行 → 路由版本**
2. 或在路由详情页查看版本列表
3. 查看各版本：
   - 版本号
   - 状态（草稿/已发布/已废弃）
   - 创建时间
   - 创建人

#### 2.2 版本状态管理

**发布版本**
1. 选择已编译的版本
2. 点击 **发布**
3. 确认发布

> 发布后该版本可被工单关联使用

**废弃版本**
1. 选择需要废弃的版本
2. 点击 **废弃**
3. 填写废弃原因
4. 确认废弃

> 已废弃版本不能再被新工单使用，但历史工单不受影响

#### 2.3 创建新版本
1. 从现有版本复制
2. 或从草稿编辑后编译
3. 新版本号自动递增

---

### 3. 集成管理

工艺工程师负责配置外部系统与 MES 的集成接口。

#### 3.1 集成接口概览

| 接口类型 | 外部系统 | 数据内容 | 用途 |
|----------|----------|----------|------|
| 钢网状态 | TPM | 钢网就绪状态、张力值 | 就绪检查卡控 |
| 锡膏状态 | WMS | 锡膏合规状态、有效期 | 就绪检查卡控 |
| SPI 结果 | SCADA | 锡膏印刷检测结果 | 首件/过程检验 |
| AOI 结果 | SCADA | 贴片检测结果 | 首件/过程检验 |

#### 3.2 配置集成接口
1. 导航至 **系统管理 → 集成管理**
2. 选择要配置的接口类型
3. 配置连接参数：
   - 接口地址
   - 认证方式
   - 超时设置
4. 点击 **测试连接**
5. 启用/禁用接口

#### 3.3 手动降级模式

当外部系统不可用时，MES 支持手动降级：

| 场景 | 降级方式 | 操作人 |
|------|----------|--------|
| TPM 不可用 | 手动录入钢网就绪状态 | 产线组长 |
| WMS 不可用 | 手动录入锡膏合规状态 | 产线组长 |
| SPI/AOI 不可用 | 手动录入检测结果 | 操作员 |

> **审计说明**: 手动录入的数据会标记 `source: MANUAL`，便于区分自动采集和人工录入。

#### 3.4 ERP 物料同步
1. 导航至 **系统管理 → 集成管理**
2. 选择 ERP 集成
3. 配置物料同步：
   - 同步频率
   - 字段映射
   - 过滤条件

#### 3.5 工艺数据同步
1. 配置 BOM 同步
2. 配置工艺路线同步
3. 测试同步
4. 查看同步日志

---

## 工作流程

### 新产品路由开发流程

```
接收产品工艺需求
        │
        ▼
创建路由 ──→ 配置工序节点
        │
        ▼
配置每个工序：
    ├── 数据采集点
    ├── 准备检查项
    └── 作业指导书
        │
        ▼
验证路由逻辑
        │
        ▼
编译生成版本
        │
        ▼
测试验证（试产）
        │
        ▼
正式发布版本
```

### 路由变更流程

```
识别变更需求
        │
        ▼
评估影响范围（在制批次）
        │
        ▼
创建新版本
        │
        ▼
修改配置
        │
        ▼
编译 & 验证
        │
        ▼
废弃旧版本（可选）
        │
        ▼
发布新版本
```

---

## 常见场景

### 场景1: 新产品导入
1. 从 ERP 同步产品主数据
2. 创建路由并配置完整工序
3. 配置各工序的数据采集和检查项
4. 编译并发布版本
5. 通知计划员可以创建工单

### 场景2: 工艺变更 (ECN)
1. 分析变更内容对路由的影响
2. 基于当前版本创建新版本
3. 修改受影响的工序配置
4. 编译验证后发布
5. 通知相关人员新版本已生效

### 场景3: 生产问题反馈
1. 收到现场工艺问题反馈
2. 分析问题根因
3. 调整路由配置（如调整参数规格）
4. 发布新版本

---

### 4. 准备检查项配置

工艺工程师负责配置生产准备检查项（Readiness），确保生产前所有条件就绪。

#### 4.1 准备检查项类型

系统支持以下准备检查项：

| 检查项代码 | 说明 | 数据来源 |
|-----------|------|----------|
| ROUTE | 路由版本可用 | 路由编译状态 |
| STENCIL | 钢网已绑定 | 线体钢网绑定 |
| SOLDER_PASTE | 锡膏已扫码 | 锡膏状态记录 |
| EQUIPMENT | 设备状态正常 | TPM/设备接口 |
| MATERIAL | 物料齐套 | 物料主数据+BOM |
| LOADING | 上料完成 | 上料记录 |
| PREP_BAKE | PCB 烘烤确认 | BakeRecord |
| PREP_PASTE | 锡膏准备（使用记录） | SolderPasteUsageRecord |
| PREP_STENCIL_USAGE | 钢网使用准备 | StencilUsageRecord |
| PREP_STENCIL_CLEAN | 钢网清洗准备 | StencilCleaningRecord |
| PREP_SCRAPER | 刮刀点检准备 | SqueegeeUsageRecord |
| PREP_FIXTURE | 夹具寿命准备 | FixtureUsageRecord |
| PREP_PROGRAM | 炉温程式检查（期望程式可用） | ReflowProfile |
| TIME_RULE | 时间规则状态 | TimeRuleInstance |

#### 4.2 配置产线检查项

1. 导航至 **系统管理 → 产线配置**
2. 选择目标产线
3. 在"就绪检查配置"区域：
   - 启用/禁用各检查项
4. 保存配置

> **说明**: 未配置时默认启用全部检查项；页面同时支持维护工艺类型（用于工单路由匹配校验）。
> **说明**: 当前系统未限制不可豁免项，豁免权限由 `readiness:override` 控制。

---

### 5. 时间规则配置

时间规则用于监控 SMT 产线中各类时效性要求，如锡膏暴露时间、水洗时间等。

#### 5.1 时间规则类型

| 规则代码 | 说明 | 时限 | 预警时间 |
|---------|------|------|----------|
| SOLDER_PASTE_24H | 锡膏暴露时间限制 | 24 小时 | 提前 2 小时 |
| POST_REFLOW_WASH_4H | 回流焊后水洗时限 | 4 小时 | 提前 30 分钟 |

#### 5.2 锡膏暴露规则说明

- **触发事件**: 锡膏开封（扫码录入）
- **完成事件**: 锡膏消耗完毕
- **超时处理**: 超过 24 小时未使用完的锡膏需报废或豁免

#### 5.3 水洗时间规则说明

- **前提条件**: 路由配置了水洗工序
- **触发事件**: 回流焊 TrackOut
- **超时处理**: 超过 4 小时未进行水洗需特殊处理

#### 5.4 配置时间规则

1. 导航至 **系统管理 → 时间规则**
2. 查看预定义规则或创建自定义规则
3. 配置规则参数：
   - 时限（分钟）
   - 预警时间
   - 作用域（全局/产线/路由/产品）
   - 是否可豁免
4. 启用规则

> **说明**: 时间规则目前仅适用于 SMT 产线，DIP 产线暂无时间规则应用场景。

---

### 6. 炉温程式配置

炉温程式（Reflow Profile）用于管理回流焊设备的温区参数配置，确保焊接质量一致性。

#### 6.1 查看程式列表

1. 导航至 **生产执行 → 炉温程式** (`/mes/reflow-profiles`)
2. 查看程式列表：
   - 程式代码
   - 版本号
   - 状态（ACTIVE/INACTIVE/DEPRECATED）
   - 温区配置

#### 6.2 创建炉温程式

1. 点击 **新建程式**
2. 填写基本信息：
   - 程式代码（用于设备匹配）
   - 程式名称
   - 版本号
3. 配置温区参数：
   - 预热区温度/时间
   - 保温区温度/时间
   - 回流区温度/时间
   - 冷却区温度/时间
4. 设置规格限：
   - 峰值温度范围
   - 总时间范围
5. 保存并激活

#### 6.3 程式与路由关联

在路由配置中，为回流焊工序指定期望的炉温程式：

1. 编辑路由中的回流焊工序
2. 选择期望的炉温程式
3. 保存并重新编译路由

#### 6.4 程式校验（当前实现）

当前系统仅在 Readiness 检查中生成 PREP_PROGRAM 项：
- 校验期望程式是否存在且为 ACTIVE
- 执行时校验设备实际程式未实现

若期望程式不可用，PREP_PROGRAM 将 FAIL 并阻断授权。

#### 6.5 程式版本管理

1. 创建新版本程式（保留旧版本追溯）
2. 将旧版本状态改为 DEPRECATED
3. 更新路由的期望程式
4. 重新编译路由

---

## 路由配置最佳实践

### 1. 工序设计原则
- **粒度适中**: 不要过细导致操作繁琐，也不要过粗失去管控
- **清晰命名**: 使用规范的工序代码和名称
- **完整文档**: 每个工序都应有对应的作业指导书

### 2. 数据采集设计
- **有价值的数据**: 只采集对质量追溯有意义的参数
- **合理的规格**: 规格上下限应基于工艺能力设定
- **标准化**: 同类工序使用统一的采集规范

### 3. 版本管理
- **版本说明**: 每个版本都应有清晰的变更说明
- **及时废弃**: 不再使用的版本应及时废弃
- **向后兼容**: 考虑在制批次的影响

---

## 与其他角色的协作

| 协作角色 | 协作内容 |
|----------|----------|
| 生产计划员 | 确认路由版本可用性，工单关联 |
| 产线组长 | 工艺问题反馈，现场执行确认 |
| 质量工程师 | 检验规范配置，质量参数设定 |
| 操作员 | 作业指导书可用性反馈 |

---

## 注意事项

1. **版本控制**: 编译后的版本不可修改，确保配置正确再编译
2. **在制影响**: 变更路由时注意对在制批次的影响
3. **同步验证**: ERP 同步后检查数据完整性
4. **文档更新**: 路由变更后同步更新相关工艺文档
