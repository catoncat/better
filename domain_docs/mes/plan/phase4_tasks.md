# Phase 4 Plan (M4 - Ingest & Automation)

> çŠ¶æ€ï¼šè‰æ¡ˆï¼ˆå¾…ç¡®è®¤èŒƒå›´ï¼‰
> æ›´æ–°æ—¶é—´ï¼š2026-01-24
> ç›®æ ‡ï¼šåœ¨ä¸ç ´å M3 ä¸Šçº¿é»˜è®¤"äººå·¥ TrackIn/TrackOut"çš„å‰æä¸‹ï¼Œè¡¥é½ AUTO/BATCH/TEST çš„ ingest æ‰§è¡Œé—­ç¯ï¼Œå¹¶ä¸ºåç»­å›ä¼ /è‡ªåŠ¨åŒ–æ‰©å±•æä¾›ç¨³å®šæ¥å£ã€‚

---

## 0. å‰ç½®æ¡ä»¶ï¼ˆAcceptance éªŒæ”¶ä¼˜å…ˆï¼‰

åœ¨å¼€å§‹æœ¬é˜¶æ®µå¼€å‘å‰ï¼Œå½“å‰æœ€ç´§æ€¥ä»»åŠ¡æ˜¯**è·‘å…¨æµç¨‹éªŒæ”¶**ï¼ˆå°¤å…¶å‰ç«¯é›†æˆ/UI æ“ä½œé“¾è·¯ï¼‰ï¼ŒæŠŠé˜»æ–­æ€§é—®é¢˜æ”¶æ•›åˆ°å¯å¤ç°æ¸…å•å¹¶ä¿®å¤/ç¡®è®¤ã€‚

- éªŒæ”¶è®¡åˆ’ï¼š`user_docs/demo/acceptance_plan.md`
- éªŒæ”¶è®¡åˆ’ï¼ˆDIPï¼‰ï¼š`user_docs/demo/acceptance_plan_dip.md`
- é—®é¢˜è·Ÿè¸ªï¼š`user_docs/demo/acceptance_issues.md`

**åŸåˆ™**ï¼šæœªå®ŒæˆéªŒæ”¶ï¼ˆæˆ–ä»å­˜åœ¨ P0 é˜»æ–­é—®é¢˜ï¼‰æ—¶ï¼Œä¸å»ºè®®æ¨è¿›åç»­å®ç°å¼€å‘ã€‚

---

## 1. èŒƒå›´çº¦æŸ

### 1.1 In-Scopeï¼ˆæœ¬æœŸäº¤ä»˜ï¼‰

- **Ingest äº‹ä»¶æ¥å…¥**ï¼šæ”¯æŒ AUTO/BATCH/TEST äº‹ä»¶å†™å…¥ï¼ˆå¹‚ç­‰ã€å¯å›æ”¾ã€å¯å®¡è®¡ï¼‰
- **æ‰§è¡Œé—­ç¯**ï¼šåŸºäº `ingestMapping` å°†äº‹ä»¶æ˜ å°„ä¸ºæ‰§è¡Œç»“æœï¼ˆTracks/CarrierTracks + DataValues + PASS/FAILï¼‰
- **è¿½æº¯è¦†ç›–**ï¼šTrace å¯å‘ˆç°"æ‰‹å·¥ Track"ä¸"ingest äº‹ä»¶"æ¥æºï¼Œä¸”ä¸å†»ç»“ routeVersion snapshot å¯¹é½
- **å›å½’ä¿æŠ¤**ï¼šä¸å½±å“æ—¢æœ‰ MANUAL TrackIn/TrackOut + è´¨é‡é—­ç¯ï¼ˆM2ï¼‰ä¸ä¸Šçº¿éªŒæ”¶è„šæœ¬ï¼ˆM3ï¼‰

### 1.2 Non-Goalsï¼ˆåç»­/æŒ‰éœ€ï¼‰

- å›ä¼ /outbound feedbackï¼šTBDï¼Œå»ºè®®ç‹¬ç«‹æ¨è¿›ï¼Œé¿å…é˜»å¡ ingest é—­ç¯
- å¤§è§„æ¨¡æŠ¥è¡¨/çœ‹æ¿ï¼ˆBI/ç»Ÿè®¡ï¼‰
- è®¾å¤‡å®æ—¶æ§åˆ¶é—­ç¯ï¼ˆé ingest èŒƒç•´ï¼‰

---

## 2. éªŒæ”¶æ ‡å‡†

P0ï¼ˆå¿…é¡»ï¼‰ï¼š
- [ ] Ingest API æ”¯æŒå¹‚ç­‰ï¼ˆdedupeKeyï¼‰ï¼Œé‡å¤ä¸ŠæŠ¥ä¸äº§ç”Ÿé‡å¤å‰¯ä½œç”¨
- [ ] AUTO/TEST step èƒ½é€šè¿‡ ingestMapping è‡ªåŠ¨å†™å…¥ DataValueï¼Œå¹¶äº§ç”Ÿå¯è¿½æº¯çš„æ‰§è¡Œäº‹ä»¶/ç»“æœ
- [ ] Trace API èƒ½å±•ç¤º ingest äº‹ä»¶æ¥æºã€æ˜ å°„åçš„ç»“æœã€ä»¥åŠå¯¹åº”çš„ routeVersionï¼ˆå†»ç»“ï¼‰
- [ ] ç°æœ‰ MANUAL æ‰§è¡Œè·¯å¾„ä¸ `bun apps/server/scripts/test-mes-flow.ts` ä»ç¨³å®šé€šè¿‡ï¼ˆå›å½’ï¼‰

---

## 3. ä»»åŠ¡æ¸…å•

### 3.1 Ingest åˆçº¦å®šä¹‰

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.1.1 | å®šä¹‰ IngestEvent åˆçº¦ï¼ˆå­—æ®µã€å¹‚ç­‰é”®ã€æ¥æºç³»ç»Ÿã€æ—¶é—´æˆ³ã€payload çº¦æŸï¼‰ | âœ… | - | |
| T4.1.2 | å®šä¹‰/æ”¶æ•› `ingestMapping` ç»“æ„ï¼ˆå¦‚ä½•æå– sn/station/time/result/measurementsï¼‰ | âœ… | T4.1.1 | |
| T4.1.3 | è¡¥å…… M4 éªŒæ”¶åœºæ™¯ï¼ˆAUTO/TEST æœ€å°é—­ç¯ï¼›å«å›æ”¾/å¹‚ç­‰/è¿½æº¯æ–­è¨€ï¼‰ | âœ… | T4.1.1 | |

### 3.2 Ingest å­˜å‚¨ä¸ API

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.2.1 | Schema: IngestEventï¼ˆæŒä¹…åŒ– + ç´¢å¼• + å»é‡ç­–ç•¥ + å¿…è¦å…³è”ï¼‰ | âœ… | T4.1.1 | |
| T4.2.2 | Server: Ingest APIï¼ˆcreate + idempotency + validation + error taxonomyï¼‰ | âœ… | T4.2.1 | |
| T4.2.3 | Service: raw persistence â†’ normalize/dispatchï¼ˆä¸ºåç»­æ‰§è¡Œ/è¿½æº¯ç•™æ‰©å±•ç‚¹ï¼‰ | âœ… | T4.2.2 | |
| T4.2.4 | Trace: äº‹ä»¶å¯æŸ¥è¯¢/å¯å…³è”ï¼ˆæœ€å°å­—æ®µå›æ˜¾ï¼Œæ”¯æŒå›æ”¾å®šä½ï¼‰ | âœ… | T4.2.3 | |

### 3.3 AUTO/TEST æ‰§è¡Œæ˜ å°„

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.3.1 | æ‰§è¡Œæ˜ å°„ï¼šæ ¹æ® routeVersion snapshot + ingestMapping è§£æäº‹ä»¶å¹¶å®šä½ step/unit | âœ… | T4.2.3 | |
| T4.3.2 | å†™å…¥ç»“æœï¼šç”Ÿæˆ Track/CarrierTrackï¼ˆå¦‚é€‚ç”¨ï¼‰+ DataValues + PASS/FAIL outcome | âœ… | T4.3.1 | |
| T4.3.3 | é—¨ç¦/ä¸€è‡´æ€§ï¼šstation constraint / step mismatch / required data æ ¡éªŒä¸å¯å®šä½é”™è¯¯ | âœ… | T4.3.2 | |
| T4.3.4 | Trace èšåˆï¼štrace è¾“å‡ºåŒ…å« ingest äº‹ä»¶ä¸å¯¹åº”çš„æ‰§è¡Œç»“æœ/æ•°æ®å€¼ | âœ… | T4.3.3 | |

### 3.4 Readiness é…ç½®ï¼ˆå¯é€‰ï¼ŒP1ï¼‰

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.4.1 | Readiness é…ç½®æ¨¡å‹ä¸ APIï¼ˆå¼€å…³/è§„åˆ™/é»˜è®¤å€¼å¯é…ç½®ï¼‰ | âœ… | - | as-built: `/lines/:lineId/readiness-config` (`line.meta.readinessChecks.enabled`) |
| T4.4.2 | Web é…ç½®é¡µï¼ˆå·¥ç¨‹å¸ˆ/ç®¡ç†å‘˜å¯æ“ä½œï¼›ä¸æƒé™/å®¡è®¡ä¸€è‡´ï¼‰ | âœ… | T4.4.1 | as-built: `/mes/readiness-config` |

### 3.5 Outbound Feedbackï¼ˆTBDï¼‰

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.5.1 | å®šä¹‰å›ä¼  payload åˆçº¦ï¼ˆå®Œæˆ/è´¨é‡/è¿½æº¯æ‘˜è¦ï¼›å¹‚ç­‰é”®ï¼‰ | âœ… | - | as-built: `spec/integration/02_integration_payloads.md` (Outbound `RUN_COMPLETION_V1`) |
| T4.5.2 | Outbox/é‡è¯•ç­–ç•¥ï¼ˆå¤±è´¥å›æ”¾ã€æ­»ä¿¡ã€å®¡è®¡ï¼‰ | âœ… | T4.5.1 | as-built: `MesEvent` outbox + retry API (`/api/integration/outbound/events`) |

### 3.6 SMT è¿½æº¯å¼ºåŒ–

> åŸºäº `compair/codex_smt_flow_deep_analysis.md` çš„å·¥ä½œåŒ…æ‹†åˆ†ä¸éªŒæ”¶è¦æ±‚ï¼Œèšç„¦ SMT è¿½æº¯åˆè§„ä¸è¡¨å•ç”µå­åŒ–ã€‚
>
> **æ¶æ„å†³ç­–**ï¼šè§ `conversation/2026-01-20_094100_MESäº§å“åŒ–æ¶æ„å†³ç­–.md`
> - ç°é˜¶æ®µæŒ‰éœ€ç¡¬ç¼–ç ï¼ˆæœ‰å¤æ‚å…³è”/æŸ¥è¯¢éœ€æ±‚æ—¶ï¼‰
> - çº¯è¡¨å•é‡‡é›†ä¼˜å…ˆè€ƒè™‘ DataCollectionSpec
> - ä¿ç•™ `meta` å­—æ®µä»¥å¤‡äº§å“åŒ–æ—¶æ‰©å±•

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.6.1 | å‰ç½®ç¡®è®¤ï¼šè¡¨å•å­—æ®µå¯¹é½ + æ—¶é—´çª—å£èµ·æ­¢äº‹ä»¶ + æ•°æ®æ¥æºç¡®è®¤ | âœ… | - | DoDï¼š`smt_forms/*.md` å­—æ®µç‰ˆæœ¬ç¡®è®¤ï¼ˆå·²å¯¹é½ç¡®è®¤è¡¨ï¼‰ |
| T4.6.2 | æ—¶é—´çª—å£è§„åˆ™ï¼ˆWP-1ï¼‰ï¼šå¯é…ç½®ï¼›è¶…æ—¶æé†’ + å¯è±å… | âœ… | T4.6.1 | è½¯é—¨ç¦ï¼Œä¸å¼ºåˆ¶é˜»æ–­ï¼›REFLOW/AOI TrackOut â†’ WASH TrackIn |
| T4.6.3 | çƒ˜çƒ¤è®°å½•ï¼ˆWP-2ï¼‰ | âœ… | - | BakeRecord æ•°æ®ç»“æ„ + UI è¡¨å• |
| T4.6.3.1 | çƒ˜çƒ¤è®°å½•è”åŠ¨ä¸è§„åˆ™ï¼ˆWP-2 åç»­ï¼‰ | âœ… | T4.6.3 | as-built: Readiness `PREP_BAKE`ï¼ˆ`apps/server/src/modules/mes/readiness/service.ts`ï¼‰ |
| T4.6.4 | é”¡è†ç”Ÿå‘½å‘¨æœŸï¼ˆWP-3ï¼‰ | âœ… | - | è§£å†»/å›æ¸©/æ…æ‹Œ/é¢†ç”¨/å›æ”¶å¯è¿½æº¯ |
| T4.6.4.1 | é”¡è†è®°å½•è”åŠ¨ï¼ˆWP-3 åç»­ï¼‰ | âœ… | T4.6.4 | as-built: Readiness `PREP_PASTE` + TimeRule `SOLDER_PASTE_24H`ï¼ˆ`apps/server/src/modules/mes/time-rule/*`ï¼‰ |
| T4.6.5 | é’¢ç½‘/åˆ®åˆ€å¯¿å‘½ï¼ˆWP-4ï¼‰ | âœ… | - | ä½¿ç”¨ä¸ç‚¹æ£€è®°å½•è½åœ° |
| T4.6.5.1 | é’¢ç½‘/åˆ®åˆ€å¯¿å‘½è”åŠ¨ï¼ˆWP-4 åç»­ï¼‰ | âœ… | T4.6.5 | as-built: Readiness `PREP_STENCIL_USAGE`/`PREP_SCRAPER` å¯¿å‘½é˜ˆå€¼é—¨ç¦ï¼ˆ`apps/server/src/modules/mes/readiness/service.ts`ï¼‰ |
| T4.6.6 | è½¬æ‹‰å‰æ£€æŸ¥æ¨¡æ¿åŒ–ï¼ˆWP-5ï¼‰ | âœ… | - | ReadinessCheck é™æ€æ¨¡æ¿è§†å›¾ï¼ˆæ—  DB å˜æ›´ï¼‰ |
| T4.6.7 | FAI ç­¾å­—ä¸æœ«ä»¶ï¼ˆWP-6ï¼‰ | âœ… | - | ç­¾å­—äººå¯è¿½æº¯ï¼ˆå•ç­¾ï¼‰ |
| T4.6.8 | è®¾å¤‡ç‚¹æ£€ï¼ˆWP-7ï¼‰ | âœ… | - | AOI/SPI è®¾å¤‡æ¯æ—¥ç‚¹æ£€è¡¨å•è½åœ° |
| T4.6.8.1 | è®¾å¤‡ç‚¹æ£€å¼‚å¸¸è”åŠ¨ï¼ˆWP-7 åç»­ï¼‰ | â¬œ | T4.6.8 | ç‚¹æ£€å¤±è´¥è§¦å‘å¼‚å¸¸åé¦ˆé“¾è·¯ |
| T4.6.9 | ç‚‰æ¸©ç¨‹å¼è®°å½•ï¼ˆWP-8ï¼‰ | âœ… | - | ç¨‹å¼ä½¿ç”¨è®°å½•å¯è½åœ° |
| T4.6.10 | æ¢æ–™è®°å½•å¢å¼ºï¼ˆWP-9ï¼‰ | âœ… | - | åŒ…è£…æ•°é‡ã€å®¡æ ¸äººå­—æ®µè½åœ° |
| T4.6.11 | æ—¥å¸¸ QC ä¸å¼‚å¸¸ï¼ˆWP-10ï¼‰ | âœ… | - | æ—¥å¸¸ QC ä¸ç”Ÿäº§å¼‚å¸¸è¡¨å•è½åœ° |
| T4.6.11.1 | æ—¥å¸¸ QC ç»Ÿè®¡ä¸å¼‚å¸¸é—­ç¯ï¼ˆWP-10 åç»­ï¼‰ | â¬œ | T4.6.11 | ç­æ¬¡/æ—¶é—´æ®µç»Ÿè®¡å¯ç”Ÿæˆ |
| T4.6.12 | å…¶å®ƒ SMT è¡¨å•ç¡®è®¤ä¸æ‹†åˆ† | âœ… | - | å·²ç¡®è®¤ï¼š`spec/process/compair/smt_form_collection_matrix.md`ï¼›åç»­ä»»åŠ¡è§ T4.6.12.1-2 |
| T4.6.12.1 | ç»´ä¿®è®°å½•è¡¨å•åŒ–ï¼ˆQR-Pro-012ï¼‰ | âœ… | - | æ‰« SN å½•å…¥ç»´ä¿®åŸå› /æªæ–½/ç»“æœï¼›å¯¹é½ Defect/ReworkTask |
| T4.6.12.2 | è®¾å¤‡æ•°é‡‡ï¼ˆå¯é€‰ï¼‰ï¼šç”Ÿäº§æ•°æ®/å‡ºå…¥æ•°ï¼ˆè´´ç‰‡æœºï¼‰ | âœ… | - | å¯¹æ¥è®¾å¤‡æ•°é‡‡æˆ–ä»¥ Track/DataValue æŠ¥è¡¨åŒ–ï¼ˆas-builtï¼šDeviceDataRecord + list UIï¼‰ |

### 3.7 äº§çº¿ç®¡ç†

| ID | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– | å¤‡æ³¨ |
|----|------|------|------|------|
| T4.7.1 | äº§çº¿ç®¡ç† APIï¼šåˆ—è¡¨/æ–°å»º/ç¼–è¾‘/åˆ é™¤ï¼ˆå¸¦ä¾èµ–æ ¡éªŒä¸æç¤ºï¼‰ | âœ… | - | |
| T4.7.2 | Web äº§çº¿ç®¡ç†é¡µé¢ï¼šåˆ—è¡¨ + æ–°å»º/ç¼–è¾‘/åˆ é™¤å…¥å£ä¸æƒé™æ§åˆ¶ | âœ… | T4.7.1 | |

çŠ¶æ€å›¾ä¾‹ï¼šâ¬œ å¾…å¼€å‘ / ğŸ”„ è¿›è¡Œä¸­ / âœ… å·²å®Œæˆ

---

## 4. å‚è€ƒæ–‡æ¡£

- `domain_docs/mes/plan/01_milestones.md`
- `domain_docs/mes/spec/routing/01_routing_engine.md`
- `domain_docs/mes/spec/routing/03_route_execution_config.md`
- `domain_docs/mes/spec/traceability/01_traceability_contract.md`
- `conversation/2026-01-14_115848_mes-next_triage.md`
- `conversation/2026-01-20_094100_MESäº§å“åŒ–æ¶æ„å†³ç­–.md` â† äº§å“åŒ–æ¶æ„å†³ç­–
- `domain_docs/mes/spec/architecture/01_product_abstraction.md` â† äº§å“åŒ–é€šç”¨æŠ€æœ¯æ–¹æ¡ˆ
- `user_docs/demo/acceptance_plan.md`
- `user_docs/demo/acceptance_issues.md`
- `domain_docs/mes/spec/process/compair/codex_smt_flow_deep_analysis.md`
