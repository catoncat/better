# SMT äº§çº¿æ‰§è¡Œæµç¨‹ (SMP Flow v2)

> **ç‰ˆæœ¬**: v2.3 - MES æ‰§è¡Œå±‚ + é›†æˆæ¥å£ç‰ˆ
> **åŸºäº**: 03_smp_flows_userfeeback_draft.md
> **è®¾è®¡åŸåˆ™**: MES ä¸“æ³¨æ‰§è¡Œå±‚ï¼Œå¤–éƒ¨ç³»ç»Ÿé€šè¿‡é›†æˆæ¥å£å¯¹æ¥ï¼Œæ”¯æŒæ‰‹åŠ¨é™çº§æ¨¡å¼
> **é‡Œç¨‹ç¢‘**: M1 åŸºç¡€çŠ¶æ€æœºï¼ŒM2 æ‰©å±•çŠ¶æ€/OQCï¼ŒM3 æ•°æ®é‡‡é›†

---

## å˜æ›´æ—¥å¿—

| ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|----------|
| v2.3 | ä¿®å¤è¿”ä¿® Run gatingã€è¡¥é½ InspectionResult å­—æ®µã€M3 æ ‡è®°ã€WO è§¦å‘ç‚¹è¯´æ˜ |
| v2.2 | ä¿®å¤ RUN çŠ¶æ€æ—¶åºã€API è·¯å¾„ã€UNIT çŠ¶æ€æ ‡æ³¨ã€M1/M2 æ ‡è®° |
| v2.1 | å¢åŠ é›†æˆæ¥å£è§„èŒƒã€æ‰‹åŠ¨é™çº§æ¨¡å¼ |
| v2.0 | MES ç³»ç»Ÿå¯¹é½ç‰ˆ |

---

## æ¶æ„å®šä½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MES æ‰§è¡Œå±‚ (æœ¬ç³»ç»Ÿ)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ å·¥å•/æ‰¹æ¬¡    â”‚ â”‚ TrackIn/Out  â”‚ â”‚ ä¸è‰¯/å¤„ç½®    â”‚            â”‚
â”‚  â”‚ çŠ¶æ€ç®¡ç†     â”‚ â”‚ æ‰§è¡Œè¿½æº¯     â”‚ â”‚ è´¨é‡å¡æ§     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ å°±ç»ªæ£€æŸ¥     â”‚ â”‚ ä¸Šæ–™é˜²é”™     â”‚ â”‚ OQC æŠ½æ£€     â”‚            â”‚
â”‚  â”‚ (å«é›†æˆå¡æ§) â”‚ â”‚ (MES æ ¸å¿ƒ)   â”‚ â”‚ (MES æ ¸å¿ƒ)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ é›†æˆæ¥å£ (è‡ªåŠ¨) / æ‰‹åŠ¨å½•å…¥ (é™çº§æ¨¡å¼) â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WMS/è¾…æ–™    â”‚  â”‚  TPM/å·¥è£…    â”‚  â”‚  SCADA/æ•°é‡‡  â”‚  â”‚   BI     â”‚
â”‚  é”¡è†çŠ¶æ€    â”‚  â”‚  é’¢ç½‘çŠ¶æ€    â”‚  â”‚  SPI/AOI     â”‚  â”‚  OEE     â”‚
â”‚  (æœªæ¥é›†æˆ)  â”‚  â”‚  (æœªæ¥é›†æˆ)  â”‚  â”‚  (æœªæ¥é›†æˆ)  â”‚  â”‚ (æœªæ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡åŸåˆ™**ï¼š
- MES åªå…³å¿ƒ **"æ˜¯å¦å¯ç”¨/æ˜¯å¦åˆæ ¼"** çš„ç»“è®º
- ä¸å…³å¿ƒå¤–éƒ¨ç³»ç»Ÿå¦‚ä½•å¾—å‡ºç»“è®º
- å¤–éƒ¨ç³»ç»Ÿæœªå°±ç»ªæ—¶ï¼Œæ”¯æŒæ‰‹åŠ¨å½•å…¥ä½œä¸ºé™çº§æ¨¡å¼

---

## ä¸»æµç¨‹å›¾

```mermaid
flowchart TD
    Start(["ERP/APS å·¥å•ä¸‹è¾¾"]) --> WO_RCV["å·¥å•æ¥æ”¶<br/>WO=RECEIVED"]
    WO_RCV --> WO_REL["å·¥å•é‡Šæ”¾<br/>WO=RELEASED"]
    WO_REL --> RUN_CREATE["åˆ›å»ºæ‰¹æ¬¡<br/>å†»ç»“è·¯ç”±ç‰ˆæœ¬"]
    RUN_CREATE --> A["SMTäº§çº¿å‡†å¤‡<br/>RUN=PREP"]

    subgraph A_Sub [å‡†å¤‡æµç¨‹ - å°±ç»ªæ£€æŸ¥]
        direction TB
        A1["ğŸ”Œ é’¢ç½‘å°±ç»ª [M2]<br/>â”œ è‡ªåŠ¨: è°ƒç”¨ TPM æ¥å£<br/>â”” æ‰‹åŠ¨: å½•å…¥æ£€æŸ¥ç»“æœ"]
        A2["ğŸ”Œ é”¡è†åˆè§„ [M2]<br/>â”œ è‡ªåŠ¨: è°ƒç”¨ WMS æ¥å£<br/>â”” æ‰‹åŠ¨: å½•å…¥åˆè§„ç¡®è®¤"]
        A3["ç‰©æ–™å¤‡æ–™<br/>â€¢ è½¦é—´åº“ç‰©æ–™æ‰«ç <br/>â€¢ ç‰©æ–™æ ¸å¯¹<br/>â€¢ æ ¸å¯¹æ ‡ç­¾SNèŒƒå›´"]
        A4["è®¾å¤‡å°±ç»ª<br/>â€¢ è´´ç‰‡ç¨‹åºåŠ è½½<br/>â€¢ è®¾å¤‡å‚æ•°è®¾ç½®"]

        A1 --> A2 --> A3 --> A4
    end

    A --> A1

    A4 --> P{å°±ç»ªæ£€æŸ¥é€šè¿‡?}
    P -- å¦ --> PEX["å¼‚å¸¸è®°å½•<br/>â€¢ å¼‚å¸¸ç¼–å·<br/>â€¢ å¡æ§é¡¹ç›®<br/>â€¢ è´£ä»»äºº"]
    PEX --> PEXR{é—®é¢˜è§£å†³?}
    PEXR -- æ˜¯ --> A1
    PEXR -- å¦ --> PESC["å‡çº§å¤„ç†"]
    PESC --> A1
    P -- æ˜¯ --> B["ä¸Šæ–™é˜²é”™<br/>(MES æ ¸å¿ƒ) [M2]"]

    subgraph B_Sub [é˜²é”™æµç¨‹ - MES æ ¸å¿ƒ]
        direction TB
        B1["åŠ è½½ç«™ä½è¡¨<br/>(MES ç»´æŠ¤)"]
        B2["æ‰«ç éªŒè¯<br/>ç‰©æ–™äºŒç»´ç  + ç«™ä½äºŒç»´ç "]
        B3["ç³»ç»Ÿæ¯”å¯¹<br/>BOM ç‰©æ–™ vs å®é™…ä¸Šæ–™"]
        B4{"éªŒè¯ç»“æœ"}
        B5["ç¡®è®¤ä¸Šæ–™<br/>è®°å½•ç»‘å®šå…³ç³»"]
        B6["æŠ¥è­¦é”å®š"]
        B7["å¼‚å¸¸å¤„ç†"]
        B8{é‡è¯•æ¬¡æ•°?}
        B9["äººå·¥ä»‹å…¥"]

        B1 --> B2 --> B3 --> B4
        B4 -- æ­£ç¡® --> B5
        B4 -- é”™è¯¯ --> B6
        B6 --> B7 --> B8
        B8 -- "<3æ¬¡" --> B2
        B8 -- ">=3æ¬¡" --> B9
        B9 --> B2
    end

    B --> B1
    B5 --> C["é¦–ä»¶ç¡®è®¤<br/>FAI=PENDING"]

    subgraph C_Sub [é¦–ä»¶æµç¨‹ - MES æ ¸å¿ƒ]
        direction TB
        C1["é¦–ä»¶ç”Ÿäº§<br/>ç”Ÿäº§2-3æ‹¼æ¿"]
        C2["ğŸ”Œ SPI ç»“æœ [M3]<br/>â”œ è‡ªåŠ¨: æ¥æ”¶æ•°é‡‡æ•°æ®<br/>â”” æ‰‹åŠ¨: å½•å…¥æ£€æµ‹ç»“æœ"]
        C3["å›æµç„Šæ¥"]
        C4["ğŸ”Œ AOI ç»“æœ [M3]<br/>â”œ è‡ªåŠ¨: æ¥æ”¶æ•°é‡‡æ•°æ®<br/>â”” æ‰‹åŠ¨: å½•å…¥æ£€æµ‹ç»“æœ"]
        C5["é¦–ä»¶åˆ¤å®š<br/>(MES æ±‡æ€»åˆ¤å®š)"]

        C1 --> C2 --> C3 --> C4 --> C5
    end

    C --> C1

    C5 --> D{"é¦–ä»¶åˆæ ¼?"}
    D -->|å¦| F["å‚æ•°è°ƒæ•´<br/>â€¢ åŸå› è®°å½•"]
    F --> FC{è¿ç»­å¤±è´¥?}
    FC -- "<3æ¬¡" --> C1
    FC -- ">=3æ¬¡" --> FE["å·¥ç¨‹å¸ˆä»‹å…¥"]
    FE --> C1
    D -->|æ˜¯| E["æ‰¹é‡ç”Ÿäº§æˆæƒ<br/>RUN=AUTHORIZED<br/>FAI=PASSED"]

    E --> G["æ‰¹é‡ç”Ÿäº§<br/>RUN=IN_PROGRESS"]

    subgraph G_Sub [æ‰§è¡Œè¿½æº¯ - MES æ ¸å¿ƒ]
        direction TB
        TI["TrackIn<br/>æ‰«ç è¿›ç«™<br/>UNIT=IN_STATION"]
        DC["ğŸ”Œ è¿‡ç¨‹æ•°æ® [M3]<br/>â”œ è‡ªåŠ¨: æ¥æ”¶æ•°é‡‡æ•°æ®<br/>â”” æ‰‹åŠ¨: å½•å…¥å…³é”®å‚æ•°"]
        TO["TrackOut<br/>å‡ºç«™åˆ¤å®š"]

        TI --> DC --> TO
    end

    G --> TI

    TO --> RES{PASS/FAIL?}
    RES -- PASS --> LAST{æœ«å·¥åº?}
    LAST -- å¦ --> ADV["æ¨è¿›è·¯ç”±<br/>UNIT=QUEUED"]
    ADV --> TI
    LAST -- æ˜¯ --> DONEU["å•ä»¶å®Œæˆ<br/>UNIT=DONE"]

    RES -- FAIL --> NG["ä¸è‰¯è®°å½•<br/>UNIT=OUT_FAILED<br/>â€¢ ä¸è‰¯ä»£ç <br/>â€¢ ä½ç½®æ ‡è®°"]

    NG --> DISP{å¤„ç½®æ–¹å¼?}
    DISP -- "è¿”ä¿® [M2]" --> RW["è¿”ä¿®ä»»åŠ¡<br/>UNIT â†’ è¿”ä¿®å·¥åº"]
    RW --> TI
    DISP -- "æŠ¥åºŸ [M2]" --> SC["æŠ¥åºŸç¡®è®¤<br/>UNIT=SCRAPPED"]
    DISP -- "éš”ç¦» [M2]" --> HOLD["éš”ç¦»<br/>UNIT=ON_HOLD"]
    HOLD --> MRB["MRBè¯„å®¡"] --> DISP

    DONEU --> I{"æ‰¹æ¬¡å®Œæˆ?"}
    I -->|å¦| TI
    I -->|æ˜¯| OQC{è§¦å‘OQC?}

    OQC -- å¦ --> J["SMTå®Œå·¥<br/>RUN=COMPLETED"]
    OQC -- æ˜¯ --> OQCT["OQCæŠ½æ£€ [M2]<br/>(MES æ ¸å¿ƒ)"]
    OQCT --> OQCR{OQCç»“æœ?}
    OQCR -- åˆæ ¼ --> J
    OQCR -- ä¸åˆæ ¼ --> OQCH["æ‰¹æ¬¡éš”ç¦»<br/>RUN=ON_HOLD [M2]"]
    OQCH --> OQCMRB["MRBè¯„å®¡"]
    OQCMRB -- æ”¾è¡Œ --> J
    OQCMRB -- "è¿”ä¿®" --> RUN_RW["åˆ›å»ºè¿”ä¿®æ‰¹æ¬¡<br/>åŸRUN=COMPLETED"]
    RUN_RW --> RW_GATE{è¿”ä¿®ç±»å‹?}
    RW_GATE -- "å¤ç”¨å°±ç»ª" --> RW_AUTH["è¿”ä¿®Run=AUTHORIZED<br/>(MRBæˆæƒ)"]
    RW_GATE -- "é‡æ–°æ£€æŸ¥" --> RW_PREP["è¿”ä¿®Run=PREP"]
    RW_PREP --> A
    RW_AUTH --> G
    OQCMRB -- æŠ¥åºŸ --> OQCSC["æ•´æ‰¹æŠ¥åºŸ<br/>RUN=SCRAPPED [M2]"]

    J --> WO_CHK{"WO æ‰€æœ‰ Run å®Œæˆ?"}
    WO_CHK -- å¦ --> END_RUN(["Run ç»“æŸ"])
    WO_CHK -- æ˜¯ --> WO_COMP["å·¥å•å®Œå·¥<br/>WO=COMPLETED"]
    WO_COMP --> K(["è½¬å…¥ä¸‹å·¥åº<br/>WOæµè½¬"])
```

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. RUN çŠ¶æ€ä¸ OQC çš„å…³ç³»

**é—®é¢˜**ï¼šåŸç‰ˆ RUN=COMPLETED åœ¨ OQC ä¹‹å‰ï¼ŒOQC ä¸åˆæ ¼è¿”å›æ‰¹é‡ç”Ÿäº§ä¼šå¯¼è‡´å·²å®Œæˆçš„ Run é‡æ–°æ‰§è¡Œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- OQC åœ¨ RUN=COMPLETED ä¹‹å‰æ‰§è¡Œ
- OQC ä¸åˆæ ¼ â†’ RUN=ON_HOLDï¼ˆéš”ç¦»ï¼‰ï¼Œè€Œéç›´æ¥è¿”å›æ‰§è¡Œ
- MRB è¯„å®¡åå¦‚éœ€è¿”ä¿®ï¼Œåˆ›å»º **æ–°çš„è¿”ä¿® Run**ï¼ŒåŸ Run æ ‡è®°ä¸º COMPLETED
- è¿™ä¿è¯äº† Run çŠ¶æ€çš„ä¸å¯é€†æ€§

```
æ‰¹æ¬¡å®Œæˆ? â†’ OQCè§¦å‘? â†’ OQCç»“æœ?
                â†“ åˆæ ¼      â†“ ä¸åˆæ ¼
            RUN=COMPLETED   RUN=ON_HOLD â†’ MRBè¯„å®¡
                                            â†“ è¿”ä¿®
                                        åˆ›å»ºæ–°Runï¼ŒåŸRun=COMPLETED
```

### 2. è¿”ä¿® Run çš„ Gating è§„åˆ™

**é—®é¢˜**ï¼šv2.2 ä¸­è¿”ä¿® Run ç›´æ¥è·³åˆ°æ‰¹é‡æ‰§è¡Œ Gï¼Œç»•è¿‡äº† PREP/FAI/AUTHORIZED çš„ Run ç”Ÿå‘½å‘¨æœŸã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šMRB è¯„å®¡æ—¶é€‰æ‹©è¿”ä¿®ç±»å‹ï¼š

| è¿”ä¿®ç±»å‹ | Run çŠ¶æ€ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| **å¤ç”¨å°±ç»ª** | ç›´æ¥ AUTHORIZED | ç‰©æ–™/è®¾å¤‡æ— å˜æ›´ï¼Œä»…å·¥è‰ºå‚æ•°è°ƒæ•´ |
| **é‡æ–°æ£€æŸ¥** | ä» PREP å¼€å§‹ | éœ€è¦é‡æ–°éªŒè¯ç‰©æ–™/è®¾å¤‡/é¦–ä»¶ |

**æ•°æ®æ¨¡å‹**ï¼š
```typescript
interface ReworkRun {
  runNo: string
  parentRunId: string          // æŒ‡å‘åŸ Run
  reworkType: 'REUSE_PREP' | 'FULL_PREP'
  mrbDecisionId: string        // MRB å†³ç­–è®°å½•
  mrbAuthorizedBy: string      // MRB æˆæƒäºº
  mrbAuthorizedAt: string      // MRB æˆæƒæ—¶é—´
}
```

**è§„åˆ™**ï¼š
- æ‰€æœ‰è¿”ä¿® Run å¿…é¡»æœ‰ `parentRunId` æŒ‡å‘åŸ Run
- å¤ç”¨å°±ç»ªæ—¶ï¼ŒRun.status ç›´æ¥è®¾ä¸º AUTHORIZEDï¼Œä½†è®°å½• MRB æˆæƒä¿¡æ¯
- é‡æ–°æ£€æŸ¥æ—¶ï¼ŒRun.status è®¾ä¸º PREPï¼Œéœ€è¦é‡æ–°èµ°å®Œæ•´æµç¨‹

### 3. WO=IN_PROGRESS è§¦å‘ç‚¹

**è®¾è®¡å†³ç­–**ï¼šWO=IN_PROGRESS åœ¨ **é¦–ä¸ª Run è¿›å…¥ IN_PROGRESS** æ—¶è§¦å‘ã€‚

**ç†ç”±**ï¼š
- AUTHORIZED åªè¡¨ç¤º"å¯ä»¥å¼€å·¥"ï¼Œä¸ä»£è¡¨"å·²å¼€å·¥"
- é¦–ä¸ª TrackIn å‘ç”Ÿæ—¶ Run è¿›å…¥ IN_PROGRESSï¼Œæ­¤æ—¶ WO ä¹Ÿåº”è¯¥ IN_PROGRESS
- è¿™ä¸ç«¯åˆ°ç«¯æµç¨‹ä¸­"å®é™…æ‰§è¡Œå¼€å§‹"è¯­ä¹‰ä¸€è‡´

**å®ç°**ï¼š
```
Run çŠ¶æ€å˜åŒ–: AUTHORIZED â†’ IN_PROGRESS (é¦–ä¸ª TrackIn)
  â†“ è§¦å‘æ£€æŸ¥
å¦‚æœ WO.status == RELEASED ä¸” WO ä¸‹æœ‰ Run.status == IN_PROGRESS
  â†’ WO.status = IN_PROGRESS
```

### 4. UNIT çŠ¶æ€æ ‡æ³¨

| æµç¨‹èŠ‚ç‚¹ | çŠ¶æ€å˜åŒ– | è¯´æ˜ |
|---------|---------|------|
| TrackIn | â†’ `IN_STATION` | è¿›ç«™ |
| TrackOut(PASS, éæœ«å·¥åº) | â†’ `QUEUED` | ç­‰å¾…ä¸‹å·¥åº |
| TrackOut(PASS, æœ«å·¥åº) | â†’ `DONE` | ç›´æ¥å®Œæˆï¼Œè·³è¿‡ QUEUED |
| TrackOut(FAIL) | â†’ `OUT_FAILED` | ç­‰å¾…å¤„ç½® |
| éš”ç¦»å¤„ç½® | â†’ `ON_HOLD` [M2] | MRB å¾…è¯„å®¡ |
| æŠ¥åºŸå¤„ç½® | â†’ `SCRAPPED` [M2] | ç»ˆæ€ |

### 5. M1/M2/M3 åŠŸèƒ½è¾¹ç•Œ

| åŠŸèƒ½ | M1 | M2 | M3 |
|------|----|----|-----|
| åŸºç¡€ TrackIn/Out | âœ… | | |
| UNIT: QUEUED/IN_STATION/DONE/OUT_FAILED | âœ… | | |
| RUN: PREP/AUTHORIZED/IN_PROGRESS/COMPLETED | âœ… | | |
| ä¸è‰¯ç™»è®° (Defect) | âœ… | | |
| å¤„ç½®åˆ¤å®šåŸºç¡€æ¡†æ¶ | âœ… | | |
| FAI åŸºç¡€æ£€éªŒ | âœ… | | |
| å°±ç»ªæ£€æŸ¥ (PrepCheck) | âœ… | | |
| é’¢ç½‘/é”¡è†é›†æˆæ¥å£ | | â¬œ | |
| ä¸Šæ–™é˜²é”™ | | â¬œ | |
| UNIT: ON_HOLD/SCRAPPED | | â¬œ | |
| RUN: ON_HOLD/SCRAPPED | | â¬œ | |
| OQC æŠ½æ£€ | | â¬œ | |
| å®Œæ•´è¿”ä¿®æµç¨‹ | | â¬œ | |
| SPI/AOI è‡ªåŠ¨æ•°é‡‡ | | | â¬œ |
| è¿‡ç¨‹æ•°æ®é‡‡é›† | | | â¬œ |
| æ•°æ®éªŒè¯ä¸å‘Šè­¦ | | | â¬œ |

---

## é›†æˆæ¥å£è§„èŒƒ

> **æ³¨æ„**ï¼šä»¥ä¸‹æ¥å£å®šä¹‰ä¸º SMP æµç¨‹æ‰©å±•ï¼Œå®Œæ•´é›†æˆè§„èŒƒè§ï¼š
> - `domain_docs/mes/spec/integration/01_system_integrations.md`
> - `domain_docs/mes/spec/integration/02_integration_payloads.md`

### æ¥å£è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€è¾“å…¥æ ¼å¼**ï¼šä¸ç®¡è‡ªåŠ¨è¿˜æ˜¯æ‰‹åŠ¨ï¼ŒMES æ¥æ”¶çš„æ•°æ®ç»“æ„ä¸€è‡´
2. **æ¥æºæ ‡è¯†**ï¼šè®°å½•æ•°æ®æ¥æºï¼ˆAUTO/MANUALï¼‰ç”¨äºå®¡è®¡
3. **æ‰‹åŠ¨é™çº§**ï¼šå¤–éƒ¨ç³»ç»Ÿä¸å¯ç”¨æ—¶ï¼Œå…è®¸äººå·¥å½•å…¥
4. **å¹‚ç­‰æ€§**ï¼šæ‰€æœ‰æ¥å£æ”¯æŒ `Idempotency-Key` header æˆ– `eventId` å­—æ®µ

### æ¥å£å®šä¹‰

#### 1. é’¢ç½‘å°±ç»ªçŠ¶æ€ (TPM â†’ MES) [M2]

```typescript
// POST /api/integration/stencil-status
// Idempotency-Key: required
interface StencilStatusInput {
  eventId: string               // å¹‚ç­‰é”®
  eventTime: string             // äº‹ä»¶æ—¶é—´ (ISO 8601)
  stencilId: string             // é’¢ç½‘ç¼–å·
  version: string               // ç‰ˆæœ¬å·
  status: 'READY' | 'NOT_READY' | 'MAINTENANCE'
  tensionValue?: number         // å¼ åŠ›å€¼ (å¯é€‰ï¼Œç”¨äºè®°å½•)
  lastCleanedAt?: string        // æœ€åæ¸…æ´—æ—¶é—´
  source: 'AUTO' | 'MANUAL'     // æ•°æ®æ¥æº
  operatorId?: string           // æ‰‹åŠ¨å½•å…¥æ—¶çš„æ“ä½œå‘˜
}

// MES åªå…³å¿ƒ: status === 'READY' æ‰å…è®¸å¼€å·¥
```

#### 2. é”¡è†åˆè§„çŠ¶æ€ (WMS â†’ MES) [M2]

```typescript
// POST /api/integration/solder-paste-status
// Idempotency-Key: required
interface SolderPasteStatusInput {
  eventId: string               // å¹‚ç­‰é”®
  eventTime: string             // äº‹ä»¶æ—¶é—´ (ISO 8601)
  lotId: string                 // é”¡è†æ‰¹æ¬¡å·
  status: 'COMPLIANT' | 'NON_COMPLIANT' | 'EXPIRED'
  expiresAt?: string            // æœ‰æ•ˆæœŸ
  thawedAt?: string             // å›æ¸©å¼€å§‹æ—¶é—´ (å¯é€‰è®°å½•)
  stirredAt?: string            // æ…æ‹Œæ—¶é—´ (å¯é€‰è®°å½•)
  source: 'AUTO' | 'MANUAL'
  operatorId?: string
}

// MES åªå…³å¿ƒ: status === 'COMPLIANT' æ‰å…è®¸ä½¿ç”¨
```

#### 3. SPI/AOI æ£€æµ‹ç»“æœ (SCADA â†’ MES) [M3]

```typescript
// POST /api/integration/inspection-result
// Idempotency-Key: required
interface InspectionResultInput {
  // å¹‚ç­‰ä¸å®šä½ (å¿…éœ€)
  eventId: string               // å¹‚ç­‰é”® (è®¾å¤‡äº‹ä»¶ID)
  eventTime: string             // äº‹ä»¶æ—¶é—´ (ISO 8601)
  runNo: string                 // æ‰¹æ¬¡å· (å¿…éœ€)
  stationCode: string           // ç«™ä½ä»£ç  (å¿…éœ€)
  unitSn: string                // å•ä»¶åºåˆ—å· (å¿…éœ€)

  // å®šä½è¾…åŠ© (å¯é€‰)
  stepNo?: number               // å·¥åºå· (å¯ä» stationCode æ¨å¯¼)
  trackId?: string              // è¿½æº¯ID (å®æ—¶æ¨é€æ—¶å¯èƒ½è¿˜æ²¡æœ‰)

  // æ£€æµ‹ç»“æœ
  inspectionType: 'SPI' | 'AOI' | 'XRAY' | 'OTHER'
  result: 'PASS' | 'FAIL'
  defects?: Array<{
    code: string                // ä¸è‰¯ä»£ç 
    location: string            // ä½ç½® (å¦‚ R1, C5)
    description?: string
  }>

  // åŸå§‹æ•°æ® (å¯é€‰)
  rawData?: Record<string, unknown>

  // æ¥æº
  source: 'AUTO' | 'MANUAL'
  equipmentId?: string          // è®¾å¤‡ID
  operatorId?: string           // æ“ä½œå‘˜ (æ‰‹åŠ¨æ—¶)
}

// MES å¤„ç†é€»è¾‘:
// 1. éªŒè¯ runNo + stationCode + unitSn å­˜åœ¨
// 2. å¦‚æœ trackId æœªæä¾›ï¼ŒæŸ¥æ‰¾å½“å‰ IN_STATION çš„ Track
// 3. PASS â†’ è®°å½•æ£€æµ‹æ•°æ®
// 4. FAIL â†’ è‡ªåŠ¨åˆ›å»º Defect è®°å½• (å…³è” trackId)
```

#### 4. è®¾å¤‡ OEE æ•°æ® (SCADA â†’ BIï¼ŒMES ä¸å¤„ç†)

```typescript
// è¿™ä¸ªæ¥å£ MES ä¸å®ç°ï¼Œç”± BI ç³»ç»Ÿæ¶ˆè´¹
// ä»…ä½œä¸ºè§„èŒƒå®šä¹‰ï¼Œä¾›æœªæ¥ç³»ç»Ÿå‚è€ƒ
interface OeeDataInput {
  equipmentId: string
  timestamp: string
  availability: number          // 0-1
  performance: number           // 0-1
  quality: number               // 0-1
  throwRate?: number            // æŠ›æ–™ç‡
}
```

---

## æ‰‹åŠ¨é™çº§æ¨¡å¼

å½“å¤–éƒ¨ç³»ç»Ÿæœªå°±ç»ªæ—¶ï¼ŒMES æä¾›æ‰‹åŠ¨å½•å…¥ç•Œé¢ï¼š

### å°±ç»ªæ£€æŸ¥ - æ‰‹åŠ¨ç¡®è®¤

| æ£€æŸ¥é¡¹ | æ‰‹åŠ¨å½•å…¥å­—æ®µ | å¡æ§é€»è¾‘ | é‡Œç¨‹ç¢‘ |
|--------|-------------|----------|--------|
| é’¢ç½‘å°±ç»ª | é’¢ç½‘ç¼–å· + ç¡®è®¤çŠ¶æ€ | çŠ¶æ€ = READY æ‰æ”¾è¡Œ | M2 |
| é”¡è†åˆè§„ | æ‰¹æ¬¡å· + ç¡®è®¤çŠ¶æ€ | çŠ¶æ€ = COMPLIANT æ‰æ”¾è¡Œ | M2 |
| è®¾å¤‡å°±ç»ª | è®¾å¤‡ID + ç¡®è®¤çŠ¶æ€ | çŠ¶æ€ = READY æ‰æ”¾è¡Œ | M1 âœ… |

### è¿‡ç¨‹æ•°æ® - æ‰‹åŠ¨å½•å…¥

| æ•°æ®ç‚¹ | æ‰‹åŠ¨å½•å…¥æ–¹å¼ | è¯´æ˜ | é‡Œç¨‹ç¢‘ |
|--------|-------------|------|--------|
| SPI ç»“æœ | é€‰æ‹© PASS/FAIL + ä¸è‰¯ä»£ç  | ç®€åŒ–ç‰ˆï¼Œä¸å« SPC æ•°æ® | M3 |
| AOI ç»“æœ | é€‰æ‹© PASS/FAIL + ä¸è‰¯ä»£ç  | ç®€åŒ–ç‰ˆï¼Œä¸å«å›¾ç‰‡ | M3 |
| æ¸©åº¦æ›²çº¿ | ç¡®è®¤"æ›²çº¿æ­£å¸¸"å¤é€‰æ¡† | ä»…åšç¡®è®¤ï¼Œä¸é‡‡é›†æ•°å€¼ | M3 |

### å®¡è®¡è¿½æº¯

æ‰€æœ‰æ‰‹åŠ¨å½•å…¥è®°å½•éƒ½ä¼šæ ‡è®° `source: 'MANUAL'`ï¼Œä¾¿äºï¼š
- åŒºåˆ†è‡ªåŠ¨é‡‡é›† vs äººå·¥å½•å…¥
- ç»Ÿè®¡æ‰‹åŠ¨å½•å…¥å æ¯”ï¼ˆè¡¡é‡è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼‰
- è¿½æº¯è´£ä»»äºº

---

## MES æ ¸å¿ƒæ¨¡å— vs é›†æˆæ¨¡å—

| æ¨¡å— | å½’å± | MES å®ç°å†…å®¹ | é‡Œç¨‹ç¢‘ |
|------|------|-------------|--------|
| **å·¥å•ç®¡ç†** | MES æ ¸å¿ƒ | çŠ¶æ€æœºã€ERP åŒæ­¥ | M1 âœ… |
| **æ‰¹æ¬¡ç®¡ç†** | MES æ ¸å¿ƒ | Run çŠ¶æ€ã€æˆæƒ | M1 âœ… |
| **å°±ç»ªæ£€æŸ¥** | MES æ ¸å¿ƒ | æ£€æŸ¥é¡¹é…ç½®ã€å¡æ§é€»è¾‘ã€é›†æˆæ¥å£ | M1 âœ… |
| **ä¸Šæ–™é˜²é”™** | MES æ ¸å¿ƒ | ç«™ä½è¡¨ã€BOM æ¯”å¯¹ã€ç»‘å®šè®°å½• | M2 â¬œ |
| **TrackIn/Out** | MES æ ¸å¿ƒ | è¿›å‡ºç«™ã€çŠ¶æ€æµè½¬ | M1 âœ… |
| **ä¸è‰¯/å¤„ç½®** | MES æ ¸å¿ƒ | ç¼ºé™·è®°å½•ã€REWORK/SCRAP/HOLD | M1/M2 |
| **OQC æŠ½æ£€** | MES æ ¸å¿ƒ | æŠ½æ ·è§„åˆ™ã€æ£€éªŒè®°å½• | M2 â¬œ |
| **é’¢ç½‘çŠ¶æ€** | ğŸ”Œ é›†æˆ | æ¥æ”¶çŠ¶æ€ï¼Œä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ | M2 â¬œ |
| **é”¡è†çŠ¶æ€** | ğŸ”Œ é›†æˆ | æ¥æ”¶çŠ¶æ€ï¼Œä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ | M2 â¬œ |
| **SPI/AOI ç»“æœ** | ğŸ”Œ é›†æˆ | æ¥æ”¶ç»“æœï¼Œä¸ç›´è¿è®¾å¤‡ | M3 â¬œ |
| **è¿‡ç¨‹æ•°æ®é‡‡é›†** | ğŸ”Œ é›†æˆ | æ¥æ”¶æ•°æ®ï¼ŒéªŒè¯é™å€¼ | M3 â¬œ |
| **OEE/æŠ›æ–™ç‡** | âŒ ä¸å®ç° | ç”± BI ç³»ç»Ÿè´Ÿè´£ | - |

---

## çŠ¶æ€æœºå¯¹ç…§

### å·¥å•çŠ¶æ€ (WorkOrderStatus) - M1 âœ…

| æµç¨‹èŠ‚ç‚¹ | çŠ¶æ€å€¼ | è§¦å‘æ¡ä»¶ | API |
|---------|--------|---------|-----|
| å·¥å•æ¥æ”¶ | `RECEIVED` | ERP åŒæ­¥ | `POST /api/integration/work-orders` |
| å·¥å•é‡Šæ”¾ | `RELEASED` | æ‰‹åŠ¨é‡Šæ”¾ | `POST /api/work-orders/{woNo}/release` |
| å¼€å·¥ | `IN_PROGRESS` | é¦–ä¸ª Run è¿›å…¥ IN_PROGRESS | (è‡ªåŠ¨è§¦å‘) |
| å®Œå·¥ | `COMPLETED` | æ‰€æœ‰ Run å®Œæˆ | (è‡ªåŠ¨è§¦å‘) |

### æ‰¹æ¬¡çŠ¶æ€ (RunStatus)

| æµç¨‹èŠ‚ç‚¹ | çŠ¶æ€å€¼ | è§¦å‘æ¡ä»¶ | é‡Œç¨‹ç¢‘ |
|---------|--------|---------|--------|
| åˆ›å»ºæ‰¹æ¬¡ | `PREP` | åˆ›å»º Run | M1 âœ… |
| æ‰¹é‡æˆæƒ | `AUTHORIZED` | FAI é€šè¿‡ + æˆæƒ | M1 âœ… |
| æ‰¹é‡ç”Ÿäº§ | `IN_PROGRESS` | é¦–ä¸ª TrackIn | M1 âœ… |
| OQC éš”ç¦» | `ON_HOLD` | OQC ä¸åˆæ ¼ | M2 â¬œ |
| å®Œå·¥ | `COMPLETED` | æ‰¹æ¬¡å®Œæˆ + OQC é€šè¿‡ | M1 âœ… |
| æŠ¥åºŸ | `SCRAPPED` | MRB å†³ç­–æŠ¥åºŸ | M2 â¬œ |

### å•ä»¶çŠ¶æ€ (UnitStatus)

| æµç¨‹èŠ‚ç‚¹ | çŠ¶æ€å€¼ | é‡Œç¨‹ç¢‘ |
|---------|--------|--------|
| TrackIn | `IN_STATION` | M1 âœ… |
| TrackOut(PASS, éæœ«å·¥åº) | `QUEUED` | M1 âœ… |
| TrackOut(PASS, æœ«å·¥åº) | `DONE` | M1 âœ… |
| TrackOut(FAIL) | `OUT_FAILED` | M1 âœ… |
| éš”ç¦» | `ON_HOLD` | M2 â¬œ |
| æŠ¥åºŸ | `SCRAPPED` | M2 â¬œ |

---

## API æ¸…å•

### MES æ ¸å¿ƒ API

| API | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|-----|------|------|------|
| `/api/integration/work-orders` | POST | æ¥æ”¶å·¥å• (ERP) | âœ… M1 |
| `/api/work-orders/{woNo}/release` | POST | é‡Šæ”¾å·¥å• | âœ… M1 |
| `/api/work-orders/{woNo}/runs` | POST | åˆ›å»ºæ‰¹æ¬¡ | âœ… M1 |
| `/api/runs/{runNo}/prep-checks` | POST | å°±ç»ªæ£€æŸ¥ | âœ… M1 |
| `/api/fai/run/{runNo}` | POST | åˆ›å»ºFAIä»»åŠ¡ | âœ… M1 |
| `/api/fai/{faiId}/complete` | POST | FAIå®Œæˆ | âœ… M1 |
| `/api/runs/{runNo}/authorizations` | POST | æ‰¹é‡æˆæƒ | âœ… M1 |
| `/api/stations/{stationCode}/track-in` | POST | è¿›ç«™ | âœ… M1 |
| `/api/stations/{stationCode}/track-out` | POST | å‡ºç«™ | âœ… M1 |
| `/api/defects` | POST | ä¸è‰¯ç™»è®° | âœ… M1 |
| `/api/defects/{defectId}/disposition` | POST | å¤„ç½®åˆ¤å®š | âœ… M1 |
| `/api/rework/{reworkId}/complete` | POST | è¿”ä¿®å®Œæˆ | â¬œ M2 |
| `/api/oqc/...` | - | OQC æŠ½æ£€ | â¬œ M2 |

### é›†æˆæ¥å£ API

| API | æ–¹æ³• | ç”¨é€” | çŠ¶æ€ |
|-----|------|------|------|
| `/api/integration/stencil-status` | POST | æ¥æ”¶é’¢ç½‘çŠ¶æ€ | â¬œ M2 |
| `/api/integration/solder-paste-status` | POST | æ¥æ”¶é”¡è†çŠ¶æ€ | â¬œ M2 |
| `/api/integration/inspection-result` | POST | æ¥æ”¶ SPI/AOI ç»“æœ | â¬œ M3 |

---

## å‚è€ƒæ–‡æ¡£

- åŸç‰ˆè‰ç¨¿: `03_smp_flows_userfeeback_draft.md`
- MES ç«¯åˆ°ç«¯æµç¨‹: `01_end_to_end_flows.md`
- çŠ¶æ€æœºå®šä¹‰: `02_state_machines.md`
- ç³»ç»Ÿé›†æˆè§„èŒƒ: `domain_docs/mes/spec/integration/01_system_integrations.md`
- é›†æˆè½½è·åˆåŒ: `domain_docs/mes/spec/integration/02_integration_payloads.md`
- æ•°æ®é‡‡é›†è§„æ ¼: `domain_docs/mes/spec/data_collection/01_data_collection_specs.md`
- API åˆåŒ (æ‰§è¡Œ): `domain_docs/mes/tech/api/02_api_contracts_execution.md`
- API åˆåŒ (è´¨é‡): `domain_docs/mes/tech/api/03_api_contracts_quality.md`
