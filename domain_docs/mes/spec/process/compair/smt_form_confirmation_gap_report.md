# SMT 表单采集确认表与系统实现差距报告

> 依据：`SMT 表单采集确认表.md`（已确认版）
> 目的：对照当前系统实现，明确已覆盖、部分覆盖与未覆盖的范围，给出可执行的差距清单。

---

## 1. 全局规则差距

| 确认项 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| 表单落地方式 | 表单不独立落地，融入 MES 工序步骤 | 有数据采集规范（DataCollectionSpec），但未配置到 SMT 具体表单 | 需要配置表单到工序与采集规范，当前仅有框架 |
| 准备完成口径 | 所有准备项达标（PASS/WAIVED）；门禁=No 允许继续但提醒/豁免并记录；记录必须存在，有可靠自动数据源可自动确认，否则人工确认 | Readiness 仅覆盖部分项；无软门禁提醒/豁免机制 | 需补齐准备项清单、软门禁与“记录必达”规则 |
| 时间规则（回流焊→水洗 4h） | 仅提醒（Alert），需可触发豁免；仅适用于配置水洗工序的路由/产品 | 已实现时间规则定义 + 事件驱动 + cron 提醒/豁免（REFLOW/AOI TrackOut → WASH TrackIn） | 需按路由/产品配置并确认现场水洗扫码点 |
| 时间规则（锡膏暴露 <24h） | 仅提醒（Alert），可豁免 | 已实现 24h 暴露规则 + 事件驱动 + 提醒/豁免 | 需确认阈值与适用范围的配置策略 |
| 豁免权限 | 复用现有角色并显式授权 | 预设角色无明确时间规则豁免权限映射 | 权限映射缺口，需明确授予现有角色或定义双人豁免 |
| 签字与放行 | 以账号替代签字；首件检查必须签字 | FAI 有 decidedBy/At，但无显式签字强制；其他表单无签字流程 | 签字逻辑未固化，首件签字规则缺口 |
| 补录规则 | 部分表单不允许补录 | 接口层未限制补录/回填窗口 | 需要补录策略与审计规则 |

---

## 2. 表单级差距矩阵（按环节）

### 2.1 准备环节
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Pro-057 产品烘烤时间记录表 | 终端录入/自动带出；非门禁 | 有 BakeRecord 记录接口，但未接入就绪检查 | 记录能力有，流程门禁未连接 |
| QR-Pro-013 锡膏使用记录表 | 终端扫码，系统判断 | 有 SolderPasteUsageRecord；无时间规则与门禁 | 记录能力有，规则与门禁缺失 |
| QR-Pro-073 温度测量记录表 | 设备数采，系统判断 | 有 ColdStorageTemperatureRecord；未进入门禁 | 数据有入口，未用于规则判断 |
| QR-Pro-089 钢网使用次数和点检 | 计数/张力/损坏记录；系统判断 | 仅有 StencilStatus/LineStencil 绑定 | 计数与点检字段缺口 |
| QR-Pro-130 钢网清洗记录表 | 自动带出记录；系统判断 | 无专用记录 | 完全缺口 |
| QR-Mac-144 刮刀使用次数点检 | 设备数采+人工输入 | 无专用记录 | 完全缺口 |
| QR-Mac-155 夹具维护记录表 | TPM 关联、寿命运算 | 仅有设备 TPM；无夹具实体/寿命模型 | 夹具层缺口 |
| QR-Pro-133 转拉前检查项目 | 系统运算结果 | Readiness 检查 + 静态模板视图（PREP_* + TIME_RULE） | 仍缺“需要/不需要”字段与可配置模板 |

### 2.2 上料/生产
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Pro-121 物料上机对照表 | PDA 扫描，系统自动比对 | Loading verify + SlotMapping | 已覆盖核心能力 |
| QR-Mac-022 生产换料记录表 | PDA 扫码记录，仅流程记录 | Loading replace 记录 reason/packageQty | 部分覆盖；缺少审核字段与流程约束 |

### 2.3 首件/日常
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Pro-05 首末件检查记录表 | 首件必须签字放行 | 有 FAI（Inspection） | 仅支持首件，未覆盖末件；签字强制缺口 |
| QR-Mac-238 AOI 每天开机点检 | TPM 系统集成 | 无对应接口 | 完全缺口 |

### 2.4 生产过程
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Pro-105 炉温程式使用记录表 | 程式一致性校验 | 无程式字段或校验 | 完全缺口 |
| QR-Ins-02 每日 QC 检验报表 | SN 扫码录入缺陷 | 仅有 Defect/Rework | 仅部分覆盖，不是日报结构 |
| QR-Pro-034 生产异常报告 | TPM 集成 | 无异常报告接口 | 缺口 |
| 生产数据记录表 | 贴片机自动采集 | 无设备数采接口 | 缺口 |
| 产品出/入数记录表 | 设备数采 | 仅有 Run/Unit 统计 | 仅部分覆盖 |

### 2.5 维修/质量
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Pro-012 维修记录表 | 维修界面扫码录入 | Defect + ReworkTask | 仅部分覆盖（无维修表单字段） |
| QR-Mac-134 X-ray 检查记录表 | 过程记录 | 无接口 | 缺口 |
| QR-IQC-01 不良物料评审报告 | 录入异常单 | 无 IQC 流程 | 缺口 |

### 2.6 全流程
| 表单 | 已确认要求 | 当前实现 | 差距结论 |
| --- | --- | --- | --- |
| QR-Tra-xxxx 工艺/时间/检测流程表 | 替换为流程扫描 | Track 记录可追溯时间 | 部分覆盖（无表单/签字） |

---

## 3. 差距分级总结

### 3.1 高优先级（影响合规与追溯）
- 锡膏时间规则与暴露时长提醒/豁免
- 钢网/刮刀寿命与点检记录
- 炉温程式与温区曲线记录
- 首件签字放行机制

### 3.2 中优先级（影响过程完整性）
- AOI 每日点检与 TPM 同步
- 生产异常报告闭环
- 维修记录表单化

### 3.3 低优先级（增强项）
- 夹具维护记录
- X-ray 记录表
- 统计类报表（日报）

---

## 4. 证据与参考实现

- 确认表：`domain_docs/mes/spec/process/compair/SMT 表单采集确认表.md`
- 就绪门禁：`apps/server/src/modules/mes/readiness/service.ts`
- 上料防错：`apps/server/src/modules/mes/loading/service.ts`
- FAI：`apps/server/src/modules/mes/fai/routes.ts`
- OQC：`apps/server/src/modules/mes/oqc/routes.ts`
- 烘烤记录：`apps/server/src/modules/mes/bake/routes.ts`
- 锡膏/冷藏温度：`apps/server/src/modules/mes/solder-paste/routes.ts`
- 缺陷/返修：`apps/server/src/modules/mes/defect/routes.ts`
- 数据采集规范：`apps/server/src/modules/mes/data-collection-spec/routes.ts`

---

## 5. 结论

- 当前系统已经覆盖了“上料防错 + FAI + OQC + Track 追溯”的核心主链路。
- 采集确认表中大量“准备类/设备类/质量类”表单仍处于缺失或仅有记录接口而未进入门禁判断的状态。
- 若需要与确认表保持一致，必须补齐：准备项达标判定与软门禁规则、时间规则提醒/豁免、签字放行、寿命/点检记录、设备数采接入与异常闭环。
