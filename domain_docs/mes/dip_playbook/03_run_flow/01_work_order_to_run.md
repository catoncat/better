# 工单到批次

## 1. 概述
DIP 产线的工单到批次流程与 SMT 基本一致，共享相同的数据模型和 API。本文档描述 DIP 场景下的特点和差异。

## 2. 工单（WorkOrder）

### 2.1 工单来源
工单通常来自 ERP 系统同步：
- 计划部门在 ERP 下达工单
- 系统通过接口同步工单信息
- 工单包含产品、数量、交期等基本信息

### 2.2 工单主数据
| 字段 | 说明 | 示例 |
|------|------|------|
| workOrderNo | 工单号 | WO-2024-001 |
| productId | 产品 ID | PROD-A |
| quantity | 计划数量 | 1000 |
| dueDate | 交期 | 2024-01-31 |
| priority | 优先级 | HIGH / NORMAL / LOW |
| status | 状态 | RELEASED / IN_PROGRESS / COMPLETED |

### 2.3 DIP 工单特点
| 特点 | 说明 |
|------|------|
| 来料依赖 | DIP 通常在 SMT 之后，需要 SMT 产出作为来料 |
| 流程长 | 单件完成时间较长，批次周期跨度大 |
| 换型频繁 | 可能需要频繁更换夹具 |

## 3. 批次（Run）

### 3.1 批次创建
从工单创建批次：
```
WorkOrder（工单）
    ↓
Run（批次）
    ↓
Unit（单件）- 批量生成或按需生成
```

### 3.2 批次主数据
| 字段 | 说明 | 示例 |
|------|------|------|
| runNo | 批次号 | RUN-2024-001-A |
| workOrderId | 工单 ID | WO-2024-001 |
| lineId | 产线 ID | DIP-A |
| routeVersionId | 路由版本 | ROUTE-DIP-PRDA-V1 |
| plannedQty | 计划数量 | 200 |
| status | 状态 | PREP / AUTHORIZED / IN_PROGRESS / COMPLETED |

### 3.3 批次状态流转
```
PREP（准备）
    ↓ [就绪检查通过 + FAI 完成]
AUTHORIZED（已授权）
    ↓ [开始执行]
IN_PROGRESS（执行中）
    ↓ [所有单件完成]
    ├─→ COMPLETED（完成）- OQC 合格
    └─→ ON_HOLD（挂起）- OQC 不合格
            ↓ [MRB 决策]
            ├─→ COMPLETED（放行）
            ├─→ SCRAPPED（报废）
            └─→ 创建返修 Run
```

## 4. 单件（Unit）

### 4.1 单件生成时机
| 方式 | 说明 | 适用场景 |
|------|------|----------|
| 批量预生成 | 创建 Run 时批量生成 | 固定批量生产 |
| 按需生成 | TrackIn 时生成 | 柔性生产 |
| 关联 SMT | 继承 SMT 单件 | SMT+DIP 组合 |

### 4.2 单件主数据
| 字段 | 说明 | 示例 |
|------|------|------|
| serialNo | 序列号 | SN-001 |
| runId | 批次 ID | RUN-2024-001-A |
| status | 状态 | QUEUED / IN_PROGRESS / DONE / DEFECTIVE |
| currentStation | 当前工位 | DIP-A-WS-01 |

### 4.3 单件条码
DIP 单件通常使用 PCB 上的序列号条码：
- 条码在 SMT 阶段已打印/贴附
- 条码格式：产品代码 + 序列号
- 全流程唯一标识

## 5. SMT+DIP 组合场景

### 5.1 流程衔接
```
SMT Run（SMT 批次）
    ↓ [SMT 完成]
    ↓ [单件带条码流转]
DIP Run（DIP 批次）
    ↓ [继承 SMT 单件或重新关联]
```

### 5.2 批次关联方式
| 方式 | 说明 | 优点 |
|------|------|------|
| 同一 Run | SMT+DIP 在同一批次 | 追溯简单 |
| 独立 Run | SMT 和 DIP 分别建批次 | 管理灵活 |
| 关联 Run | 独立 Run 但建立关联 | 追溯完整 |

### 5.3 单件继承
如果使用独立 Run：
- 扫描 SMT 产出的 PCB 条码
- 系统自动关联到 DIP Run
- 保持序列号连续性

## 6. 批次拆分与合并

### 6.1 批次拆分
当需要将一个批次拆分为多个小批次：
```
原批次（200 件）
    ↓ [拆分]
拆分批次 A（100 件）
拆分批次 B（100 件）
```

### 6.2 拆分场景
- 紧急插单，部分先做
- 设备故障，转线生产
- 物料不足，分批执行

### 6.3 批次合并
一般不建议合并批次，因为：
- 追溯复杂化
- 质量批次混淆
- 统计困难

## 7. 页面与操作

### 7.1 批次管理页面
路径：`/mes/runs`

操作：
- 查看批次列表（支持按状态/产线筛选）
- 创建新批次
- 查看批次详情
- 授权/取消授权

### 7.2 创建批次流程
1. 选择工单
2. 选择产线
3. 选择路由版本
4. 输入计划数量
5. 确认创建

## 8. 相关 API

| 操作 | API | 说明 |
|------|-----|------|
| 查询批次 | `GET /api/runs` | 支持筛选 |
| 创建批次 | `POST /api/runs` | |
| 查询详情 | `GET /api/runs/:runNo` | |
| 授权批次 | `POST /api/runs/:runNo/authorize` | |
| 取消授权 | `POST /api/runs/:runNo/revoke` | |
