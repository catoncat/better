# 测试流程

## 1. 概述
测试是 DIP 产线的关键质量控制工序，主要包括：
- **ICT（In-Circuit Test）**：在线测试，检测电气连通性和元器件参数
- **FCT（Functional Test）**：功能测试，验证产品功能

## 2. ICT 测试

### 2.1 ICT 测试原理
ICT 通过测试探针接触 PCB 上的测试点，检测：
- 电路开路/短路
- 元器件参数（电阻、电容、二极管等）
- IC 引脚连通性

### 2.2 ICT 测试项
| 测试项 | 说明 | 判定 |
|--------|------|------|
| 开路测试 | 检测电路断路 | 连通性正常 |
| 短路测试 | 检测意外连接 | 无桥连 |
| 电阻测量 | 测量电阻值 | 在规格范围内 |
| 电容测量 | 测量电容值 | 在规格范围内 |
| 二极管测试 | 测量二极管 | 极性/参数正确 |
| 晶体管测试 | 测量晶体管 | hFE 在范围内 |
| IC 测试 | 测试集成电路 | 引脚功能正常 |

### 2.3 ICT 测试流程
```
PCB 进站（TrackIn）
    ↓
放置到 ICT 测试夹具
    ↓
设备自动执行测试程序
    ↓
获取测试结果
    ↓
PCB 出站（TrackOut）
    ├─ PASS → 流转下一工位
    └─ FAIL → 登记不良 → 返修/复测
```

### 2.4 ICT 测试配置
```yaml
ICT 测试程序:
  programCode: ICT-PRDA-V1
  productId: PROD-A
  stationId: DIP-A-ICT-01
  testPoints: 256
  cycleTime: 15s
  testItems:
    - type: OPEN
      count: 128
    - type: SHORT
      count: 64
    - type: RESISTANCE
      count: 32
    - type: CAPACITANCE
      count: 20
    - type: DIODE
      count: 12
```

### 2.5 ICT 测试记录
| 字段 | 说明 |
|------|------|
| unitId | 单件 ID |
| programId | 测试程序 ID |
| result | 总体结果（PASS/FAIL） |
| testTime | 测试时间 |
| failedItems | 失败项明细 |
| rawData | 原始测试数据 |
| equipmentId | 测试设备 ID |
| toolingId | 测试夹具 ID |

## 3. FCT 测试

### 3.1 FCT 测试目的
验证产品的实际功能是否正常：
- 电源功能
- 通讯功能
- IO 功能
- 显示功能
- 按键功能
- 综合工作状态

### 3.2 FCT 测试项示例
| 测试项 | 说明 | 判定 |
|--------|------|------|
| 电源上电 | 检测供电 | 电压/电流正常 |
| 通讯测试 | UART/I2C/SPI 等 | 通讯正常 |
| GPIO 测试 | 输入输出端口 | IO 响应正确 |
| LED 测试 | 指示灯 | 亮灭正常 |
| 按键测试 | 按键功能 | 响应正确 |
| 显示测试 | 显示屏 | 显示正常 |
| 传感器测试 | 各类传感器 | 数据正常 |
| 综合功能 | 模拟实际工作 | 功能正常 |

### 3.3 FCT 测试流程
```
PCB 进站（TrackIn）
    ↓
连接 FCT 测试夹具
    ↓
设备执行功能测试
    ↓
人工交互（如需要）
    ↓
获取测试结果
    ↓
PCB 出站（TrackOut）
    ├─ PASS → 流转 OQC
    └─ FAIL → 登记不良 → 返修/报废
```

### 3.4 FCT 测试配置
```yaml
FCT 测试程序:
  programCode: FCT-PRDA-V1
  productId: PROD-A
  stationId: DIP-A-FCT-01
  cycleTime: 30s
  testItems:
    - name: 电源上电
      type: AUTO
      timeout: 5s
    - name: 通讯测试
      type: AUTO
      timeout: 3s
    - name: LED 测试
      type: SEMI_AUTO
      instruction: "确认 LED 闪烁"
    - name: 按键测试
      type: MANUAL
      instruction: "按下按键确认响应"
```

## 4. 测试夹具管理

### 4.1 测试夹具类型
| 类型 | 说明 |
|------|------|
| ICT 夹具 | 针床式探针夹具 |
| FCT 夹具 | 功能测试连接夹具 |
| 组合夹具 | ICT+FCT 一体夹具 |

### 4.2 夹具寿命管理
```
使用次数跟踪
    ↓
达到预警阈值（80%）→ 预警提醒
    ↓
达到寿命上限 → 禁止使用
    ↓
维护/更换 → 重置寿命
```

### 4.3 夹具校准
| 校准项 | 频率 | 说明 |
|--------|------|------|
| 探针接触 | 每周 | 检查探针接触压力 |
| 精度校准 | 每月 | 使用标准板校准 |
| 全面检查 | 每季度 | 全面检查并更换磨损件 |

## 5. 测试段首件（IPQC）

### 5.1 触发时机
- 批次开始后首块 PCB 进入测试段
- 更换测试程序后
- 更换测试夹具后
- 测试设备维护后

### 5.2 检查内容
| 检查项 | 说明 |
|--------|------|
| 程序版本 | 确认测试程序版本正确 |
| 夹具状态 | 检查夹具外观和寿命 |
| 设备状态 | 检查测试设备正常 |
| 首件结果 | 完整测试一遍确认 |
| 数据核对 | 检查测试数据记录正确 |

## 6. 测试不良处理

### 6.1 ICT 不良类型
| 不良代码 | 说明 | 可能原因 |
|----------|------|----------|
| ICT_OPEN | 开路 | 虚焊/断线 |
| ICT_SHORT | 短路 | 桥连/残留 |
| ICT_VALUE | 参数偏差 | 元件错误/变质 |
| ICT_MISS | 缺件 | 未安装/脱落 |

### 6.2 FCT 不良类型
| 不良代码 | 说明 | 可能原因 |
|----------|------|----------|
| FCT_POWER | 电源异常 | 电源电路问题 |
| FCT_COMM | 通讯失败 | 通讯电路/IC 问题 |
| FCT_IO | IO 异常 | 驱动电路问题 |
| FCT_FUNC | 功能异常 | 多种可能 |

### 6.3 不良处理流程
```
测试 FAIL
    ↓
分析失败项
    ↓
判定处置
    ├─ 测试误判 → 复测
    ├─ 可返修 → 创建返修任务
    │   ↓
    │   返修执行
    │   ↓
    │   复测
    │   ├─ PASS → 继续流转
    │   └─ FAIL → 再次判定
    └─ 不可返修 → 报废
```

## 7. 测试数据管理

### 7.1 数据采集
| 数据项 | 说明 |
|--------|------|
| 测试结果 | PASS/FAIL |
| 测试时间 | 开始/结束时间 |
| 失败项 | 具体失败的测试项 |
| 测量值 | 实际测量数值 |
| 判定值 | 规格上下限 |

### 7.2 数据用途
- **质量追溯**：查询单件测试历史
- **统计分析**：分析不良分布和趋势
- **工艺优化**：识别工艺问题
- **设备监控**：监控测试设备状态

### 7.3 数据存储
```
TestRecord（测试记录主表）
    ↓
TestDetail（测试明细）
    - 每个测试项的结果
    - 测量值和判定值
```

## 8. 复测管理

### 8.1 复测场景
| 场景 | 说明 |
|------|------|
| 返修后复测 | 返修完成后重新测试 |
| 误判复测 | 测试异常导致的复测 |
| 夹具问题复测 | 夹具问题排除后复测 |

### 8.2 复测规则
- 复测次数限制（如最多 3 次）
- 复测间隔要求（如返修后需等待）
- 复测需记录原因

## 9. 页面与操作

### 9.1 测试执行页面
路径：`/mes/execution`

功能：
- 选择测试工位
- 扫码进站
- 查看测试结果
- 不良登记
- 复测操作

### 9.2 测试数据查询
路径：`/mes/test-data`（待实现）

功能：
- 按单件查询测试记录
- 按批次统计测试结果
- 导出测试数据

## 10. 相关 API

| 操作 | API | 说明 |
|------|-----|------|
| 进站 | `POST /api/stations/:stationCode/track-in` | |
| 出站 | `POST /api/stations/:stationCode/track-out` | 含测试结果 |
| 记录测试结果 | `POST /api/test-records` | 详细测试数据 |
| 查询测试记录 | `GET /api/test-records` | 按单件/批次 |
| 登记不良 | `POST /api/defects` | |
