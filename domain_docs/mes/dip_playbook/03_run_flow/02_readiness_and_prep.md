# 就绪检查与准备

## 1. 概述
DIP 产线的就绪检查与 SMT 有明显差异：
- **SMT**：重点检查站位上料是否完成
- **DIP**：重点检查设备参数、工装夹具、物料发放

## 2. 就绪检查项

### 2.1 DIP 就绪检查清单
| 检查项 | 类型 | 说明 |
|--------|------|------|
| PCB 来料 | 物料 | SMT 产出 PCB 已到位 |
| 插件物料 | 物料 | 通孔元器件已发料 |
| 波峰焊设备 | 设备 | 温度/速度参数就绪 |
| 波峰焊治具 | 夹具 | 治具已分配且寿命正常 |
| 测试夹具 | 夹具 | 测试夹具已分配 |
| 测试程序 | 程序 | ICT/FCT 程序已加载 |
| 辅料 | 物料 | 助焊剂/锡条已准备 |

### 2.2 检查项分类
```yaml
必检项（阻塞执行）:
  - PCB 来料确认
  - 波峰焊设备参数
  - 波峰焊治具
  - 测试程序

选检项（警告但不阻塞）:
  - 辅料检查
  - 环境温湿度
  - 设备日检完成
```

## 3. 就绪检查流程

### 3.1 检查时机
```
Run 创建（PREP 状态）
    ↓
就绪检查
    ↓
    ├─ 全部通过 → 可授权
    └─ 存在失败项 → 需处理后重检
```

### 3.2 检查方式
| 方式 | 说明 | 示例 |
|------|------|------|
| 自动检查 | 系统自动验证 | 夹具寿命、程序版本 |
| 手动确认 | 人工确认勾选 | 物料到位、设备就绪 |
| 扫码验证 | 扫码触发验证 | 夹具条码 |

## 4. 设备参数就绪

### 4.1 波峰焊设备参数
| 参数 | 说明 | 典型值 |
|------|------|--------|
| 预热温度 | 预热区温度 | 100-120°C |
| 焊接温度 | 锡锅温度 | 250-260°C |
| 传送速度 | PCB 传送速度 | 0.8-1.2 m/min |
| 助焊剂流量 | 喷涂流量 | 按工艺设定 |

### 4.2 参数验证
- 实际参数与工艺标准对比
- 超出范围报警
- 参数记录用于追溯

## 5. 工装夹具准备

### 5.1 夹具分配流程
```
选择夹具
    ↓
验证夹具状态
    ├─ 寿命正常 → 分配成功
    ├─ 寿命预警 → 警告但可继续
    └─ 寿命超限 → 禁止使用
    ↓
扫码确认（可选）
    ↓
记录分配
```

### 5.2 夹具验证项
| 验证项 | 说明 |
|--------|------|
| 夹具存在 | 编码有效 |
| 产品匹配 | 专用夹具需匹配产品 |
| 状态正常 | 非维修/报废状态 |
| 寿命正常 | 未超过设计寿命 |
| 校准有效 | 测试夹具需校准在有效期 |

## 6. 物料准备

### 6.1 DIP 物料发放
与 SMT 不同，DIP 物料通过发料单管理：
```
BOM 需求
    ↓
发料申请
    ↓
仓库发料
    ↓
线边接收确认
    ↓
就绪检查通过
```

### 6.2 物料确认方式
| 方式 | 说明 |
|------|------|
| 系统自动 | 对接 WMS 查询发料状态 |
| 手动确认 | 线长手动勾选确认 |
| 扫码确认 | 扫描发料单条码 |

## 7. 准备流程（Prep Flow）

### 7.1 完整准备流程
```
1. PCB 来料确认
   - SMT 产出 PCB 已到达 DIP 线
   - 数量与批次匹配

2. 插件物料准备
   - 核对发料单与 BOM
   - 确认物料已到线边

3. 波峰焊设备就绪
   - 设备开机预热
   - 参数设置与验证
   - 传送带速度调整

4. 工装夹具准备
   - 波峰焊治具安装
   - 治具与产品匹配验证
   - 测试夹具就位

5. 测试程序加载
   - ICT 程序选择与加载
   - FCT 程序选择与加载
   - 程序版本确认

6. 就绪检查
   - 系统自动检查
   - 人工确认检查
   - 生成检查报告
```

### 7.2 准备状态
| 状态 | 说明 |
|------|------|
| NOT_STARTED | 未开始准备 |
| IN_PROGRESS | 准备中 |
| READY | 准备完成 |
| BLOCKED | 存在阻塞项 |

## 8. 页面与操作

### 8.1 批次详情页
路径：`/mes/runs/:runNo`

就绪检查区域显示：
- 检查项列表及状态
- 一键检查按钮
- 手动确认复选框
- 检查失败原因

### 8.2 操作流程
1. 进入批次详情页
2. 点击"就绪检查"
3. 系统执行自动检查
4. 处理失败项或手动确认
5. 全部通过后点击"授权"

## 9. 相关 API

| 操作 | API | 说明 |
|------|-----|------|
| 执行就绪检查 | `POST /api/runs/:runNo/readiness/check` | |
| 查询检查结果 | `GET /api/runs/:runNo/readiness` | |
| 手动确认检查项 | `POST /api/runs/:runNo/readiness/confirm` | |
| 分配夹具 | `POST /api/tooling/:id/assign` | 关联到 Run |
| 豁免检查项 | `POST /api/runs/:runNo/readiness/items/:itemId/waive` | 需权限 |

## 10. 豁免机制

### 10.1 概述
当某个就绪检查项失败但生产需要继续时，具有相应权限的角色可以进行豁免（Waive）操作。豁免记录将保留完整的审计追踪。

### 10.2 豁免权限
| 权限 | 说明 | 典型角色 |
|------|------|----------|
| `prep:waive` | 豁免准备项检查 | 线长、工艺工程师 |

### 10.3 豁免 API
```
POST /api/runs/:runNo/readiness/items/:itemId/waive

Request:
{
  "reason": "紧急生产需求，夹具状态已人工确认"
}

Response:
{
  "id": "item-id",
  "status": "WAIVED",
  "waivedBy": "user-id",
  "waivedAt": "2026-01-27T10:00:00Z",
  "waiveReason": "紧急生产需求，夹具状态已人工确认"
}
```

### 10.4 豁免记录字段
| 字段 | 类型 | 说明 |
|------|------|------|
| waivedBy | String | 豁免人用户 ID |
| waivedAt | DateTime | 豁免时间 |
| waiveReason | String | 豁免原因（必填） |

### 10.5 DIP 常见豁免场景
| 检查项 | 豁免场景 |
|--------|----------|
| 波峰焊设备参数 | 参数微调在允许范围内 |
| 夹具寿命预警 | 寿命接近但外观检查正常 |
| 测试夹具校准 | 校准过期但自检通过 |

### 10.6 豁免规则
- 豁免原因必须填写，不能为空
- 豁免后检查项状态变为 `WAIVED`，不再阻塞授权
- 豁免操作会记录操作日志
- 某些关键检查项（如 PCB 来料确认）可能配置为不可豁免

## 11. 与 SMT 就绪检查对比

| 维度 | SMT | DIP |
|------|-----|-----|
| 核心检查 | 上料完成验证 | 设备/夹具/程序验证 |
| 物料验证 | 实时扫码 | 发料单确认 |
| 设备参数 | 较少 | 波峰焊参数重要 |
| 夹具检查 | 无 | 夹具寿命/匹配 |
| 测试程序 | 无 | ICT/FCT 程序 |
