# 异常处理与返修

## 1. 概述
DIP 产线的异常处理比 SMT 更复杂，涉及多种工序的不良和返修。本文档描述常见异常场景和处理流程。

## 2. 不良类型汇总

### 2.1 按工序分类
| 工序 | 不良代码前缀 | 典型不良 |
|------|--------------|----------|
| 插件 | INS_ | 缺件、错件、反极性、位置偏移 |
| 波峰焊 | WS_ | 虚焊、透锡不足、短路、拉尖 |
| 手工焊 | HS_ | 虚焊、过热、拉尖 |
| 三防漆 | CC_ | 漏喷、气泡、误喷 |
| ICT | ICT_ | 开路、短路、参数偏差 |
| FCT | FCT_ | 电源异常、通讯失败、功能异常 |
| 外观 | VI_ | 划伤、污染、变形 |

### 2.2 不良严重程度
| 级别 | 说明 | 处理要求 |
|------|------|----------|
| 致命 | 影响安全或核心功能 | 必须返修或报废 |
| 严重 | 影响主要功能 | 必须返修 |
| 轻微 | 影响外观或次要功能 | 可返修或让步 |

## 3. 不良登记

### 3.1 不良信息
| 字段 | 说明 |
|------|------|
| unitId | 不良单件 ID |
| stationId | 发现工位 |
| defectCode | 不良代码 |
| defectType | 不良类型（工序分类） |
| severity | 严重程度 |
| location | 不良位置（如元件位号） |
| description | 不良描述 |
| photos | 不良照片 |
| reportedBy | 报告人 |
| reportedAt | 报告时间 |

### 3.2 登记流程
```
发现不良
    ↓
选择不良代码
    ↓
输入不良位置和描述
    ↓
拍照（可选）
    ↓
提交登记
    ↓
系统生成不良记录
    ↓
单件标记为 DEFECTIVE
```

## 4. 不良处置

### 4.1 处置选项
| 处置 | 说明 | 适用场景 |
|------|------|----------|
| 返修 | 修复不良 | 可修复的不良 |
| 报废 | 直接报废 | 无法修复或成本过高 |
| 复测 | 重新测试 | 疑似测试误判 |
| 让步 | 让步接收 | 轻微不良可接受 |

### 4.2 处置流程
```
不良登记完成
    ↓
不良判定（自动或人工）
    ↓
选择处置方式
    ├─ 返修 → 创建返修任务
    ├─ 报废 → 标记报废
    ├─ 复测 → 重新测试
    └─ 让步 → 继续流转
```

### 4.3 处置 API
```
POST /api/defects/:defectId/disposition

Request:
{
  "disposition": "REWORK", // REWORK / SCRAP / RETEST / ACCEPT
  "reason": "处置理由",
  "disposedBy": "QC-001"
}
```

## 5. 返修流程

### 5.1 返修任务
不良处置为"返修"时，系统创建返修任务：

| 字段 | 说明 |
|------|------|
| taskId | 任务 ID |
| defectId | 关联不良 ID |
| unitId | 单件 ID |
| reworkStation | 返修工位 |
| reworkInstructions | 返修指导 |
| status | 任务状态 |

### 5.2 返修工位
不同类型的不良需要不同的返修工位：

| 不良类型 | 返修工位 |
|----------|----------|
| 插件不良 | 插件返修工位 |
| 焊接不良 | 焊接返修工位 |
| 三防漆不良 | 喷涂工位 |
| 测试不良 | 综合返修工位 |

### 5.3 返修执行流程
```
接收返修任务
    ↓
查看不良信息和返修指导
    ↓
执行返修操作
    ↓
返修完成确认
    ↓
复检/复测
    ├─ 合格 → 关闭任务 → 继续流转
    └─ 不合格 → 再次判定
```

### 5.4 返修记录
| 字段 | 说明 |
|------|------|
| taskId | 任务 ID |
| reworkAction | 返修动作描述 |
| reworkBy | 返修人员 |
| reworkStartTime | 开始时间 |
| reworkEndTime | 结束时间 |
| result | 返修结果 |
| verifiedBy | 复检人员 |

## 6. 返修后复检

### 6.1 复检规则
| 不良类型 | 复检方式 |
|----------|----------|
| 插件不良 | 目视检查 |
| 焊接不良 | 目视 + 可选功能测试 |
| 测试不良 | 重新测试 |

### 6.2 复检流程
```
返修完成
    ↓
提交复检
    ↓
执行复检/复测
    ↓
记录结果
    ├─ 合格 → 单件恢复正常状态 → 继续流转
    └─ 不合格 → 再次登记不良 → 再次判定处置
```

## 7. 多次返修处理

### 7.1 返修次数限制
- 一般限制返修次数（如最多 3 次）
- 超过次数需要 MRB 评审
- 避免无限返修循环

### 7.2 超限处理
```
返修次数 ≥ 限制
    ↓
升级到 MRB
    ↓
MRB 决策
    ├─ 特批继续返修
    ├─ 报废
    └─ 让步接收
```

## 8. 报废处理

### 8.1 报废场景
- 无法修复的不良
- 返修成本过高
- 返修次数超限
- MRB 决策报废

### 8.2 报废流程
```
报废决策
    ↓
确认报废
    ↓
单件状态 = SCRAPPED
    ↓
记录报废原因
    ↓
实物处理（隔离/销毁）
```

### 8.3 报废统计
- 按工序统计报废数
- 按不良类型统计
- 计算报废率
- 分析报废原因

## 9. 异常场景处理

### 9.1 批量不良
当短时间内出现多个相同不良：
```
连续 N 件相同不良
    ↓
触发批量异常报警
    ↓
暂停生产
    ↓
排查原因
    ↓
处理问题
    ↓
恢复生产
    ↓
段首件检查
```

### 9.2 设备异常
```
设备报警/故障
    ↓
暂停设备
    ↓
隔离可疑产品
    ↓
设备维修
    ↓
设备验证
    ↓
恢复生产
```

### 9.3 物料异常
```
发现物料问题
    ↓
暂停使用该批次物料
    ↓
回溯使用该物料的产品
    ↓
隔离检查
    ↓
处置（返修/报废）
```

## 10. 返修统计与分析

### 10.1 统计指标
| 指标 | 说明 |
|------|------|
| 不良率 | 不良数/总数 |
| 返修率 | 返修数/总数 |
| 报废率 | 报废数/总数 |
| 一次通过率 | 首次即通过数/总数 |
| 平均返修时间 | 返修任务平均耗时 |

### 10.2 帕累托分析
- 按不良类型排序
- 识别主要不良
- 制定改进措施

## 11. 页面与操作

### 11.1 不良管理页面
路径：`/mes/defects`

功能：
- 不良列表
- 不良登记
- 不良处置
- 不良统计

### 11.2 返修任务页面
路径：`/mes/rework-tasks`（待实现）

功能：
- 返修任务列表
- 接收任务
- 返修记录
- 复检提交

## 12. 相关 API

| 操作 | API | 说明 |
|------|-----|------|
| 登记不良 | `POST /api/defects` | |
| 查询不良 | `GET /api/defects` | 支持筛选 |
| 不良处置 | `POST /api/defects/:defectId/disposition` | |
| 查询返修任务 | `GET /api/rework-tasks` | |
| 完成返修 | `POST /api/rework-tasks/:id/complete` | |
| 复检提交 | `POST /api/rework-tasks/:id/verify` | |
