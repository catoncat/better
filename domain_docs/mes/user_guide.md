# MES 系统用户使用指南

**文档版本**: M1.7  
**最后更新**: 2025-12-27  
**适用版本**: 基础执行闭环 (M1)

---

## 目录

1. [系统概述](#1-系统概述)
2. [角色与权限](#2-角色与权限)
3. [通用操作](#3-通用操作)
4. [工艺工程师工作流程](#4-工艺工程师工作流程)
5. [生产计划员工作流程](#5-生产计划员工作流程)
6. [产线班组长工作流程](#6-产线班组长工作流程)
7. [操作员工作流程](#7-操作员工作流程)
8. [质量工程师工作流程](#8-质量工程师工作流程)
9. [系统管理员工作流程](#9-系统管理员工作流程)
10. [当前系统限制与差距](#10-当前系统限制与差距)

---

## 1. 系统概述

### 1.1 系统定位
本 MES 系统用于管理电子制造企业的生产执行过程，包括：
- 工单接收与发布
- 生产批次创建与授权
- 工位级别的进站/出站操作
- 产品追溯查询

### 1.2 核心页面导航

| 菜单项 | 路径 | 用途 |
|-------|------|------|
| 工单管理 | `/mes/work-orders` | 查看、接收、发布工单 |
| 批次管理 | `/mes/runs` | 查看、创建、授权生产批次 |
| 工位执行 | `/mes/execution` | 操作员进站/出站操作 |
| 路由管理 | `/mes/routes` | 查看路由定义和步骤 |
| 路由版本 | `/mes/route-versions` | 编译和管理路由版本 |
| 追溯查询 | `/mes/trace` | 查询产品生产历史 |
| 集成管理 | `/system/integrations` | 触发 ERP/TPM 数据同步 |
| 用户管理 | `/system/user-management` | 管理系统用户 |

---

## 2. 角色与权限

### 2.1 系统定义的角色

| 角色代码 | 中文名称 | 典型职责 |
|---------|---------|---------|
| `admin` | 系统管理员 | 用户管理、系统配置、集成管理 |
| `planner` | 生产计划员 | 工单接收/发布、批次创建 |
| `engineer` | 工艺工程师 | 路由配置、执行语义设置 |
| `quality` | 质量工程师 | 追溯查询、质量分析（M2 扩展） |
| `leader` | 产线组长 | 批次授权、产线监控、异常处理 |
| `operator` | 操作员 | 工位执行（进站/出站） |

注：当前系统未预置只读角色，如需只读账号请通过自定义角色配置对应权限点。

### 2.2 当前权限实现状态

> ⚠️ **重要限制**: 权限系统正在接入中，MES 模块仍处于逐步接入阶段，部分页面与操作未完全受控。

**建议的权限矩阵**（待实现，基于权限点模型）：

| 功能 | admin | planner | engineer | quality | leader | operator |
|------|-------|---------|----------|---------|--------|----------|
| 查看工单列表 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 接收工单 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 发布工单 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 创建批次 | ❌ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 授权批次 | ❌ | ❌ | ❌ | ❌ | ✅ | ❌ |
| 工位执行 | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| 路由配置 | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| 编译路由 | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| 追溯查询 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 用户管理 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 集成管理 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |

---

## 3. 通用操作

### 3.1 登录系统
1. 访问系统 URL（如 `http://localhost:3000`）
2. 输入邮箱和密码
3. 点击"登录"

### 3.2 导航
- 左侧边栏显示主菜单
- 点击"生产执行"展开 MES 子菜单
- 使用面包屑导航返回上级页面

### 3.3 列表页通用操作
- **搜索**: 在搜索框输入关键词
- **筛选**: 使用状态下拉框筛选
- **排序**: 点击表头可排序
- **分页**: 底部翻页控件

---

## 4. 工艺工程师工作流程

工艺工程师负责路由定义和执行语义配置。

### 4.1 查看路由列表

1. 导航到 **生产执行 → 路由管理**
2. 使用搜索框按路由编码或名称搜索
3. 使用"来源"筛选器区分 ERP 导入和 MES 原生路由

### 4.2 查看路由详情

1. 在路由列表点击路由编码
2. 查看路由基本信息（编码、名称、来源）
3. 查看步骤列表（步骤号、工序、站点类型）

### 4.3 配置执行语义

1. 在路由详情页，找到"执行配置"区域
2. 点击某个步骤的"编辑"按钮
3. 配置以下参数：
   - **站点组**: 限制可执行此步骤的站点组
   - **允许站点**: 精确指定允许的站点
   - **站点类型**: MANUAL（手动）/ AUTO（自动）/ BATCH（批量）/ TEST（测试）
   - **需要 FAI**: 是否要求首件检验（M2 功能）
   - **需要授权**: 是否要求批次授权
   - **数据规格**: 绑定数据采集规格（M2 功能）
4. 点击"保存"

### 4.4 编译路由版本

1. 在路由详情页，点击右上角"编译"按钮
2. 系统验证配置完整性
3. 成功后生成新版本号，状态为 `READY`
4. 如果失败，查看错误信息并修正配置

> ⚠️ **注意**: 编译后，新批次将使用最新 READY 版本。已存在的批次继续使用其冻结的版本。

---

## 5. 生产计划员工作流程

生产计划员负责工单管理和批次创建。

### 5.1 接收工单

**方式一：手动接收**
1. 导航到 **生产执行 → 工单管理**
2. 点击"接收工单"按钮
3. 填写工单信息：
   - **工单号**: 来自 ERP 的工单编号（如 `WO-2025-001`）
   - **产品编码**: 产品料号
   - **计划数量**: 计划生产数量
   - **路由编码**: 搜索并选择适用的路由
   - **到期日期**: 可选
4. 点击"接收工单"

**方式二：ERP 同步**
1. 导航到 **系统管理 → 集成管理**
2. 找到"工单同步"区域
3. 点击"立即同步"
4. 同步完成后，工单自动出现在列表中

### 5.2 发布工单

1. 在工单列表找到状态为"已接收"的工单
2. 点击行末的操作菜单（⋮）
3. 选择"发布"
4. 工单状态变为"已发布"

> 发布前系统会检查路由是否存在可用版本。

### 5.3 创建生产批次

1. 在工单列表找到已发布的工单
2. 点击操作菜单中的"创建批次"
3. 填写批次信息：
   - **产线**: 选择执行此批次的产线
   - **数量**: 本批次计划数量（不超过工单剩余数量）
4. 点击"创建"
5. 系统自动冻结当前 READY 的路由版本

---

## 6. 产线班组长工作流程

班组长负责批次授权和产线监控。

### 6.1 查看批次列表

1. 导航到 **生产执行 → 批次管理**
2. 使用状态筛选器查看特定状态的批次：
   - **准备中 (PREP)**: 等待授权
   - **已授权 (AUTHORIZED)**: 可以开始生产
   - **生产中 (RUNNING)**: 正在生产

### 6.2 授权批次

1. 找到状态为"准备中"的批次
2. 点击操作菜单中的"授权生产"
3. 批次状态变为"已授权"

> ⚠️ **当前限制**: M1 版本的授权是简化流程，没有 FAI 检验和准备检查。真实生产应在 M2 实现完整流程。

### 6.3 撤销授权

1. 找到状态为"已授权"的批次
2. 点击操作菜单中的"撤销授权"
3. 批次状态回退为"准备中"

### 6.4 查看批次详情

1. 点击批次号进入详情页
2. 查看生产进度：
   - **计划数量**: 目标数量
   - **实际生产**: 已生产的单元数
   - **完成率**: 完成百分比
   - **进行中**: 排队和在站的单元数
   - **异常**: 不良/报废/冻结的单元数
3. 查看最近生产的 20 个产品单元
4. 点击单元的"追溯"按钮查看详细历史

---

## 7. 操作员工作流程

操作员负责在工位执行进站和出站操作。

### 7.1 选择工位

1. 导航到 **生产执行 → 工位执行**
2. 在"选择工位"下拉框中选择当前操作的物理工位
3. 选择后，页面显示当前工位的队列和操作表单

### 7.2 查看工位队列

选择工位后，左侧显示当前在站的产品列表：
- **SN**: 产品序列号
- **步骤**: 当前步骤号
- **进站时间**: 何时进入此工位
- **操作**: 点击"出站"快速填充出站表单

队列每 10 秒自动刷新，也可点击刷新按钮手动刷新。

### 7.3 进站操作 (Track In)

1. 切换到"进站 (Track In)"标签页
2. 扫描或输入产品序列号 (SN)
3. 输入工单号和批次号
4. 点击"确认进站"

**进站检查**：
- 工单必须已发布
- 批次必须已授权
- 产品当前步骤必须与此工位匹配
- 工位必须在该步骤的允许站点列表中
- TPM 设备状态必须正常（无维护中）

### 7.4 出站操作 (Track Out)

**方式一：从队列选择**
1. 在左侧队列中点击产品的"出站"按钮
2. 系统自动填充 SN 和批次号
3. 选择结果（合格/不合格）
4. 点击"确认出站"

**方式二：手动输入**
1. 切换到"出站 (Track Out)"标签页
2. 扫描或输入 SN
3. 输入批次号
4. 选择结果
5. 点击"确认出站"

**出站后行为**：
- **PASS**: 产品推进到下一步骤；如果是最后一步，状态变为"完成"
- **FAIL**: 产品状态变为"失败"（M2 将增加处置流程）

---

## 8. 质量工程师工作流程

质量工程师负责追溯查询和质量分析。

### 8.1 追溯查询

1. 导航到 **生产执行 → 追溯查询**
2. 在搜索框输入产品序列号 (SN)
3. 选择查询模式：
   - **批次版本**: 使用生产时冻结的路由版本（审计推荐）
   - **最新版本**: 使用当前最新版本（仅用于分析）
4. 点击"查询"或按 Enter

### 8.2 追溯结果解读

查询结果包含：

**产品信息**
- 序列号、状态、工单号、批次号

**路由信息**
- 路由编码、来源系统、版本号、编译时间

**执行记录**
- 每个步骤的工序、进站时间、出站时间、结果

**采集数据**（如有）
- 步骤、数据项名称、值、判定结果

**缺陷记录**（如有）
- 缺陷代码、位置、数量、状态

**物料追溯**（如有）
- 位置、物料编码、批次号、是否关键件

---

## 9. 系统管理员工作流程

### 9.1 用户管理

1. 导航到 **系统管理 → 用户管理**
2. 查看用户列表，支持按角色筛选
3. 创建新用户：
   - 点击"新建用户"
   - 填写姓名、邮箱、密码
   - 选择角色
   - 点击"创建"
4. 编辑用户：点击用户卡片编辑信息

### 9.2 集成管理

1. 导航到 **系统管理 → 集成管理**
2. 查看各同步任务的状态：
   - 最后同步时间
   - 同步游标位置
   - 上次结果
3. 手动触发同步：
   - ERP 路由同步
   - ERP 工单同步
   - ERP 物料/BOM 同步
   - TPM 设备状态同步

### 9.3 系统设置

1. 导航到 **系统管理 → 系统设置**
2. 配置系统级参数

---

## 10. 当前系统限制与差距

### 10.1 权限控制缺失

| 问题 | 影响 | 建议 |
|------|------|------|
| 所有用户可访问所有 MES 页面 | 操作员可能误操作工单/批次 | 实现页面级权限控制 |
| 按钮级权限未实现 | 任何人可授权批次 | 实现操作级权限检查 |
| 无工位绑定机制 | 操作员可选择任意工位 | 实现用户-工位关联 |

### 10.1.1 后端权限限制（接入中）

- 权限体系以权限点为最小单元，后端将通过 ability guard 对 API 进行校验。
- 目前仅部分模块接入权限检查（已接入 Users 模块），MES 相关 API 正在逐步接入。
- 数据范围过滤（按产线/工位）尚未完整覆盖查询接口。

### 10.1.2 前端权限限制（接入中）

- 前端将使用 useAbility + Can 组件做按钮/操作级控制，导航按权限点过滤。
- 目前 MES 页面与按钮仍存在未受控入口，需配合后端权限完成闭环。

### 10.2 工位执行体验问题

| 问题 | 真实场景需求 | 当前状态 |
|------|-------------|---------|
| 进站需手动输入 WO/Run | 扫描 SN 自动关联 | ❌ 未实现 |
| 无数据采集表单 | 根据步骤动态显示采集项 | ❌ 未实现 |
| 无 FAIL 处置流程 | FAIL 后选择返工/报废/冻结 | ❌ 未实现 |
| 无操作员签到 | 记录谁在操作 | ❌ 未实现 |
| 无工位状态显示 | 显示设备状态、维护预警 | ❌ 未实现 |

### 10.3 缺失的核心功能

| 功能 | 描述 | 里程碑 |
|------|------|--------|
| 生产准备检查 | 设备/物料/人员资质检查 | M2 |
| FAI 首件检验 | 试产 + 检验流程 | M2 |
| 缺陷处置 | 返工/报废/冻结/放行 | M2 |
| 数据采集表单 | 动态渲染采集项，实时验证 | M2 |
| OQC 抽检 | 出货前抽样检验 | M2 |
| 批次关闭确认 | 生产完成确认，触发 ERP 回写 | M2 |

### 10.4 用户体验改进建议

1. **操作员专用界面**
   - 全屏工位执行模式（隐藏导航栏）
   - 大字体、大按钮设计
   - 扫码枪自动聚焦
   - 声音反馈（成功/失败）

2. **班组长看板**
   - 产线实时进度看板
   - 异常单元快速处理
   - 批次 OEE 统计

3. **移动端适配**
   - 工位执行页面移动端优化
   - 追溯查询移动端

### 10.5 数据准备要求

系统正常运行需要以下基础数据：

| 数据类型 | 来源 | 准备方式 |
|---------|------|---------|
| 产线 (Line) | 手动/种子 | 数据库种子脚本 |
| 站点组 (StationGroup) | 手动/种子 | 数据库种子脚本 |
| 站点 (Station) | 手动/种子 | 数据库种子脚本 |
| 路由 (Routing) | ERP 同步/手动 | 集成同步或手动创建 |
| 工序映射 | 手动 | 路由配置时关联 |
| 用户账号 | 管理员创建 | 用户管理页面 |

---

## 附录 A：状态流转图

### 工单状态
```
RECEIVED → RELEASED → COMPLETED
           ↓
        CANCELLED
```

### 批次状态
```
PREP → FAI_PENDING → AUTHORIZED → RUNNING → FINISHING → ARCHIVED
 ↓                      ↑
 └──────────────────────┘ (撤销授权)
```

### 产品单元状态
```
QUEUED → IN_STATION → (PASS) → QUEUED/DONE
                   ↓
               OUT_FAILED → (处置) → REWORK/SCRAPPED/HOLD
```

---

## 附录 B：常见问题

**Q: 进站时提示"Station not allowed for this step"**
A: 当前工位不在该步骤的允许站点列表中。检查路由配置中的站点组和允许站点设置。

**Q: 进站时提示"TPM Equipment Unavailable"**
A: TPM 系统显示该设备状态异常。检查设备状态或联系维护人员。

**Q: 编译路由失败**
A: 检查所有步骤是否都配置了站点组或允许站点。至少需要一个有效步骤。

**Q: 如何查看某个批次的所有产品？**
A: 进入批次详情页，查看"最近生产的产品"列表。如需完整列表，使用追溯查询按批次号搜索。

---

*本文档将随系统迭代持续更新。如有问题，请联系系统管理员。*
