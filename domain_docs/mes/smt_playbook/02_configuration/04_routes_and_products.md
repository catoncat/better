# 路由与产品配置

## 1. 目标
说明“产品编码”和“路由/路由版本”在本系统中如何产生、如何管理，以及它们如何影响 SMT 上料与执行流程。

## 2. 数据如何产生
### 2.1 产品编码（productCode）
- 来源：ERP 物料/工单主数据。
- 进入系统位置：WorkOrder.productCode。
- 用途：
  - 选择适配的路由（Routing）
  - 影响站位映射选择（SlotMaterialMapping）

### 2.2 路由（Routing）与路由版本（ExecutableRouteVersion）
- 来源：ERP 导入或 MES 自建。
- 关键规则（摘要）：
  - ERP 路由的“步骤顺序”只读，不在 MES 修改。
  - MES 维护执行语义（站点类型、门禁、数据采集等）。
  - Run 创建时会绑定“已编译的路由版本快照”。
- 进入系统位置：Run.routeVersionId。

## 3. 数据如何管理
### 3.1 路由选择规则（当前实现）
- 工单必须提前关联 routingId；未关联会导致工单释放失败。
- Run 创建时使用该 routingId 的最新 READY 可执行版本。
- 若无 READY 版本，Run 创建失败。

### 3.2 路由版本冻结
- Run 创建后会绑定一个固定的 ExecutableRouteVersion。
- 后续 ERP 更新路由不会影响已创建 Run。
- 这保证了执行过程与追溯的一致性。

## 4. 对上料配置的影响
加载站位表时，系统使用以下信息筛选站位物料映射：
- `productCode`：来自 WorkOrder
- `routingId`：来自 Run 绑定的 ExecutableRouteVersion

匹配逻辑（简化）：
1) 优先选择同时匹配产品 + 路由的映射
2) 若没有，则选择产品或路由为空的“通用映射”
3) 选 priority 最低的作为主料，其余为替代料

因此：
- 产品/路由配置错误，会导致“站位表加载失败”或加载到错误的物料清单。

## 5. 示例（中文，真实语境）
产品 `MB-A` 在不同路由下有不同物料需求：

- 路由 `SMT-主板A-标准路由`
  - 站位 2F-46 → 物料 5212090001
- 路由 `SMT-主板A-替代路由`
  - 站位 2F-46 → 物料 5212090001B

当创建 Run：
- 若绑定标准路由，加载站位表时会选 5212090001。
- 若绑定替代路由，则会选 5212090001B。

## 6. 演示数据建议
- 演示数据中至少准备：
  - 2 个不同路由的 Run
  - 同一站位在不同路由下映射不同物料
- 验证点：
  - 加载站位表时，物料清单应随路由变化。
  - 既有 Run 不受路由更新影响。

## 7. 参考文档
- `domain_docs/mes/spec/routing/01_routing_engine.md`
