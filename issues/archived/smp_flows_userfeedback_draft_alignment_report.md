> **⚠️ 已过期 / OBSOLETE**
>
> 本报告生成于 M2 早期阶段。报告中列出的"缺失"功能现已在 M2 完成实现：
> - ✅ 锡膏管理：`LineSolderPaste` + `SolderPasteStatusRecord` + 就绪检查集成
> - ✅ 钢网管理：`LineStencil` + `StencilStatusRecord` + 就绪检查集成
> - ✅ 上料防错：`FeederSlot` + `SlotMaterialMapping` + `LoadingRecord` + 验证 API
> - ✅ SPI/AOI 集成：`POST /api/integration/inspection-result` + 手动降级支持
> - ✅ OQC 抽检：`OqcSamplingRule` + 抽样任务 + MRB 决策流程
>
> **As-Built 参考**：`domain_docs/mes/plan/phase2_tasks.md`（状态：已完成）
>
> **清理日期**：2026-01-12（任务 3.1.3）

---

系统架构采用分阶段里程碑(M1→M2→M3)推进。M1 已完成执行核心，M2 正在进行质量模块，但 SMT 特有的物料管理（锡膏、钢网）和防错机制还未纳入规划。
─────────────────────────────────────────────────

---
系统能力 vs SMP 流程需求 - 差距分析

结论先说

不能完美支持。当前系统能覆盖约 60% 的 SMP 流程需求。

---
一、能支持的部分 ✅

| SMP 流程节点     | 系统支持度 | 说明                                |
|------------------|------------|-------------------------------------|
| SMT工单下达      | ✅ 完整    | WorkOrder + ERP 同步已实现          |
| 产线准备 (基础)  | ✅ 完整    | ReadinessCheck 已实现设备/资质检查  |
| 首件确认流程     | ✅ 完整    | Inspection + FAI Gate 已实现        |
| 批量生产授权     | ✅ 完整    | Run.status = AUTHORIZED 已实现      |
| TrackIn/TrackOut | ✅ 完整    | 单件追溯核心已实现                  |
| 不良记录         | ✅ 完整    | Defect + 处置(返修/报废/隔离)已实现 |

---
二、不能支持的部分 ❌

2.1 锡膏管理 🔴 完全缺失

SMP 流程要求：
锡膏管理--扫码追溯
• 锡膏寿命计算与先进先出
• 锡膏回温时间
• 搅拌记录
• 有效期

系统现状：无此模块。MaterialLot 只有基础批次信息，没有：
- 回温计时器
- 搅拌记录
- 开封后寿命追踪
- FIFO 强制卡控

2.2 钢网管理 🔴 完全缺失

SMP 流程要求：                                                                                 钢网准备
• 钢网编号&版本验证
• 钢网外观检查
• 钢网张力检测-SPC

系统现状：无此模块。没有：
- 钢网主数据
- 张力检测记录
- 清洗记录
- 使用次数追踪

2.3 上料防错 🔴 完全缺失

SMP 流程要求：
上料防错
• 调取机器《物料站位表》
• 扫码验证 (物料二维码+站位二维码)
• 系统比对

系统现状：无此模块。没有：
- 站位表 (Station Table) 数据模型
- Feeder 管理
- 站位-物料绑定关系
- 实时比对 API

2.4 SPI/AOI 集成 🟡 部分支持

SMP 流程要求：
SPI检测 → AOI检查 → 数据综合分析

系统现状：
- ✅ DataCollectionSpec 模型存在
- ❌ 无 SPI/AOI 设备对接接口
- ❌ 无锡膏厚度/面积 SPC 分析
- ❌ 无 AOI 不良图片关联

2.5 OQC 抽检 🔴 未开始

系统现状：M2 里程碑任务，标记为"Not Started"

2.6 SMT 特有监控 🔴 缺失

| 监控项       | 系统支持 |
|--------------|----------|
| 贴片机 OEE   | ❌ 无    |
| 抛料率监控   | ❌ 无    |
| 回流焊曲线   | ❌ 无    |
| 炉温实时监控 | ❌ 无    |

---
三、差距汇总表

| 模块           | 缺失程度 | 实现复杂度 | 优先级建议 |
|----------------|----------|------------|------------|
| 锡膏管理       | 🔴 100%  | 中         | P0 - 必须  |
| 钢网管理       | 🔴 100%  | 中         | P0 - 必须  |
| 上料防错       | 🔴 100%  | 高         | P0 - 必须  |
| SPI/AOI 集成   | 🟡 70%   | 高         | P1 - 重要  |
| OQC 抽检       | 🔴 100%  | 中         | P1 - 重要  |
| SMT 监控仪表板 | 🔴 100%  | 中         | P2 - 增强  |

---
四、实现路径建议

如果你希望系统完整支持 SMP 流程，需要新增一个 SMT 物料准备模块：

packages/db/prisma/schema/
├── smt-material.prisma      # 新增
│   ├── SolderPaste          # 锡膏批次
│   ├── SolderPasteUsage     # 使用记录(回温/搅拌/开封)
│   ├── Stencil              # 钢网主数据
│   ├── StencilInspection    # 张力检测记录
│   └── StencilCleaning      # 清洗记录

├── smt-loading.prisma       # 新增
│   ├── StationTable         # 站位表
│   ├── FeederSlot           # 飞达站位
│   └── LoadingVerification  # 上料验证记录

---
五、回答你的问题

修改后的流程图能完美配置到系统里吗？

不能。修改流程图只是让规范对齐，但系统缺少 SMT 特有的三大核心模块：
1. 锡膏/钢网管理
2. 上料防错
3. SPI/AOI 设备集成

系统究竟满不满足这套流程？

部分满足（约 60%）：
- ✅ 工单→批次→单件的基础追溯链
- ✅ 首件检验和批量授权
- ✅ 不良处置(返修/报废/隔离)
- ❌ SMT 特有的物料管理和防错机制

---
下一步

1. 先修改流程图 - 让规范文档与 MES 框架对齐
2. 设计缺失模块的 schema - 为 SMT 物料管理创建数据库设计
3. 评估实现工作量 - 列出每个缺失模块的开发任务
